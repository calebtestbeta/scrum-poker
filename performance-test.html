<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Poker 效能測試</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .test-result {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        #perfChart {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .browser-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .browser-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #ddd;
        }
        .browser-supported { border-color: #28a745; background: #d4edda; }
        .browser-partial { border-color: #ffc107; background: #fff3cd; }
        .browser-unsupported { border-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>🚀 Scrum Poker 效能測試和跨瀏覽器相容性</h1>
    
    <!-- 效能測試區域 -->
    <div class="test-container">
        <h2>📊 效能指標監控</h2>
        <button onclick="runPerformanceTest()">開始效能測試</button>
        <button onclick="runMemoryTest()">記憶體測試</button>
        <button onclick="runAnimationTest()">動畫效能測試</button>
        
        <div class="metrics" id="performanceMetrics">
            <div class="metric">
                <div class="metric-value" id="loadTime">--</div>
                <div class="metric-label">頁面載入時間 (ms)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="domNodes">--</div>
                <div class="metric-label">DOM 節點數量</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="memoryUsage">--</div>
                <div class="metric-label">記憶體使用 (MB)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="fps">--</div>
                <div class="metric-label">動畫 FPS</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="paintTime">--</div>
                <div class="metric-label">重繪時間 (ms)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="layoutTime">--</div>
                <div class="metric-label">重排時間 (ms)</div>
            </div>
        </div>
        
        <canvas id="perfChart"></canvas>
        
        <div id="testResults"></div>
    </div>
    
    <!-- 跨瀏覽器相容性測試 -->
    <div class="test-container">
        <h2>🌐 跨瀏覽器相容性測試</h2>
        <button onclick="runCompatibilityTest()">開始相容性測試</button>
        
        <div class="browser-test" id="browserCompatibility">
            <div class="browser-item" id="chrome">
                <strong>Chrome</strong><br>
                <span id="chromeVersion">--</span><br>
                <span id="chromeStatus">檢測中...</span>
            </div>
            <div class="browser-item" id="firefox">
                <strong>Firefox</strong><br>
                <span id="firefoxVersion">--</span><br>
                <span id="firefoxStatus">檢測中...</span>
            </div>
            <div class="browser-item" id="safari">
                <strong>Safari</strong><br>
                <span id="safariVersion">--</span><br>
                <span id="safariStatus">檢測中...</span>
            </div>
            <div class="browser-item" id="edge">
                <strong>Edge</strong><br>
                <span id="edgeVersion">--</span><br>
                <span id="edgeStatus">檢測中...</span>
            </div>
        </div>
        
        <div id="compatibilityResults"></div>
    </div>
    
    <!-- 移動裝置測試 -->
    <div class="test-container">
        <h2>📱 移動裝置效能測試</h2>
        <button onclick="runMobileTest()">開始移動測試</button>
        
        <div class="metrics" id="mobileMetrics">
            <div class="metric">
                <div class="metric-value" id="touchLatency">--</div>
                <div class="metric-label">觸控延遲 (ms)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="scrollPerf">--</div>
                <div class="metric-label">滾動效能</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="networkSpeed">--</div>
                <div class="metric-label">網路速度</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="batteryImpact">--</div>
                <div class="metric-label">電池影響</div>
            </div>
        </div>
        
        <div id="mobileResults"></div>
    </div>
    
    <!-- CSS 功能測試 -->
    <div class="test-container">
        <h2>🎨 CSS 功能測試</h2>
        <button onclick="runCSSTest()">測試 CSS 功能</button>
        
        <div id="cssTestResults"></div>
    </div>

    <script>
        // 效能測試工具
        class PerformanceTester {
            constructor() {
                this.testResults = [];
                this.chart = null;
            }
            
            // 執行效能測試
            async runPerformanceTest() {
                console.log('🚀 開始效能測試...');
                
                // 測試頁面載入時間
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                document.getElementById('loadTime').textContent = loadTime;
                
                // 測試 DOM 節點數量
                const domNodes = document.querySelectorAll('*').length;
                document.getElementById('domNodes').textContent = domNodes;
                
                // 測試記憶體使用（如果支援）
                if (performance.memory) {
                    const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    document.getElementById('memoryUsage').textContent = memoryMB;
                }
                
                // 測試重繪和重排時間
                await this.measurePaintAndLayout();
                
                this.logResult('效能測試完成', 'pass');
            }
            
            // 測試動畫效能
            async runAnimationTest() {
                console.log('🎬 開始動畫效能測試...');
                
                let frameCount = 0;
                let startTime = performance.now();
                
                const measureFPS = () => {
                    frameCount++;
                    if (frameCount < 120) { // 測試 2 秒
                        requestAnimationFrame(measureFPS);
                    } else {
                        const endTime = performance.now();
                        const fps = Math.round(frameCount / ((endTime - startTime) / 1000));
                        document.getElementById('fps').textContent = fps;
                        
                        if (fps >= 60) {
                            this.logResult(`動畫效能優秀: ${fps} FPS`, 'pass');
                        } else if (fps >= 30) {
                            this.logResult(`動畫效能良好: ${fps} FPS`, 'warning');
                        } else {
                            this.logResult(`動畫效能需要改善: ${fps} FPS`, 'fail');
                        }
                    }
                };
                
                requestAnimationFrame(measureFPS);
            }
            
            // 測試記憶體洩漏
            async runMemoryTest() {
                console.log('🧠 開始記憶體測試...');
                
                if (!performance.memory) {
                    this.logResult('瀏覽器不支援記憶體監控', 'warning');
                    return;
                }
                
                const initialMemory = performance.memory.usedJSHeapSize;
                
                // 模擬大量 DOM 操作
                for (let i = 0; i < 1000; i++) {
                    const div = document.createElement('div');
                    div.textContent = `測試節點 ${i}`;
                    document.body.appendChild(div);
                    document.body.removeChild(div);
                }
                
                // 強制垃圾回收（如果支援）
                if (window.gc) {
                    window.gc();
                }
                
                setTimeout(() => {
                    const finalMemory = performance.memory.usedJSHeapSize;
                    const memoryLeak = finalMemory - initialMemory;
                    
                    if (memoryLeak < 100000) { // 100KB
                        this.logResult('記憶體管理良好', 'pass');
                    } else {
                        this.logResult(`可能有記憶體洩漏: ${Math.round(memoryLeak/1024)}KB`, 'warning');
                    }
                }, 1000);
            }
            
            // 測量重繪和重排
            async measurePaintAndLayout() {
                const observer = new PerformanceObserver((list) => {
                    let paintTime = 0;
                    let layoutTime = 0;
                    
                    for (const entry of list.getEntries()) {
                        if (entry.entryType === 'paint') {
                            paintTime = Math.round(entry.startTime);
                        } else if (entry.entryType === 'layout-shift') {
                            layoutTime = Math.round(entry.value * 1000);
                        }
                    }
                    
                    document.getElementById('paintTime').textContent = paintTime || '--';
                    document.getElementById('layoutTime').textContent = layoutTime || '--';
                });
                
                try {
                    observer.observe({ entryTypes: ['paint', 'layout-shift'] });
                } catch (e) {
                    console.warn('瀏覽器不支援某些效能監控功能');
                }
            }
            
            // 跨瀏覽器相容性測試
            runCompatibilityTest() {
                console.log('🌐 開始跨瀏覽器相容性測試...');
                
                const tests = [
                    { name: 'CSS Grid', test: () => CSS.supports('display', 'grid') },
                    { name: 'CSS Flexbox', test: () => CSS.supports('display', 'flex') },
                    { name: 'CSS Custom Properties', test: () => CSS.supports('--custom-property', 'value') },
                    { name: 'Intersection Observer', test: () => 'IntersectionObserver' in window },
                    { name: 'Web Components', test: () => 'customElements' in window },
                    { name: 'Service Workers', test: () => 'serviceWorker' in navigator },
                    { name: 'LocalStorage', test: () => 'localStorage' in window },
                    { name: 'WebGL', test: () => {
                        const canvas = document.createElement('canvas');
                        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                    }},
                    { name: 'WebSocket', test: () => 'WebSocket' in window },
                    { name: 'Fetch API', test: () => 'fetch' in window }
                ];
                
                const resultsDiv = document.getElementById('compatibilityResults');
                resultsDiv.innerHTML = '';
                
                // 檢測當前瀏覽器
                const userAgent = navigator.userAgent;
                let browserName = 'Unknown';
                let browserVersion = 'Unknown';
                
                if (userAgent.includes('Chrome')) {
                    browserName = 'Chrome';
                    browserVersion = userAgent.match(/Chrome\/([0-9.]+)/)?.[1] || 'Unknown';
                } else if (userAgent.includes('Firefox')) {
                    browserName = 'Firefox';
                    browserVersion = userAgent.match(/Firefox\/([0-9.]+)/)?.[1] || 'Unknown';
                } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                    browserName = 'Safari';
                    browserVersion = userAgent.match(/Version\/([0-9.]+)/)?.[1] || 'Unknown';
                } else if (userAgent.includes('Edge')) {
                    browserName = 'Edge';
                    browserVersion = userAgent.match(/Edge\/([0-9.]+)/)?.[1] || 'Unknown';
                }
                
                // 更新當前瀏覽器資訊
                const currentBrowserId = browserName.toLowerCase();
                const browserElement = document.getElementById(currentBrowserId);
                if (browserElement) {
                    const versionElement = document.getElementById(`${currentBrowserId}Version`);
                    const statusElement = document.getElementById(`${currentBrowserId}Status`);
                    
                    if (versionElement) versionElement.textContent = browserVersion;
                    if (statusElement) statusElement.textContent = '當前瀏覽器';
                    
                    browserElement.className = 'browser-item browser-supported';
                }
                
                // 執行功能測試
                tests.forEach(test => {
                    try {
                        const result = test.test();
                        const className = result ? 'pass' : 'fail';
                        const status = result ? '✅ 支援' : '❌ 不支援';
                        
                        resultsDiv.innerHTML += `
                            <div class="test-result ${className}">
                                <strong>${test.name}:</strong> ${status}
                            </div>
                        `;
                    } catch (error) {
                        resultsDiv.innerHTML += `
                            <div class="test-result fail">
                                <strong>${test.name}:</strong> ❌ 測試失敗 (${error.message})
                            </div>
                        `;
                    }
                });
            }
            
            // 移動裝置效能測試
            runMobileTest() {
                console.log('📱 開始移動裝置測試...');
                
                // 檢測是否為移動裝置
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (!isMobile) {
                    this.logResult('當前非移動裝置，某些測試可能不準確', 'warning', 'mobileResults');
                }
                
                // 測試觸控延遲
                this.testTouchLatency();
                
                // 測試網路速度
                this.testNetworkSpeed();
                
                // 測試滾動效能
                this.testScrollPerformance();
                
                // 檢測設備資訊
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (connection) {
                    document.getElementById('networkSpeed').textContent = connection.effectiveType || 'Unknown';
                }
                
                // 電池 API 測試
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        document.getElementById('batteryImpact').textContent = 
                            battery.charging ? '充電中' : `${Math.round(battery.level * 100)}%`;
                    });
                } else {
                    document.getElementById('batteryImpact').textContent = '不支援';
                }
            }
            
            // 測試觸控延遲
            testTouchLatency() {
                let touchStartTime = 0;
                let touchEndTime = 0;
                
                const testElement = document.createElement('div');
                testElement.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 100px;
                    height: 100px;
                    background: #007bff;
                    transform: translate(-50%, -50%);
                    border-radius: 50%;
                    z-index: 10000;
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    cursor: pointer;
                `;
                testElement.textContent = '點擊測試';
                
                const cleanup = () => {
                    document.body.removeChild(testElement);
                };
                
                testElement.addEventListener('touchstart', (e) => {
                    touchStartTime = performance.now();
                }, { passive: true });
                
                testElement.addEventListener('touchend', (e) => {
                    touchEndTime = performance.now();
                    const latency = Math.round(touchEndTime - touchStartTime);
                    document.getElementById('touchLatency').textContent = latency;
                    
                    if (latency < 100) {
                        this.logResult(`觸控延遲優秀: ${latency}ms`, 'pass', 'mobileResults');
                    } else if (latency < 200) {
                        this.logResult(`觸控延遲良好: ${latency}ms`, 'warning', 'mobileResults');
                    } else {
                        this.logResult(`觸控延遲較高: ${latency}ms`, 'fail', 'mobileResults');
                    }
                    
                    setTimeout(cleanup, 1000);
                }, { passive: true });
                
                testElement.addEventListener('click', (e) => {
                    if (touchStartTime === 0) {
                        // 滑鼠點擊測試
                        const clickTime = performance.now();
                        document.getElementById('touchLatency').textContent = '< 16 (滑鼠)';
                        this.logResult('滑鼠點擊延遲極低', 'pass', 'mobileResults');
                        setTimeout(cleanup, 1000);
                    }
                });
                
                document.body.appendChild(testElement);
                
                // 5 秒後自動清理
                setTimeout(() => {
                    if (document.body.contains(testElement)) {
                        cleanup();
                        document.getElementById('touchLatency').textContent = '未測試';
                    }
                }, 5000);
            }
            
            // 測試網路速度
            async testNetworkSpeed() {
                try {
                    const startTime = performance.now();
                    const response = await fetch(window.location.href + '?cache=' + Date.now());
                    const endTime = performance.now();
                    
                    const loadTime = Math.round(endTime - startTime);
                    
                    if (loadTime < 100) {
                        this.logResult(`網路速度快: ${loadTime}ms`, 'pass', 'mobileResults');
                    } else if (loadTime < 500) {
                        this.logResult(`網路速度中等: ${loadTime}ms`, 'warning', 'mobileResults');
                    } else {
                        this.logResult(`網路速度慢: ${loadTime}ms`, 'fail', 'mobileResults');
                    }
                } catch (error) {
                    this.logResult('網路測試失敗', 'fail', 'mobileResults');
                }
            }
            
            // 測試滾動效能
            testScrollPerformance() {
                let scrollCount = 0;
                let smoothScrolling = true;
                
                const testScroll = () => {
                    scrollCount++;
                    
                    if (scrollCount > 10) {
                        window.removeEventListener('scroll', testScroll);
                        document.getElementById('scrollPerf').textContent = smoothScrolling ? '流暢' : '卡頓';
                        
                        if (smoothScrolling) {
                            this.logResult('滾動效能良好', 'pass', 'mobileResults');
                        } else {
                            this.logResult('滾動效能需要改善', 'warning', 'mobileResults');
                        }
                    }
                };
                
                window.addEventListener('scroll', testScroll, { passive: true });
                
                // 模擬滾動
                window.scrollBy(0, 10);
                setTimeout(() => window.scrollBy(0, -10), 100);
            }
            
            // CSS 功能測試
            runCSSTest() {
                console.log('🎨 開始 CSS 功能測試...');
                
                const cssTests = [
                    { name: 'CSS Grid', property: 'display', value: 'grid' },
                    { name: 'CSS Flexbox', property: 'display', value: 'flex' },
                    { name: 'CSS Transform', property: 'transform', value: 'translateX(10px)' },
                    { name: 'CSS Transition', property: 'transition', value: 'all 0.3s ease' },
                    { name: 'CSS Animation', property: 'animation', value: 'none' },
                    { name: 'CSS Filter', property: 'filter', value: 'blur(1px)' },
                    { name: 'CSS Backdrop Filter', property: 'backdrop-filter', value: 'blur(10px)' },
                    { name: 'CSS Custom Properties', property: '--custom', value: 'test' },
                    { name: 'CSS Clip Path', property: 'clip-path', value: 'circle(50%)' },
                    { name: 'CSS Object Fit', property: 'object-fit', value: 'cover' }
                ];
                
                const resultsDiv = document.getElementById('cssTestResults');
                resultsDiv.innerHTML = '';
                
                cssTests.forEach(test => {
                    const supported = CSS.supports(test.property, test.value);
                    const className = supported ? 'pass' : 'fail';
                    const status = supported ? '✅ 支援' : '❌ 不支援';
                    
                    resultsDiv.innerHTML += `
                        <div class="test-result ${className}">
                            <strong>${test.name}:</strong> ${status}
                        </div>
                    `;
                });
            }
            
            // 記錄測試結果
            logResult(message, type, containerId = 'testResults') {
                const container = document.getElementById(containerId);
                if (container) {
                    const div = document.createElement('div');
                    div.className = `test-result ${type}`;
                    div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                    container.appendChild(div);
                }
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
        
        // 初始化測試器
        const perfTester = new PerformanceTester();
        
        // 全域函數
        function runPerformanceTest() {
            perfTester.runPerformanceTest();
        }
        
        function runMemoryTest() {
            perfTester.runMemoryTest();
        }
        
        function runAnimationTest() {
            perfTester.runAnimationTest();
        }
        
        function runCompatibilityTest() {
            perfTester.runCompatibilityTest();
        }
        
        function runMobileTest() {
            perfTester.runMobileTest();
        }
        
        function runCSSTest() {
            perfTester.runCSSTest();
        }
        
        // 頁面載入完成後自動執行基本測試
        window.addEventListener('load', () => {
            console.log('📊 頁面載入完成，開始自動測試...');
            
            // 延遲執行以確保所有資源載入完成
            setTimeout(() => {
                runPerformanceTest();
                runCompatibilityTest();
                runCSSTest();
            }, 1000);
        });
        
        // 監控長時間效能
        setInterval(() => {
            if (performance.memory) {
                const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memoryUsage').textContent = memoryMB;
            }
        }, 5000);
    </script>
</body>
</html>