{
  "rules": {
    "rooms": {
      "$roomId": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid != null",
        
        "created_at": {
          ".validate": "newData.isNumber() && newData.val() <= now + 300000"
        },
        
        "lastActivity": {
          ".validate": "newData.isNumber() && newData.val() <= now + 300000"
        },
        
        "last_activity": {
          ".validate": "newData.isNumber() && newData.val() <= now + 300000"
        },
        
        "phase": {
          ".validate": "newData.isString() && (newData.val() === 'voting' || newData.val() === 'revealing' || newData.val() === 'finished')"
        },
        
        "task_type": {
          ".validate": "newData.isString()"
        },
        
        "settings": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid != null"
        },
        
        "statistics": {
          ".read": "auth != null", 
          ".write": "auth != null && auth.uid != null"
        },
        
        "history": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid != null"
        },
        
        "players": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid != null",
          ".validate": "newData.numChildren() <= 50",
          
          "$playerId": {
            ".validate": "newData.hasChild('name') && newData.hasChild('role')",
            
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20 && newData.val().matches(/^[a-zA-Z0-9\\u4e00-\\u9fff\\s_-]+$/)"
            },
            
            "role": {
              ".validate": "newData.isString() && (newData.val() === 'dev' || newData.val() === 'qa' || newData.val() === 'scrum_master' || newData.val() === 'po' || newData.val() === 'other')"
            },
            
            "joinedAt": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "joined_at": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "lastHeartbeat": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "lastActivity": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "last_active": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "lastSeen": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "online": {
              ".validate": "newData.isBoolean()"
            },
            
            "hasVoted": {
              ".validate": "newData.isBoolean()"
            },
            
            "vote": {
              ".validate": "newData.val() === null || newData.isNumber() || newData.isString()"
            }
          }
        },
        
        "votes": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid != null",
          ".validate": "newData.numChildren() <= 50",
          
          "$playerId": {
            "value": {
              ".validate": "newData.isNumber() || newData.isString()"
            },
            
            "timestamp": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            },
            
            "playerId": {
              ".validate": "newData.isString()"
            },
            
            "player_role": {
              ".validate": "newData.isString()"
            }
          }
        },
        
        "learning_data": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid != null",
          
          "current_advice": {
            ".read": "auth != null",
            ".write": "auth != null && auth.uid != null",
            
            "visible_to_all": {
              ".validate": "newData.val() === true"
            },
            
            "stored_at": {
              ".validate": "newData.val() === 'timestamp' || (newData.isNumber() && newData.val() <= now + 300000)"
            },
            
            "advice_type": {
              ".validate": "newData.isString()"
            },
            
            "content": {
              ".validate": "newData.isString()"
            },
            
            "confidence": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 1"
            },
            
            "timestamp": {
              ".validate": "newData.isNumber() && newData.val() <= now + 300000"
            }
          },
          
          "session_history": {
            ".read": "auth != null",
            ".write": "auth != null && auth.uid != null",
            
            "$sessionId": {
              "timestamp": {
                ".validate": "newData.isNumber() && newData.val() <= now + 300000"
              },
              
              "task_type": {
                ".validate": "newData.isString()"
              },
              
              "anonymous_votes": {
                "$anonId": {
                  ".validate": "newData.hasChild('role') && newData.hasChild('value')",
                  
                  "role": {
                    ".validate": "newData.isString() && (newData.val() === 'dev' || newData.val() === 'qa' || newData.val() === 'scrum_master' || newData.val() === 'po' || newData.val() === 'other')"
                  },
                  
                  "value": {
                    ".validate": "newData.isNumber() || newData.isString()"
                  }
                }
              },
              
              "statistics": {
                ".validate": "newData.hasChild('average_points') && newData.hasChild('consensus') && newData.hasChild('total_votes')",
                
                "average_points": {
                  ".validate": "newData.isNumber()"
                },
                
                "consensus": {
                  ".validate": "newData.isBoolean()"
                },
                
                "total_votes": {
                  ".validate": "newData.isNumber() && newData.val() >= 0"
                }
              }
            }
          },
          
          "learning_model": {
            ".read": "auth != null",
            ".write": "auth != null && auth.uid != null"
          },
          
          "metadata": {
            ".read": "auth != null",
            ".write": "auth != null && auth.uid != null",
            
            "cleanup_threshold": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },
            
            "last_cleanup": {
              ".validate": "newData.val() === 'timestamp' || (newData.isNumber() && newData.val() <= now + 300000)"
            }
          }
        }
      }
    },
    
    // 防止其他路徑的寫入
    "$other": {
      ".validate": false
    }
  }
  
  // Firebase Rules 說明:
  // 1. 所有讀寫操作需要匿名身份驗證 (auth != null)
  // 2. 寫入操作額外需要有效的用戶ID (auth.uid != null)
  // 3. 時間戳驗證防止時間欺騙 (now + 300000 = 5分鐘容忍度)
  // 4. 房間限制最多50個玩家和投票
  // 5. 玩家姓名限制20字符且僅允許安全字符
  // 6. 學習數據支援匿名化儲存
  // 7. 階段驗證僅允許 voting, revealing, finished
}