<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»ç•«é¢vsæ¸¬è©¦é é¢è¡Œç‚ºå°æ¯” - Scrum Poker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .isolated-test, .main-behavior {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        
        .isolated-test {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        
        .main-behavior {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .test-button {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #1976D2;
        }
        
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .error {
            color: #f44336;
            font-weight: bold;
        }
        
        .log-output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .demo-player {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: white;
            margin: 10px;
            display: inline-block;
            min-width: 100px;
        }
        
        .demo-player.revealed {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        
        .player-card {
            width: 50px;
            height: 60px;
            background: #333;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 5px auto;
        }
        
        .player-card.revealed {
            background: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä¸»ç•«é¢vsæ¸¬è©¦é é¢è¡Œç‚ºå°æ¯”</h1>
    
    <div class="test-container">
        <h2>å•é¡Œåˆ†æ</h2>
        <p><strong>ç¾è±¡</strong>ï¼štest-reveal-persistence.html ä¸­é–‹ç‰Œç‹€æ…‹ä¿æŒæ­£å¸¸ï¼Œä½†ä¸»ç•«é¢ä¸­å¡ç‰Œæœƒç¿»å›èƒŒé¢</p>
        <p><strong>æ¨æ¸¬</strong>ï¼šä¸»ç•«é¢æœ‰é¡å¤–çš„ Firebase åŒæ­¥ã€å®šæ™‚å™¨æˆ–äº‹ä»¶è™•ç†å™¨å°è‡´ç‹€æ…‹è¢«é‡ç½®</p>
    </div>

    <div class="test-container">
        <div class="comparison">
            <div class="isolated-test">
                <h3>ğŸŸ¢ éš”é›¢æ¸¬è©¦ç’°å¢ƒ (æˆåŠŸ)</h3>
                <p>æ¨¡æ“¬ä¸»ç•«é¢é‚è¼¯ä½†ç„¡ Firebase åŒæ­¥</p>
                <button class="test-button" onclick="testIsolated()">é‹è¡Œéš”é›¢æ¸¬è©¦</button>
                <div id="isolatedResult" class="log-output"></div>
                <div id="isolatedDemo"></div>
            </div>
            
            <div class="main-behavior">
                <h3>ğŸ”´ ä¸»ç•«é¢è¡Œç‚ºæ¨¡æ“¬ (å•é¡Œ)</h3>
                <p>å®Œæ•´æ¨¡æ“¬ä¸»ç•«é¢çš„äº‹ä»¶æµç¨‹</p>
                <button class="test-button" onclick="testMainBehavior()">æ¨¡æ“¬ä¸»ç•«é¢è¡Œç‚º</button>
                <div id="mainResult" class="log-output"></div>
                <div id="mainDemo"></div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>å·®ç•°å°æ¯”åˆ†æ</h2>
        <button class="test-button" onclick="compareBehavior()">å°æ¯”è¡Œç‚ºå·®ç•°</button>
        <div id="comparisonResult" class="log-output"></div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="src/core/Utils.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/components/Player.js"></script>
    <script src="src/components/Card.js"></script>
    <script src="src/components/PlayerList.js"></script>
    <script src="src/components/GameTable.js"></script>
    
    <script>
        let isolatedPlayerList = null;
        let mainPlayerList = null;
        let testResults = {
            isolated: [],
            main: []
        };
        
        function log(target, message, type = 'info') {
            const output = document.getElementById(target);
            const timestamp = new Date().toLocaleTimeString();
            
            let className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            const logEntry = document.createElement('div');
            logEntry.className = className;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLog(target) {
            document.getElementById(target).innerHTML = '';
        }
        
        // éš”é›¢æ¸¬è©¦ï¼ˆåƒ…æœ¬åœ°é‚è¼¯ï¼Œç„¡ Firebaseï¼‰
        function testIsolated() {
            clearLog('isolatedResult');
            log('isolatedResult', 'ğŸ§ª é–‹å§‹éš”é›¢æ¸¬è©¦ï¼ˆç„¡ Firebase åŒæ­¥ï¼‰');
            
            try {
                // å‰µå»ºéš”é›¢çš„ PlayerList
                const container = document.createElement('div');
                container.style.display = 'none';
                document.body.appendChild(container);
                
                isolatedPlayerList = new PlayerList(container);
                
                // æ·»åŠ æ¸¬è©¦ç©å®¶
                const player = isolatedPlayerList.addPlayer('test_1', 'Alice', 'dev');
                player.setVote(5, false);
                log('isolatedResult', `âœ… å‰µå»ºç©å®¶: ${player.name}, æŠ•ç¥¨: ${player.vote}`);
                
                // é–‹ç‰Œ
                log('isolatedResult', `é–‹ç‰Œå‰ç‹€æ…‹: isRevealed=${player.isRevealed}`);
                player.revealVote(false);
                log('isolatedResult', `é–‹ç‰Œå¾Œç›´æ¥ç‹€æ…‹: isRevealed=${player.isRevealed}`, 'success');
                
                // æ¨¡æ“¬å¯èƒ½çš„ç‹€æ…‹æ›´æ–°ï¼ˆé¡ä¼¼ Firebase åŒæ­¥ï¼‰
                setTimeout(() => {
                    log('isolatedResult', 'ğŸ”„ æ¨¡æ“¬ç‹€æ…‹æ›´æ–°ï¼ˆç„¡ Firebase äº‹ä»¶ï¼‰');
                    const beforeUpdate = player.isRevealed;
                    
                    // é‡æ–°è¨­ç½®æŠ•ç¥¨ï¼ˆæ¨¡æ“¬ updateVotesï¼‰
                    player.setVote(5, false);
                    
                    const afterUpdate = player.isRevealed;
                    log('isolatedResult', `ç‹€æ…‹æ›´æ–°å‰: ${beforeUpdate}, æ›´æ–°å¾Œ: ${afterUpdate}`);
                    
                    if (afterUpdate) {
                        log('isolatedResult', 'âœ… éš”é›¢æ¸¬è©¦æˆåŠŸ - é–‹ç‰Œç‹€æ…‹ä¿æŒ', 'success');
                        createDemoPlayer('isolatedDemo', 'Alice', 5, true);
                    } else {
                        log('isolatedResult', 'âŒ éš”é›¢æ¸¬è©¦å¤±æ•— - é–‹ç‰Œç‹€æ…‹ä¸Ÿå¤±', 'error');
                        createDemoPlayer('isolatedDemo', 'Alice', 5, false);
                    }
                    
                    testResults.isolated = { success: afterUpdate };
                }, 100);
                
            } catch (error) {
                log('isolatedResult', `âŒ éš”é›¢æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // ä¸»ç•«é¢è¡Œç‚ºæ¸¬è©¦ï¼ˆæ¨¡æ“¬å®Œæ•´çš„äº‹ä»¶æµç¨‹ï¼‰
        function testMainBehavior() {
            clearLog('mainResult');
            log('mainResult', 'ğŸ§ª é–‹å§‹ä¸»ç•«é¢è¡Œç‚ºæ¨¡æ“¬ï¼ˆå«äº‹ä»¶æµç¨‹ï¼‰');
            
            try {
                // å‰µå»ºæ¨¡æ“¬ GameTable ç’°å¢ƒ
                const container = document.createElement('div');
                container.style.display = 'none';
                document.body.appendChild(container);
                
                mainPlayerList = new PlayerList(container);
                
                // æ¨¡æ“¬ GameTable çš„ç‹€æ…‹ç®¡ç†
                const mockGameTable = {
                    currentPhase: 'voting',
                    playerList: mainPlayerList,
                    
                    // æ¨¡æ“¬ updateVotes æ–¹æ³•ï¼ˆå«éšæ®µæª¢æŸ¥ï¼‰
                    updateVotes: function(votes) {
                        log('mainResult', `ğŸ”„ æ¨¡æ“¬ GameTable.updateVotes, éšæ®µ: ${this.currentPhase}`);
                        
                        Object.entries(votes).forEach(([playerId, voteData]) => {
                            const player = this.playerList.getPlayer(playerId);
                            if (player && voteData) {
                                const wasRevealed = player.isRevealed;
                                log('mainResult', `  åŒæ­¥å‰ ${player.name}: isRevealed=${wasRevealed}`);
                                
                                // é€™è£¡æ˜¯é—œéµï¼šèª¿ç”¨ setVote 
                                player.setVote(voteData, false);
                                
                                log('mainResult', `  åŒæ­¥å¾Œ ${player.name}: isRevealed=${player.isRevealed}`);
                                
                                // æª¢æŸ¥æ˜¯å¦éœ€è¦æ¢å¾©ç‹€æ…‹
                                if (wasRevealed && !player.isRevealed) {
                                    log('mainResult', `  âš ï¸ æª¢æ¸¬åˆ°ç‹€æ…‹ä¸Ÿå¤±ï¼Œå˜—è©¦æ¢å¾©...`);
                                    player.isRevealed = true;
                                    player.updateDisplay();
                                    log('mainResult', `  ğŸ”„ å·²æ¢å¾© ${player.name} é–‹ç‰Œç‹€æ…‹`);
                                }
                            }
                        });
                    },
                    
                    // æ¨¡æ“¬éšæ®µè®Šæ›´
                    handlePhaseChange: function(newPhase) {
                        log('mainResult', `ğŸ® éšæ®µè®Šæ›´: ${this.currentPhase} â†’ ${newPhase}`);
                        this.currentPhase = newPhase;
                        
                        if (newPhase === 'revealing') {
                            log('mainResult', 'ğŸ­ è§¸ç™¼ revealVotes()');
                            this.playerList.revealAllVotes();
                        }
                    }
                };
                
                // æ·»åŠ æ¸¬è©¦ç©å®¶
                const player = mainPlayerList.addPlayer('test_1', 'Bob', 'dev');
                player.setVote(8, false);
                log('mainResult', `âœ… å‰µå»ºç©å®¶: ${player.name}, æŠ•ç¥¨: ${player.vote}`);
                
                // æ¨¡æ“¬å®Œæ•´çš„é–‹ç‰Œæµç¨‹
                log('mainResult', `é–‹ç‰Œå‰ç‹€æ…‹: isRevealed=${player.isRevealed}`);
                
                // 1. æœ¬åœ°é–‹ç‰Œ
                player.revealVote(false);
                log('mainResult', `æœ¬åœ°é–‹ç‰Œå¾Œ: isRevealed=${player.isRevealed}`, 'success');
                
                // 2. æ¨¡æ“¬ Firebase éšæ®µè®Šæ›´äº‹ä»¶ï¼ˆå»¶é²è§¸ç™¼ï¼‰
                setTimeout(() => {
                    log('mainResult', 'ğŸ“¡ æ¨¡æ“¬ Firebase éšæ®µè®Šæ›´äº‹ä»¶...');
                    mockGameTable.handlePhaseChange('revealing');
                    
                    // 3. æ¨¡æ“¬å¾ŒçºŒçš„ Firebase æ•¸æ“šåŒæ­¥
                    setTimeout(() => {
                        log('mainResult', 'ğŸ“¡ æ¨¡æ“¬ Firebase æŠ•ç¥¨æ•¸æ“šåŒæ­¥...');
                        mockGameTable.updateVotes({ 'test_1': 8 });
                        
                        // 4. æª¢æŸ¥æœ€çµ‚ç‹€æ…‹
                        setTimeout(() => {
                            const finalRevealed = player.isRevealed;
                            log('mainResult', `æœ€çµ‚ç‹€æ…‹: isRevealed=${finalRevealed}`);
                            
                            if (finalRevealed) {
                                log('mainResult', 'âœ… ä¸»ç•«é¢è¡Œç‚ºæ¸¬è©¦æˆåŠŸ - é–‹ç‰Œç‹€æ…‹ä¿æŒ', 'success');
                                createDemoPlayer('mainDemo', 'Bob', 8, true);
                            } else {
                                log('mainResult', 'âŒ ä¸»ç•«é¢è¡Œç‚ºæ¸¬è©¦å¤±æ•— - é–‹ç‰Œç‹€æ…‹ä¸Ÿå¤±', 'error');
                                createDemoPlayer('mainDemo', 'Bob', 8, false);
                            }
                            
                            testResults.main = { success: finalRevealed };
                        }, 100);
                    }, 200);
                }, 300);
                
            } catch (error) {
                log('mainResult', `âŒ ä¸»ç•«é¢æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        function createDemoPlayer(containerId, name, vote, revealed) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'demo-player' + (revealed ? ' revealed' : '');
            
            const nameDiv = document.createElement('div');
            nameDiv.textContent = name;
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'player-card' + (revealed ? ' revealed' : '');
            cardDiv.textContent = revealed ? vote : '?';
            
            const statusDiv = document.createElement('div');
            statusDiv.textContent = revealed ? 'å·²é–‹ç‰Œ' : 'å·²æŠ•ç¥¨';
            
            playerDiv.appendChild(nameDiv);
            playerDiv.appendChild(cardDiv);
            playerDiv.appendChild(statusDiv);
            
            container.appendChild(playerDiv);
        }
        
        function compareBehavior() {
            clearLog('comparisonResult');
            log('comparisonResult', 'ğŸ” é–‹å§‹è¡Œç‚ºå·®ç•°å°æ¯”åˆ†æ...');
            
            if (!testResults.isolated || !testResults.main) {
                log('comparisonResult', 'âš ï¸ è«‹å…ˆé‹è¡Œå…©å€‹æ¸¬è©¦', 'error');
                return;
            }
            
            log('comparisonResult', 'ğŸ“Š æ¸¬è©¦çµæœå°æ¯”:');
            log('comparisonResult', `  éš”é›¢æ¸¬è©¦: ${testResults.isolated.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            log('comparisonResult', `  ä¸»ç•«é¢æ¨¡æ“¬: ${testResults.main.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            
            if (testResults.isolated.success && testResults.main.success) {
                log('comparisonResult', 'ğŸ‰ ä¿®å¾©æˆåŠŸï¼å…©å€‹ç’°å¢ƒéƒ½ä¿æŒé–‹ç‰Œç‹€æ…‹', 'success');
            } else if (testResults.isolated.success && !testResults.main.success) {
                log('comparisonResult', 'ğŸ” å•é¡Œç¢ºèªï¼šä¸»ç•«é¢ç‰¹æœ‰çš„é‚è¼¯å°è‡´ç‹€æ…‹ä¸Ÿå¤±', 'error');
                log('comparisonResult', 'å¯èƒ½åŸå› ï¼š');
                log('comparisonResult', '  1. Firebase åŒæ­¥äº‹ä»¶æ™‚åºå•é¡Œ');
                log('comparisonResult', '  2. éšæ®µè®Šæ›´é‚è¼¯è¡çª');
                log('comparisonResult', '  3. å¤šæ¬¡ updateVotes èª¿ç”¨');
                log('comparisonResult', '  4. setTimeout æ™‚åºå•é¡Œ');
            } else {
                log('comparisonResult', 'ğŸ” åŸºç¤é‚è¼¯å•é¡Œï¼Œéœ€è¦é€²ä¸€æ­¥èª¿è©¦', 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('isolatedResult', 'ğŸ“‹ éš”é›¢æ¸¬è©¦æº–å‚™å°±ç·’');
            log('mainResult', 'ğŸ“‹ ä¸»ç•«é¢è¡Œç‚ºæ¸¬è©¦æº–å‚™å°±ç·’');
            log('comparisonResult', 'ğŸ“‹ å·®ç•°å°æ¯”åˆ†ææº–å‚™å°±ç·’');
        });
    </script>
</body>
</html>