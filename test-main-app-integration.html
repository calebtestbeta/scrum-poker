<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»æ‡‰ç”¨æ•´åˆæ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ä¸»æ‡‰ç”¨ Firebase å­¸ç¿’ç³»çµ±æ•´åˆæ¸¬è©¦</h1>
        <p>æ­¤æ¸¬è©¦é©—è­‰ä¸»æ‡‰ç”¨ä¸­çš„ Firebase å­¸ç¿’ç³»çµ±æ˜¯å¦æ­£ç¢ºæ•´åˆ</p>
        
        <div class="test-section">
            <h3>ğŸ“¦ ä¾è³´æª¢æŸ¥</h3>
            <button class="test-button" onclick="testDependencies()">æª¢æŸ¥å¿…è¦è…³æœ¬</button>
            <div id="dependencyResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”¥ Firebase æœå‹™æª¢æŸ¥</h3>
            <button class="test-button" onclick="testFirebaseService()">æª¢æŸ¥ FirebaseService</button>
            <div id="firebaseResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§  ScrumAdviceEngine æª¢æŸ¥</h3>
            <button class="test-button" onclick="testScrumAdviceEngine()">æª¢æŸ¥ ScrumAdviceEngine</button>
            <div id="adviceResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”— æ•´åˆæµç¨‹æ¨¡æ“¬</h3>
            <button class="test-button" onclick="simulateIntegrationFlow()">æ¨¡æ“¬å­¸ç¿’æ•¸æ“šæµç¨‹</button>
            <div id="integrationResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ å»ºè­°</h3>
            <div id="recommendations" class="result">
é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ï¼ˆæ¨¡æ“¬ä¸»æ‡‰ç”¨ç’°å¢ƒï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="src/core/Utils.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/services/FirebaseService.js"></script>
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>

    <script>
        // æ¸¬è©¦çµæœæ”¶é›†
        const testResults = {
            dependencies: null,
            firebase: null,
            advice: null,
            integration: null
        };

        // ä¾è³´æª¢æŸ¥
        function testDependencies() {
            const result = document.getElementById('dependencyResult');
            const checks = [];
            
            try {
                // æª¢æŸ¥ Firebase SDK
                checks.push({
                    name: 'Firebase SDK',
                    status: typeof firebase !== 'undefined',
                    details: typeof firebase !== 'undefined' ? 'Firebase SDK å·²è¼‰å…¥' : 'Firebase SDK æœªè¼‰å…¥'
                });
                
                // æª¢æŸ¥å·¥å…·é¡
                checks.push({
                    name: 'Utils',
                    status: typeof Utils !== 'undefined',
                    details: typeof Utils !== 'undefined' ? 'Utils å·¥å…·é¡å·²è¼‰å…¥' : 'Utils å·¥å…·é¡æœªè¼‰å…¥'
                });
                
                // æª¢æŸ¥æœå‹™é¡
                checks.push({
                    name: 'FirebaseService',
                    status: typeof FirebaseService !== 'undefined',
                    details: typeof FirebaseService !== 'undefined' ? 'FirebaseService é¡å·²è¼‰å…¥' : 'FirebaseService é¡æœªè¼‰å…¥'
                });
                
                checks.push({
                    name: 'ScrumAdviceEngine',
                    status: typeof ScrumAdviceEngine !== 'undefined',
                    details: typeof ScrumAdviceEngine !== 'undefined' ? 'ScrumAdviceEngine é¡å·²è¼‰å…¥' : 'ScrumAdviceEngine é¡æœªè¼‰å…¥'
                });
                
                checks.push({
                    name: 'ScrumAdviceUI',
                    status: typeof ScrumAdviceUI !== 'undefined',
                    details: typeof ScrumAdviceUI !== 'undefined' ? 'ScrumAdviceUI é¡å·²è¼‰å…¥' : 'ScrumAdviceUI é¡æœªè¼‰å…¥'
                });
                
                // ç”Ÿæˆçµæœ
                let output = 'ğŸ“¦ ä¾è³´æª¢æŸ¥çµæœ:\n';
                let allPassed = true;
                
                checks.forEach(check => {
                    const status = check.status ? 'âœ…' : 'âŒ';
                    output += `${status} ${check.name}: ${check.details}\n`;
                    if (!check.status) allPassed = false;
                });
                
                output += `\nç¸½çµ: ${allPassed ? 'âœ… æ‰€æœ‰ä¾è³´æ­£å¸¸' : 'âŒ å­˜åœ¨ç¼ºå¤±ä¾è³´'}`;
                
                result.textContent = output;
                result.className = `result ${allPassed ? 'success' : 'error'}`;
                testResults.dependencies = allPassed;
                
            } catch (error) {
                result.textContent = `âŒ ä¾è³´æª¢æŸ¥å¤±æ•—: ${error.message}`;
                result.className = 'result error';
                testResults.dependencies = false;
            }
        }

        // Firebase æœå‹™æª¢æŸ¥
        function testFirebaseService() {
            const result = document.getElementById('firebaseResult');
            
            try {
                if (!FirebaseService) {
                    throw new Error('FirebaseService é¡ä¸å­˜åœ¨');
                }
                
                // å‰µå»ºå¯¦ä¾‹æ¸¬è©¦
                const service = new FirebaseService();
                let output = 'ğŸ”¥ FirebaseService æª¢æŸ¥çµæœ:\n';
                
                // æª¢æŸ¥é—œéµæ–¹æ³•
                const methods = [
                    'initialize',
                    'joinRoom',
                    'submitVote',
                    'revealVotes',
                    'clearVotes',
                    'saveLearningSession',
                    'saveLearningAdvice',
                    'listenToLearningAdvice',
                    'anonymizeVotes',
                    'anonymizeLearningData'
                ];
                
                let methodsOk = true;
                methods.forEach(method => {
                    const exists = typeof service[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    output += `${status} ${method}: ${exists ? 'æ–¹æ³•å­˜åœ¨' : 'æ–¹æ³•ç¼ºå¤±'}\n`;
                    if (!exists) methodsOk = false;
                });
                
                // æª¢æŸ¥é…ç½®æ–¹æ³•
                const configExists = typeof window.getFirebaseConfig === 'function';
                output += `${configExists ? 'âœ…' : 'âŒ'} getFirebaseConfig: ${configExists ? 'é…ç½®å‡½æ•¸å­˜åœ¨' : 'é…ç½®å‡½æ•¸ç¼ºå¤±'}\n`;
                
                const overallStatus = methodsOk && configExists;
                output += `\nç¸½çµ: ${overallStatus ? 'âœ… FirebaseService å®Œæ•´' : 'âŒ FirebaseService å­˜åœ¨å•é¡Œ'}`;
                
                result.textContent = output;
                result.className = `result ${overallStatus ? 'success' : 'error'}`;
                testResults.firebase = overallStatus;
                
            } catch (error) {
                result.textContent = `âŒ FirebaseService æª¢æŸ¥å¤±æ•—: ${error.message}`;
                result.className = 'result error';
                testResults.firebase = false;
            }
        }

        // ScrumAdviceEngine æª¢æŸ¥
        function testScrumAdviceEngine() {
            const result = document.getElementById('adviceResult');
            
            try {
                if (!ScrumAdviceEngine) {
                    throw new Error('ScrumAdviceEngine é¡ä¸å­˜åœ¨');
                }
                
                if (!ScrumAdviceUI) {
                    throw new Error('ScrumAdviceUI é¡ä¸å­˜åœ¨');
                }
                
                // å‰µå»ºå¯¦ä¾‹æ¸¬è©¦
                const engine = new ScrumAdviceEngine();
                const ui = new ScrumAdviceUI();
                
                let output = 'ğŸ§  ScrumAdviceEngine æª¢æŸ¥çµæœ:\n';
                
                // æª¢æŸ¥å¼•æ“æ–¹æ³•
                const engineMethods = [
                    'calculateVotingStatistics',
                    'generateAdvice',
                    'updateLearningModel',
                    'getEngineInfo'
                ];
                
                let engineOk = true;
                engineMethods.forEach(method => {
                    const exists = typeof engine[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    output += `${status} Engine.${method}: ${exists ? 'æ–¹æ³•å­˜åœ¨' : 'æ–¹æ³•ç¼ºå¤±'}\n`;
                    if (!exists) engineOk = false;
                });
                
                // æª¢æŸ¥ UI æ–¹æ³•
                const uiMethods = [
                    'initialize',
                    'generateAdviceFromVotes',
                    'showFullAdvice',
                    'updateAdvicePreview'
                ];
                
                let uiOk = true;
                uiMethods.forEach(method => {
                    const exists = typeof ui[method] === 'function';
                    const status = exists ? 'âœ…' : 'âŒ';
                    output += `${status} UI.${method}: ${exists ? 'æ–¹æ³•å­˜åœ¨' : 'æ–¹æ³•ç¼ºå¤±'}\n`;
                    if (!exists) uiOk = false;
                });
                
                const overallStatus = engineOk && uiOk;
                output += `\nç¸½çµ: ${overallStatus ? 'âœ… ScrumAdviceEngine å®Œæ•´' : 'âŒ ScrumAdviceEngine å­˜åœ¨å•é¡Œ'}`;
                
                result.textContent = output;
                result.className = `result ${overallStatus ? 'success' : 'error'}`;
                testResults.advice = overallStatus;
                
            } catch (error) {
                result.textContent = `âŒ ScrumAdviceEngine æª¢æŸ¥å¤±æ•—: ${error.message}`;
                result.className = 'result error';
                testResults.advice = false;
            }
        }

        // æ•´åˆæµç¨‹æ¨¡æ“¬
        async function simulateIntegrationFlow() {
            const result = document.getElementById('integrationResult');
            let output = 'ğŸ”— æ•´åˆæµç¨‹æ¨¡æ“¬:\n';
            
            try {
                // æ­¥é©Ÿ 1: æ¨¡æ“¬ ScrumPokerApp åˆå§‹åŒ–
                output += 'ğŸ“± æ¨¡æ“¬ä¸»æ‡‰ç”¨åˆå§‹åŒ–...\n';
                
                const mockApp = {
                    firebaseService: null,
                    adviceUI: null,
                    roomId: 'test_room_integration',
                    currentPlayer: { id: 'test_player_123', name: 'æ¸¬è©¦ç©å®¶' }
                };
                
                // æ­¥é©Ÿ 2: Firebase æœå‹™åˆå§‹åŒ–
                output += 'ğŸ”¥ åˆå§‹åŒ– Firebase æœå‹™...\n';
                mockApp.firebaseService = new FirebaseService();
                
                // æ¨¡æ“¬é…ç½®ï¼ˆä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ï¼‰
                const config = window.getFirebaseConfig();
                output += `ğŸ“‹ Firebase é…ç½®: ${config ? 'âœ… å·²å–å¾—' : 'âŒ å–å¾—å¤±æ•—'}\n`;
                
                // åˆå§‹åŒ– Firebase æœå‹™ï¼ˆé€™æœƒå‰µå»ºæ¨¡æ“¬æ•¸æ“šåº«ï¼‰
                if (config) {
                    const { app, database } = await window.initializeFirebaseApp(config);
                    if (database) {
                        // ç›´æ¥è¨­ç½®æ¨¡æ“¬æ•¸æ“šåº«åˆ°æœå‹™ä¸­
                        mockApp.firebaseService.db = database;
                        output += 'âœ… Firebase æœå‹™å·²åˆå§‹åŒ–ï¼ˆæ¨¡æ“¬æ¨¡å¼ï¼‰\n';
                    } else {
                        output += 'âŒ Firebase æ•¸æ“šåº«åˆå§‹åŒ–å¤±æ•—\n';
                    }
                } else {
                    output += 'âŒ ç„¡æ³•å–å¾— Firebase é…ç½®\n';
                }
                
                // æ­¥é©Ÿ 3: ScrumAdviceUI åˆå§‹åŒ–
                output += 'ğŸ§  åˆå§‹åŒ– ScrumAdviceUI...\n';
                mockApp.adviceUI = new ScrumAdviceUI();
                await mockApp.adviceUI.initialize();
                output += 'âœ… ScrumAdviceUI åˆå§‹åŒ–å®Œæˆ\n';
                
                // æ­¥é©Ÿ 4: æ¨¡æ“¬æŠ•ç¥¨æ•¸æ“š
                output += 'ğŸ—³ï¸ æ¨¡æ“¬æŠ•ç¥¨æ•¸æ“šç”Ÿæˆ...\n';
                const mockVotes = {
                    'test_player_1': { value: 5, timestamp: Date.now(), player_role: 'dev' },
                    'test_player_2': { value: 8, timestamp: Date.now(), player_role: 'qa' },
                    'test_player_3': { value: 5, timestamp: Date.now(), player_role: 'po' }
                };
                
                const mockStatistics = {
                    averagePoints: 6,
                    consensus: 60,
                    totalVotes: 3
                };
                
                // æ­¥é©Ÿ 5: æ¨¡æ“¬æ™ºæ…§å»ºè­°ç”Ÿæˆï¼ˆä¸»æ‡‰ç”¨é‚è¼¯ï¼‰
                output += 'ğŸ¯ æ¨¡æ“¬æ™ºæ…§å»ºè­°ç”Ÿæˆ...\n';
                
                const votesData = { votes: mockVotes };
                const adviceContext = {
                    taskType: 'frontend',
                    players: [
                        { id: 'test_player_1', name: 'ç©å®¶1', role: 'dev' },
                        { id: 'test_player_2', name: 'ç©å®¶2', role: 'qa' },
                        { id: 'test_player_3', name: 'ç©å®¶3', role: 'po' }
                    ],
                    sessionInfo: {
                        roomId: mockApp.roomId,
                        timestamp: Date.now(),
                        gamePhase: 'finished'
                    }
                };
                
                // åŸ·è¡Œå»ºè­°ç”Ÿæˆ
                await mockApp.adviceUI.generateAdviceFromVotes(votesData, adviceContext);
                output += 'âœ… å»ºè­°ç”Ÿæˆå®Œæˆ\n';
                
                // æ­¥é©Ÿ 6: æ¨¡æ“¬ Firebase å­¸ç¿’æ•¸æ“šä¿å­˜
                output += 'ğŸ’¾ æ¨¡æ“¬ Firebase å­¸ç¿’æ•¸æ“šä¿å­˜...\n';
                
                // ä¿å­˜å­¸ç¿’æœƒè©±
                const sessionData = {
                    taskType: 'frontend',
                    votes: mockVotes,
                    statistics: mockStatistics,
                    sessionInfo: adviceContext.sessionInfo
                };
                
                try {
                    const sessionSaved = await mockApp.firebaseService.saveLearningSession(mockApp.roomId, sessionData);
                    output += `ğŸ“š å­¸ç¿’æœƒè©±ä¿å­˜: ${sessionSaved ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
                } catch (error) {
                    output += `ğŸ“š å­¸ç¿’æœƒè©±ä¿å­˜: âŒ å¤±æ•— (${error.message})\n`;
                }
                
                // ä¿å­˜å­¸ç¿’å»ºè­°
                if (mockApp.adviceUI.currentAdvice) {
                    try {
                        const adviceSaved = await mockApp.firebaseService.saveLearningAdvice(mockApp.roomId, mockApp.adviceUI.currentAdvice);
                        output += `ğŸ’¡ å­¸ç¿’å»ºè­°ä¿å­˜: ${adviceSaved ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
                    } catch (error) {
                        output += `ğŸ’¡ å­¸ç¿’å»ºè­°ä¿å­˜: âŒ å¤±æ•— (${error.message})\n`;
                    }
                } else {
                    output += `ğŸ’¡ å­¸ç¿’å»ºè­°ä¿å­˜: âš ï¸ è·³éï¼ˆç„¡å»ºè­°å…§å®¹ï¼‰\n`;
                }
                
                // æ­¥é©Ÿ 7: æª¢æŸ¥åŒ¿ååŒ–
                output += 'ğŸ”’ æª¢æŸ¥åŒ¿ååŒ–è™•ç†...\n';
                const anonymizedVotes = mockApp.firebaseService.anonymizeVotes(mockVotes);
                const hasPersonalInfo = JSON.stringify(anonymizedVotes).includes('test_player');
                output += `ğŸ”’ æŠ•ç¥¨åŒ¿ååŒ–: ${!hasPersonalInfo ? 'âœ… æˆåŠŸ' : 'âŒ ä»æœ‰å€‹äººè³‡è¨Š'}\n`;
                
                if (mockApp.adviceUI.currentAdvice) {
                    const anonymizedAdvice = mockApp.firebaseService.anonymizeLearningData(mockApp.adviceUI.currentAdvice);
                    output += `ğŸ”’ å»ºè­°åŒ¿ååŒ–: âœ… å·²è™•ç†\n`;
                }
                
                // ç¸½çµ
                output += '\nğŸ‰ æ•´åˆæµç¨‹æ¨¡æ“¬å®Œæˆ!\n';
                output += 'âœ… ä¸»æ‡‰ç”¨å·²å®Œæ•´æ•´åˆ Firebase å­¸ç¿’ç³»çµ±\n';
                output += 'âœ… å–®ä¸€è§¸ç™¼æ©Ÿåˆ¶å·²å¯¦ç¾\n';
                output += 'âœ… åŒ¿ååŒ–è™•ç†æ­£å¸¸é‹ä½œ\n';
                output += 'âœ… å­¸ç¿’æ•¸æ“šå¯æ­£å¸¸ä¿å­˜å’ŒåŒæ­¥\n';
                
                result.textContent = output;
                result.className = 'result success';
                testResults.integration = true;
                
            } catch (error) {
                output += `\nâŒ æ•´åˆæµç¨‹æ¨¡æ“¬å¤±æ•—: ${error.message}\n`;
                output += `âŒ å †ç–Šè¿½è¹¤: ${error.stack}\n`;
                
                result.textContent = output;
                result.className = 'result error';
                testResults.integration = false;
            }
            
            // æ›´æ–°å»ºè­°
            updateRecommendations();
        }

        // æ›´æ–°å»ºè­°
        function updateRecommendations() {
            const recommendations = document.getElementById('recommendations');
            let output = 'ğŸ“‹ æ•´åˆç‹€æ…‹å»ºè­°:\n\n';
            
            const { dependencies, firebase, advice, integration } = testResults;
            
            if (dependencies === true && firebase === true && advice === true && integration === true) {
                output += 'ğŸ‰ æ­å–œï¼ä¸»æ‡‰ç”¨çš„ Firebase å­¸ç¿’ç³»çµ±æ•´åˆå®Œç¾ï¼\n\n';
                output += 'âœ… æ‰€æœ‰çµ„ä»¶æ­£å¸¸è¼‰å…¥\n';
                output += 'âœ… Firebase æœå‹™åŠŸèƒ½å®Œæ•´\n';
                output += 'âœ… ScrumAdviceEngine é‹ä½œæ­£å¸¸\n';
                output += 'âœ… æ•´åˆæµç¨‹æ¸¬è©¦é€šé\n\n';
                output += 'ğŸš€ å»ºè­°ä¸‹ä¸€æ­¥:\n';
                output += 'â€¢ åœ¨çœŸå¯¦ Firebase ç’°å¢ƒä¸­æ¸¬è©¦\n';
                output += 'â€¢ é€²è¡Œå¤šäººå”ä½œæ¸¬è©¦\n';
                output += 'â€¢ æª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒè¨­å®š\n';
                recommendations.className = 'result success';
            } else {
                output += 'âš ï¸ ç™¼ç¾ä¸€äº›éœ€è¦æ³¨æ„çš„å•é¡Œ:\n\n';
                
                if (dependencies === false) {
                    output += 'âŒ ä¾è³´å•é¡Œ: è«‹ç¢ºä¿æ‰€æœ‰å¿…è¦è…³æœ¬æ­£ç¢ºè¼‰å…¥\n';
                }
                if (firebase === false) {
                    output += 'âŒ Firebase å•é¡Œ: è«‹æª¢æŸ¥ FirebaseService å¯¦ç¾\n';
                }
                if (advice === false) {
                    output += 'âŒ å»ºè­°å¼•æ“å•é¡Œ: è«‹æª¢æŸ¥ ScrumAdviceEngine å¯¦ç¾\n';
                }
                if (integration === false) {
                    output += 'âŒ æ•´åˆå•é¡Œ: è«‹æª¢æŸ¥ä¸»æ‡‰ç”¨ä¸­çš„æ•´åˆé‚è¼¯\n';
                }
                
                output += '\nğŸ”§ å»ºè­°ä¿®å¾©å¾Œé‡æ–°æ¸¬è©¦\n';
                recommendations.className = 'result warning';
            }
            
            recommendations.textContent = output;
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œæç¤º
        window.addEventListener('load', () => {
            console.log('ğŸ§ª ä¸»æ‡‰ç”¨æ•´åˆæ¸¬è©¦é é¢å·²è¼‰å…¥');
            document.getElementById('recommendations').textContent = 'âœ¨ é é¢å·²æº–å‚™å°±ç·’ï¼Œè«‹é–‹å§‹æ¸¬è©¦å„å€‹çµ„ä»¶ï¼';
        });
    </script>
</body>
</html>