<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主應用整合測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 主應用 Firebase 學習系統整合測試</h1>
        <p>此測試驗證主應用中的 Firebase 學習系統是否正確整合</p>
        
        <div class="test-section">
            <h3>📦 依賴檢查</h3>
            <button class="test-button" onclick="testDependencies()">檢查必要腳本</button>
            <div id="dependencyResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>🔥 Firebase 服務檢查</h3>
            <button class="test-button" onclick="testFirebaseService()">檢查 FirebaseService</button>
            <div id="firebaseResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>🧠 ScrumAdviceEngine 檢查</h3>
            <button class="test-button" onclick="testScrumAdviceEngine()">檢查 ScrumAdviceEngine</button>
            <div id="adviceResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>🔗 整合流程模擬</h3>
            <button class="test-button" onclick="simulateIntegrationFlow()">模擬學習數據流程</button>
            <div id="integrationResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>📋 建議</h3>
            <div id="recommendations" class="result">
點擊上方按鈕開始測試...
            </div>
        </div>
    </div>

    <!-- 載入必要的腳本（模擬主應用環境） -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="src/core/Utils.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/services/FirebaseService.js"></script>
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>

    <script>
        // 測試結果收集
        const testResults = {
            dependencies: null,
            firebase: null,
            advice: null,
            integration: null
        };

        // 依賴檢查
        function testDependencies() {
            const result = document.getElementById('dependencyResult');
            const checks = [];
            
            try {
                // 檢查 Firebase SDK
                checks.push({
                    name: 'Firebase SDK',
                    status: typeof firebase !== 'undefined',
                    details: typeof firebase !== 'undefined' ? 'Firebase SDK 已載入' : 'Firebase SDK 未載入'
                });
                
                // 檢查工具類
                checks.push({
                    name: 'Utils',
                    status: typeof Utils !== 'undefined',
                    details: typeof Utils !== 'undefined' ? 'Utils 工具類已載入' : 'Utils 工具類未載入'
                });
                
                // 檢查服務類
                checks.push({
                    name: 'FirebaseService',
                    status: typeof FirebaseService !== 'undefined',
                    details: typeof FirebaseService !== 'undefined' ? 'FirebaseService 類已載入' : 'FirebaseService 類未載入'
                });
                
                checks.push({
                    name: 'ScrumAdviceEngine',
                    status: typeof ScrumAdviceEngine !== 'undefined',
                    details: typeof ScrumAdviceEngine !== 'undefined' ? 'ScrumAdviceEngine 類已載入' : 'ScrumAdviceEngine 類未載入'
                });
                
                checks.push({
                    name: 'ScrumAdviceUI',
                    status: typeof ScrumAdviceUI !== 'undefined',
                    details: typeof ScrumAdviceUI !== 'undefined' ? 'ScrumAdviceUI 類已載入' : 'ScrumAdviceUI 類未載入'
                });
                
                // 生成結果
                let output = '📦 依賴檢查結果:\n';
                let allPassed = true;
                
                checks.forEach(check => {
                    const status = check.status ? '✅' : '❌';
                    output += `${status} ${check.name}: ${check.details}\n`;
                    if (!check.status) allPassed = false;
                });
                
                output += `\n總結: ${allPassed ? '✅ 所有依賴正常' : '❌ 存在缺失依賴'}`;
                
                result.textContent = output;
                result.className = `result ${allPassed ? 'success' : 'error'}`;
                testResults.dependencies = allPassed;
                
            } catch (error) {
                result.textContent = `❌ 依賴檢查失敗: ${error.message}`;
                result.className = 'result error';
                testResults.dependencies = false;
            }
        }

        // Firebase 服務檢查
        function testFirebaseService() {
            const result = document.getElementById('firebaseResult');
            
            try {
                if (!FirebaseService) {
                    throw new Error('FirebaseService 類不存在');
                }
                
                // 創建實例測試
                const service = new FirebaseService();
                let output = '🔥 FirebaseService 檢查結果:\n';
                
                // 檢查關鍵方法
                const methods = [
                    'initialize',
                    'joinRoom',
                    'submitVote',
                    'revealVotes',
                    'clearVotes',
                    'saveLearningSession',
                    'saveLearningAdvice',
                    'listenToLearningAdvice',
                    'anonymizeVotes',
                    'anonymizeLearningData'
                ];
                
                let methodsOk = true;
                methods.forEach(method => {
                    const exists = typeof service[method] === 'function';
                    const status = exists ? '✅' : '❌';
                    output += `${status} ${method}: ${exists ? '方法存在' : '方法缺失'}\n`;
                    if (!exists) methodsOk = false;
                });
                
                // 檢查配置方法
                const configExists = typeof window.getFirebaseConfig === 'function';
                output += `${configExists ? '✅' : '❌'} getFirebaseConfig: ${configExists ? '配置函數存在' : '配置函數缺失'}\n`;
                
                const overallStatus = methodsOk && configExists;
                output += `\n總結: ${overallStatus ? '✅ FirebaseService 完整' : '❌ FirebaseService 存在問題'}`;
                
                result.textContent = output;
                result.className = `result ${overallStatus ? 'success' : 'error'}`;
                testResults.firebase = overallStatus;
                
            } catch (error) {
                result.textContent = `❌ FirebaseService 檢查失敗: ${error.message}`;
                result.className = 'result error';
                testResults.firebase = false;
            }
        }

        // ScrumAdviceEngine 檢查
        function testScrumAdviceEngine() {
            const result = document.getElementById('adviceResult');
            
            try {
                if (!ScrumAdviceEngine) {
                    throw new Error('ScrumAdviceEngine 類不存在');
                }
                
                if (!ScrumAdviceUI) {
                    throw new Error('ScrumAdviceUI 類不存在');
                }
                
                // 創建實例測試
                const engine = new ScrumAdviceEngine();
                const ui = new ScrumAdviceUI();
                
                let output = '🧠 ScrumAdviceEngine 檢查結果:\n';
                
                // 檢查引擎方法
                const engineMethods = [
                    'calculateVotingStatistics',
                    'generateAdvice',
                    'updateLearningModel',
                    'getEngineInfo'
                ];
                
                let engineOk = true;
                engineMethods.forEach(method => {
                    const exists = typeof engine[method] === 'function';
                    const status = exists ? '✅' : '❌';
                    output += `${status} Engine.${method}: ${exists ? '方法存在' : '方法缺失'}\n`;
                    if (!exists) engineOk = false;
                });
                
                // 檢查 UI 方法
                const uiMethods = [
                    'initialize',
                    'generateAdviceFromVotes',
                    'showFullAdvice',
                    'updateAdvicePreview'
                ];
                
                let uiOk = true;
                uiMethods.forEach(method => {
                    const exists = typeof ui[method] === 'function';
                    const status = exists ? '✅' : '❌';
                    output += `${status} UI.${method}: ${exists ? '方法存在' : '方法缺失'}\n`;
                    if (!exists) uiOk = false;
                });
                
                const overallStatus = engineOk && uiOk;
                output += `\n總結: ${overallStatus ? '✅ ScrumAdviceEngine 完整' : '❌ ScrumAdviceEngine 存在問題'}`;
                
                result.textContent = output;
                result.className = `result ${overallStatus ? 'success' : 'error'}`;
                testResults.advice = overallStatus;
                
            } catch (error) {
                result.textContent = `❌ ScrumAdviceEngine 檢查失敗: ${error.message}`;
                result.className = 'result error';
                testResults.advice = false;
            }
        }

        // 整合流程模擬
        async function simulateIntegrationFlow() {
            const result = document.getElementById('integrationResult');
            let output = '🔗 整合流程模擬:\n';
            
            try {
                // 步驟 1: 模擬 ScrumPokerApp 初始化
                output += '📱 模擬主應用初始化...\n';
                
                const mockApp = {
                    firebaseService: null,
                    adviceUI: null,
                    roomId: 'test_room_integration',
                    currentPlayer: { id: 'test_player_123', name: '測試玩家' }
                };
                
                // 步驟 2: Firebase 服務初始化
                output += '🔥 初始化 Firebase 服務...\n';
                mockApp.firebaseService = new FirebaseService();
                
                // 模擬配置（使用模擬模式）
                const config = window.getFirebaseConfig();
                output += `📋 Firebase 配置: ${config ? '✅ 已取得' : '❌ 取得失敗'}\n`;
                
                // 初始化 Firebase 服務（這會創建模擬數據庫）
                if (config) {
                    const { app, database } = await window.initializeFirebaseApp(config);
                    if (database) {
                        // 直接設置模擬數據庫到服務中
                        mockApp.firebaseService.db = database;
                        output += '✅ Firebase 服務已初始化（模擬模式）\n';
                    } else {
                        output += '❌ Firebase 數據庫初始化失敗\n';
                    }
                } else {
                    output += '❌ 無法取得 Firebase 配置\n';
                }
                
                // 步驟 3: ScrumAdviceUI 初始化
                output += '🧠 初始化 ScrumAdviceUI...\n';
                mockApp.adviceUI = new ScrumAdviceUI();
                await mockApp.adviceUI.initialize();
                output += '✅ ScrumAdviceUI 初始化完成\n';
                
                // 步驟 4: 模擬投票數據
                output += '🗳️ 模擬投票數據生成...\n';
                const mockVotes = {
                    'test_player_1': { value: 5, timestamp: Date.now(), player_role: 'dev' },
                    'test_player_2': { value: 8, timestamp: Date.now(), player_role: 'qa' },
                    'test_player_3': { value: 5, timestamp: Date.now(), player_role: 'po' }
                };
                
                const mockStatistics = {
                    averagePoints: 6,
                    consensus: 60,
                    totalVotes: 3
                };
                
                // 步驟 5: 模擬智慧建議生成（主應用邏輯）
                output += '🎯 模擬智慧建議生成...\n';
                
                const votesData = { votes: mockVotes };
                const adviceContext = {
                    taskType: 'frontend',
                    players: [
                        { id: 'test_player_1', name: '玩家1', role: 'dev' },
                        { id: 'test_player_2', name: '玩家2', role: 'qa' },
                        { id: 'test_player_3', name: '玩家3', role: 'po' }
                    ],
                    sessionInfo: {
                        roomId: mockApp.roomId,
                        timestamp: Date.now(),
                        gamePhase: 'finished'
                    }
                };
                
                // 執行建議生成
                await mockApp.adviceUI.generateAdviceFromVotes(votesData, adviceContext);
                output += '✅ 建議生成完成\n';
                
                // 步驟 6: 模擬 Firebase 學習數據保存
                output += '💾 模擬 Firebase 學習數據保存...\n';
                
                // 保存學習會話
                const sessionData = {
                    taskType: 'frontend',
                    votes: mockVotes,
                    statistics: mockStatistics,
                    sessionInfo: adviceContext.sessionInfo
                };
                
                try {
                    const sessionSaved = await mockApp.firebaseService.saveLearningSession(mockApp.roomId, sessionData);
                    output += `📚 學習會話保存: ${sessionSaved ? '✅ 成功' : '❌ 失敗'}\n`;
                } catch (error) {
                    output += `📚 學習會話保存: ❌ 失敗 (${error.message})\n`;
                }
                
                // 保存學習建議
                if (mockApp.adviceUI.currentAdvice) {
                    try {
                        const adviceSaved = await mockApp.firebaseService.saveLearningAdvice(mockApp.roomId, mockApp.adviceUI.currentAdvice);
                        output += `💡 學習建議保存: ${adviceSaved ? '✅ 成功' : '❌ 失敗'}\n`;
                    } catch (error) {
                        output += `💡 學習建議保存: ❌ 失敗 (${error.message})\n`;
                    }
                } else {
                    output += `💡 學習建議保存: ⚠️ 跳過（無建議內容）\n`;
                }
                
                // 步驟 7: 檢查匿名化
                output += '🔒 檢查匿名化處理...\n';
                const anonymizedVotes = mockApp.firebaseService.anonymizeVotes(mockVotes);
                const hasPersonalInfo = JSON.stringify(anonymizedVotes).includes('test_player');
                output += `🔒 投票匿名化: ${!hasPersonalInfo ? '✅ 成功' : '❌ 仍有個人資訊'}\n`;
                
                if (mockApp.adviceUI.currentAdvice) {
                    const anonymizedAdvice = mockApp.firebaseService.anonymizeLearningData(mockApp.adviceUI.currentAdvice);
                    output += `🔒 建議匿名化: ✅ 已處理\n`;
                }
                
                // 總結
                output += '\n🎉 整合流程模擬完成!\n';
                output += '✅ 主應用已完整整合 Firebase 學習系統\n';
                output += '✅ 單一觸發機制已實現\n';
                output += '✅ 匿名化處理正常運作\n';
                output += '✅ 學習數據可正常保存和同步\n';
                
                result.textContent = output;
                result.className = 'result success';
                testResults.integration = true;
                
            } catch (error) {
                output += `\n❌ 整合流程模擬失敗: ${error.message}\n`;
                output += `❌ 堆疊追蹤: ${error.stack}\n`;
                
                result.textContent = output;
                result.className = 'result error';
                testResults.integration = false;
            }
            
            // 更新建議
            updateRecommendations();
        }

        // 更新建議
        function updateRecommendations() {
            const recommendations = document.getElementById('recommendations');
            let output = '📋 整合狀態建議:\n\n';
            
            const { dependencies, firebase, advice, integration } = testResults;
            
            if (dependencies === true && firebase === true && advice === true && integration === true) {
                output += '🎉 恭喜！主應用的 Firebase 學習系統整合完美！\n\n';
                output += '✅ 所有組件正常載入\n';
                output += '✅ Firebase 服務功能完整\n';
                output += '✅ ScrumAdviceEngine 運作正常\n';
                output += '✅ 整合流程測試通過\n\n';
                output += '🚀 建議下一步:\n';
                output += '• 在真實 Firebase 環境中測試\n';
                output += '• 進行多人協作測試\n';
                output += '• 檢查生產環境設定\n';
                recommendations.className = 'result success';
            } else {
                output += '⚠️ 發現一些需要注意的問題:\n\n';
                
                if (dependencies === false) {
                    output += '❌ 依賴問題: 請確保所有必要腳本正確載入\n';
                }
                if (firebase === false) {
                    output += '❌ Firebase 問題: 請檢查 FirebaseService 實現\n';
                }
                if (advice === false) {
                    output += '❌ 建議引擎問題: 請檢查 ScrumAdviceEngine 實現\n';
                }
                if (integration === false) {
                    output += '❌ 整合問題: 請檢查主應用中的整合邏輯\n';
                }
                
                output += '\n🔧 建議修復後重新測試\n';
                recommendations.className = 'result warning';
            }
            
            recommendations.textContent = output;
        }

        // 頁面載入完成後提示
        window.addEventListener('load', () => {
            console.log('🧪 主應用整合測試頁面已載入');
            document.getElementById('recommendations').textContent = '✨ 頁面已準備就緒，請開始測試各個組件！';
        });
    </script>
</body>
</html>