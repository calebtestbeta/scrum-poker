{
  "rules": {
    ".read": false,
    ".write": false,
    
    "rooms": {
      "$roomId": {
        // 房間層級權限 - 允許認證用戶創建和修改房間
        ".read": "auth != null",
        ".write": "auth != null",
        
        // 房間基本資訊 - 需要身份驗證
        "phase": {
          ".read": "auth != null",
          ".write": "auth != null && (newData.val() == 'voting' || newData.val() == 'revealing' || newData.val() == 'finished')"
        },
        
        "created_at": {
          ".read": "auth != null",
          ".write": "auth != null && !data.exists()"
        },
        
        "last_activity": {
          ".read": "auth != null",  
          ".write": "auth != null"
        },
        
        "task_type": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        
        "current_task_types": {
          ".read": "auth != null",
          ".write": "auth != null",
          ".validate": "newData.isString()"
        },
        
        // 玩家管理 - 已驗證用戶可管理玩家資料
        "players": {
          ".read": "auth != null",
          
          "$playerId": {
            ".write": "auth != null",
            
            "name": {
              ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20"
            },
            
            "role": {
              ".validate": "newData.val().matches(/^(dev|qa|scrum_master|po|other)$/)"
            },
            
            "joined_at": {
              ".validate": "newData.isNumber()"
            },
            
            "last_active": {
              ".validate": "newData.isNumber()"
            },
            
            "online": {
              ".validate": "newData.isBoolean()"
            },
            
            "hasVoted": {
              ".validate": "newData.isBoolean()"
            }
          }
        },
        
        // 投票管理 - 已驗證用戶可管理投票資料
        "votes": {
          ".read": "auth != null",
          
          "$playerId": {
            ".write": "auth != null",
            
            "value": {
              ".validate": "newData.isNumber() || newData.val().matches(/^(coffee|question|infinity)$/)"
            },
            
            "timestamp": {
              ".validate": "newData.isNumber()"
            },
            
            "player_role": {
              ".validate": "newData.val().matches(/^(dev|qa|scrum_master|po|other)$/)"
            }
          }
        },
        
        // 會話統計資訊 - 只讀，需要身份驗證
        "session_info": {
          ".read": "auth != null",
          ".write": "auth != null"
        },
        
        // 智慧建議狀態 - 需要身份驗證
        "advice_state": {
          ".read": "auth != null",
          ".write": "auth != null",
          
          "visible": {
            ".validate": "newData.isBoolean()"
          },
          
          "generated_at": {
            ".validate": "newData.isNumber()"
          },
          
          "task_types": {
            ".validate": "newData.isString()"
          }
        }
      }
    }
  }
}