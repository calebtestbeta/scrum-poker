// éŠæˆ²æ•´åˆé‚è¼¯ - é€£æ¥æ‰€æœ‰ç®¡ç†å™¨å’Œ UI å…ƒç´ 
// å…¨åŸŸå‡½æ•¸ä¾› HTML å‘¼å«

// é–‹å§‹éŠæˆ²
async function startGame() {\n    const playerName = document.getElementById('playerName').value.trim();\n    const playerRole = document.getElementById('playerRole').value;\n    const roomId = document.getElementById('roomId').value.trim();\n    \n    // é©—è­‰è¼¸å…¥\n    if (!playerName) {\n        uiManager.showError('è«‹è¼¸å…¥ä½ çš„åå­—');\n        return;\n    }\n    \n    try {\n        // è¨­å®šè¼‰å…¥ç‹€æ…‹\n        gameState = 'loading';\n        \n        // åˆå§‹åŒ– Firebase è¨­å®š\n        const config = await getFirebaseConfig();\n        \n        // åˆå§‹åŒ– Firebase Manager\n        await firebaseManager.initialize(config);\n        \n        // è¨­å®š Firebase å›èª¿\n        setupFirebaseCallbacks();\n        \n        // åŠ å…¥æˆ¿é–“\n        const result = await firebaseManager.joinRoom(roomId, playerName, playerRole);\n        \n        if (result) {\n            // å»ºç«‹ç•¶å‰ç©å®¶\n            currentPlayer = {\n                id: result.playerId,\n                name: playerName,\n                role: playerRole\n            };\n            \n            // åœ¨éŠæˆ²æ¡Œé¢æ–°å¢ç©å®¶\n            gameTable.addPlayer(result.playerId, playerName, playerRole);\n            \n            // å•Ÿå‹• UI\n            uiManager.startGame(result.roomId, result.playerId);\n            \n            console.log('ğŸ® éŠæˆ²å•Ÿå‹•æˆåŠŸ');\n        } else {\n            throw new Error('ç„¡æ³•åŠ å…¥æˆ¿é–“');\n        }\n        \n    } catch (error) {\n        console.error('å•Ÿå‹•éŠæˆ²å¤±æ•—:', error);\n        uiManager.showError('å•Ÿå‹•éŠæˆ²å¤±æ•—: ' + error.message);\n        gameState = 'login';\n    }\n}\n\n// é–‹ç‰Œ\nfunction revealCards() {\n    if (!gameTable || !firebaseManager) {\n        console.warn('éŠæˆ²æœªåˆå§‹åŒ–');\n        return;\n    }\n    \n    // è§¸ç™¼å‹•ç•«æ•ˆæœ\n    animationManager.flash(color(251, 191, 36), 200);\n    animationManager.shake(5, 300);\n    \n    // åŸ·è¡Œé–‹ç‰Œ\n    gameTable.revealCards();\n    firebaseManager.revealCards();\n    \n    uiManager.showSuccess('é–‹ç‰Œï¼');\n}\n\n// æ¸…é™¤æŠ•ç¥¨\nfunction clearVotes() {\n    if (!gameTable || !firebaseManager) {\n        console.warn('éŠæˆ²æœªåˆå§‹åŒ–');\n        return;\n    }\n    \n    // åŸ·è¡Œæ¸…é™¤\n    gameTable.clearVotes();\n    firebaseManager.clearVotes();\n    \n    // é‡è¨­ UI çµ±è¨ˆ\n    uiManager.resetStatistics();\n    \n    uiManager.showSuccess('é‡æ–°é–‹å§‹ï¼');\n}\n\n// é›¢é–‹éŠæˆ²\nfunction leaveGame() {\n    if (firebaseManager) {\n        firebaseManager.leaveRoom();\n    }\n    \n    // æ¸…é™¤éŠæˆ²ç‹€æ…‹\n    currentPlayer = null;\n    \n    // é‡è¨­éŠæˆ²æ¡Œé¢\n    if (gameTable) {\n        gameTable.players = [];\n    }\n    \n    // æ¸…é™¤å‹•ç•«æ•ˆæœ\n    animationManager.clearAllEffects();\n    \n    // çµæŸ UI\n    uiManager.endGame();\n    \n    console.log('ğŸ‘‹ é›¢é–‹éŠæˆ²');\n}\n\n// å„²å­˜ Firebase è¨­å®š\nfunction saveFirebaseConfig() {\n    const projectId = document.getElementById('projectId').value.trim();\n    const apiKey = document.getElementById('apiKey').value.trim();\n    \n    if (!projectId || !apiKey) {\n        uiManager.showError('è«‹å¡«å¯«å®Œæ•´çš„ Firebase è¨­å®š');\n        return;\n    }\n    \n    // å„²å­˜åˆ° localStorage\n    const config = { projectId, apiKey };\n    localStorage.setItem('scrumPokerConfig', JSON.stringify(config));\n    localStorage.removeItem('scrumPokerMode'); // æ¸…é™¤æœ¬åœ°æ¨¡å¼æ¨™è¨˜\n    \n    // éš±è—è¨­å®šå€åŸŸ\n    const configSection = document.querySelector('.firebase-config');\n    if (configSection) {\n        configSection.style.display = 'none';\n    }\n    \n    uiManager.showSuccess('Firebase è¨­å®šå·²å„²å­˜ï¼');\n}\n\n// ä½¿ç”¨æœ¬åœ°æ¨¡å¼\nfunction useLocalMode() {\n    // æ¸…é™¤ Firebase è¨­å®š\n    localStorage.removeItem('scrumPokerConfig');\n    localStorage.setItem('scrumPokerMode', 'local');\n    \n    // éš±è—è¨­å®šå€åŸŸ\n    const configSection = document.querySelector('.firebase-config');\n    if (configSection) {\n        configSection.style.display = 'none';\n    }\n    \n    uiManager.showSuccess('å·²åˆ‡æ›åˆ°æœ¬åœ°æ¨¡å¼ï¼');\n}\n\n// å–å¾— Firebase è¨­å®š\nasync function getFirebaseConfig() {\n    const savedConfig = localStorage.getItem('scrumPokerConfig');\n    const savedMode = localStorage.getItem('scrumPokerMode');\n    \n    if (savedConfig) {\n        return JSON.parse(savedConfig);\n    } else if (savedMode === 'local') {\n        return null; // ä½¿ç”¨æœ¬åœ°æ¨¡å¼\n    } else {\n        // æª¢æŸ¥æ˜¯å¦æœ‰å…¨åŸŸè¨­å®šï¼ˆå¾ firebase-config.jsï¼‰\n        if (typeof window.FIREBASE_CONFIG !== 'undefined') {\n            return window.FIREBASE_CONFIG;\n        }\n        return null;\n    }\n}\n\n// è¨­å®š Firebase å›èª¿å‡½æ•¸\nfunction setupFirebaseCallbacks() {\n    if (!firebaseManager) return;\n    \n    firebaseManager.setCallbacks({\n        onPlayerJoined: (playerData) => {\n            console.log('ç©å®¶åŠ å…¥:', playerData.name);\n            \n            // åœ¨éŠæˆ²æ¡Œé¢æ–°å¢ç©å®¶\n            if (gameTable && playerData.id !== currentPlayer?.id) {\n                gameTable.addPlayer(playerData.id, playerData.name, playerData.role);\n            }\n            \n            // æ›´æ–°ç©å®¶æ•¸é‡\n            const totalPlayers = gameTable ? gameTable.players.length : 0;\n            uiManager.updatePlayerCount(totalPlayers);\n            \n            // è§¸ç™¼åŠ å…¥å‹•ç•«\n            if (animationManager && gameTable) {\n                const player = gameTable.players.find(p => p.id === playerData.id);\n                if (player) {\n                    animationManager.createCelebration(player.position.x, player.position.y);\n                }\n            }\n            \n            uiManager.showSuccess(`${playerData.name} åŠ å…¥äº†éŠæˆ²`);\n        },\n        \n        onPlayerLeft: (playerData) => {\n            console.log('ç©å®¶é›¢é–‹:', playerData.name);\n            \n            // å¾éŠæˆ²æ¡Œé¢ç§»é™¤ç©å®¶\n            if (gameTable) {\n                gameTable.removePlayer(playerData.id);\n            }\n            \n            // æ›´æ–°ç©å®¶æ•¸é‡\n            const totalPlayers = gameTable ? gameTable.players.length : 0;\n            uiManager.updatePlayerCount(totalPlayers);\n            \n            uiManager.showToast(`${playerData.name} é›¢é–‹äº†éŠæˆ²`, 'info');\n        },\n        \n        onVoteUpdated: (playerData) => {\n            console.log('æŠ•ç¥¨æ›´æ–°:', playerData.name, playerData.vote);\n            \n            // æ›´æ–°éŠæˆ²æ¡Œé¢çš„ç©å®¶ç‹€æ…‹\n            if (gameTable) {\n                const player = gameTable.players.find(p => p.id === playerData.id);\n                if (player && playerData.hasVoted) {\n                    player.setVote(playerData.vote);\n                    \n                    // è§¸ç™¼æŠ•ç¥¨å‹•ç•«\n                    if (animationManager) {\n                        animationManager.createExplosion(player.position.x, player.position.y, 10);\n                    }\n                }\n                \n                // æ›´æ–°æŠ•ç¥¨é€²åº¦\n                const votedCount = gameTable.players.filter(p => p.hasVoted).length;\n                const totalCount = gameTable.players.length;\n                uiManager.updateVotingProgress(votedCount, totalCount);\n            }\n        },\n        \n        onGameStateChanged: (roomData) => {\n            console.log('éŠæˆ²ç‹€æ…‹è®Šæ›´:', roomData.phase);\n            \n            if (roomData.phase === 'revealing') {\n                // é–‹ç‰Œéšæ®µ\n                uiManager.updateGameStatus('revealing');\n                \n                if (gameTable) {\n                    gameTable.gamePhase = 'revealing';\n                    gameTable.revealStartTime = millis();\n                }\n                \n                // è§¸ç™¼é–‹ç‰Œå‹•ç•«\n                if (animationManager) {\n                    animationManager.flash(color(34, 197, 94), 500);\n                    animationManager.shake(8, 400);\n                }\n            } else if (roomData.phase === 'voting') {\n                // æŠ•ç¥¨éšæ®µ\n                uiManager.updateGameStatus('voting');\n                \n                if (gameTable) {\n                    gameTable.gamePhase = 'voting';\n                }\n            } else if (roomData.phase === 'finished') {\n                // å®Œæˆéšæ®µ\n                uiManager.updateGameStatus('finished');\n                \n                if (gameTable) {\n                    gameTable.gamePhase = 'finished';\n                }\n                \n                // æ›´æ–°çµ±è¨ˆè³‡æ–™\n                if (roomData.votes) {\n                    const votes = Object.values(roomData.votes);\n                    uiManager.updateStatistics(votes);\n                }\n                \n                // è§¸ç™¼æ…¶ç¥å‹•ç•«\n                if (animationManager && gameTable) {\n                    for (const player of gameTable.players) {\n                        if (player.hasVoted) {\n                            setTimeout(() => {\n                                animationManager.createCelebration(player.position.x, player.position.y);\n                            }, Math.random() * 1000);\n                        }\n                    }\n                }\n            }\n        },\n        \n        onError: (errorMessage) => {\n            console.error('Firebase éŒ¯èª¤:', errorMessage);\n            uiManager.showError(errorMessage);\n        }\n    });\n}\n\n// Scrum Master å»ºè­°ç³»çµ±\nclass ScrumMasterAdvice {\n    constructor() {\n        this.suggestions = [];\n        this.isVisible = false;\n    }\n    \n    // åˆ†ææŠ•ç¥¨çµæœä¸¦ç”¢ç”Ÿå»ºè­°\n    analyzeVotes(votes) {\n        this.suggestions = [];\n        \n        if (votes.length === 0) return;\n        \n        const numericVotes = votes.filter(v => typeof v.value === 'number');\n        const devVotes = numericVotes.filter(v => v.playerRole === 'dev');\n        const qaVotes = numericVotes.filter(v => v.playerRole === 'qa');\n        \n        // è¨ˆç®—çµ±è¨ˆæ•¸æ“š\n        const allAverage = numericVotes.reduce((sum, v) => sum + v.value, 0) / numericVotes.length;\n        const devAverage = devVotes.length > 0 ? devVotes.reduce((sum, v) => sum + v.value, 0) / devVotes.length : 0;\n        const qaAverage = qaVotes.length > 0 ? qaVotes.reduce((sum, v) => sum + v.value, 0) / qaVotes.length : 0;\n        \n        const variance = numericVotes.reduce((sum, v) => sum + Math.pow(v.value - allAverage, 2), 0) / numericVotes.length;\n        const isHighVariance = variance > 4;\n        \n        // ç”¢ç”Ÿå»ºè­°\n        if (devVotes.length > 0 && qaVotes.length > 0) {\n            const devQaDiff = Math.abs(devAverage - qaAverage);\n            \n            if (devQaDiff > 3) {\n                if (devAverage > qaAverage) {\n                    this.suggestions.push({\n                        type: 'role_gap',\n                        title: 'é–‹ç™¼èˆ‡æ¸¬è©¦ä¼°é»å·®ç•°è¼ƒå¤§',\n                        message: 'é–‹ç™¼åœ˜éšŠçš„ä¼°é»æ˜é¡¯é«˜æ–¼æ¸¬è©¦åœ˜éšŠï¼Œå¯èƒ½éœ€è¦è¨è«–æŠ€è¡“è¤‡é›œåº¦èˆ‡æ¸¬è©¦ç­–ç•¥çš„èªçŸ¥å·®ç•°ã€‚',\n                        icon: 'âš ï¸'\n                    });\n                } else {\n                    this.suggestions.push({\n                        type: 'role_gap',\n                        title: 'æ¸¬è©¦ä¼°é»é«˜æ–¼é–‹ç™¼ä¼°é»',\n                        message: 'æ¸¬è©¦åœ˜éšŠèªç‚ºæ­¤åŠŸèƒ½æ¸¬è©¦è¤‡é›œåº¦è¼ƒé«˜ï¼Œå»ºè­°è¨è«–æ¸¬è©¦ç¯„åœèˆ‡è‡ªå‹•åŒ–æ¸¬è©¦çš„å¯èƒ½æ€§ã€‚',\n                        icon: 'ğŸ”'\n                    });\n                }\n            }\n        }\n        \n        if (isHighVariance) {\n            this.suggestions.push({\n                type: 'high_variance',\n                title: 'ä¼°é»åˆ†æ­§è¼ƒå¤§',\n                message: 'åœ˜éšŠå°æ­¤åŠŸèƒ½çš„è¤‡é›œåº¦èªçŸ¥å·®ç•°è¼ƒå¤§ï¼Œå»ºè­°é€²ä¸€æ­¥è¨è«–éœ€æ±‚ç´°ç¯€å’Œå¯¦ä½œæ–¹å¼ã€‚',\n                icon: 'ğŸ’­'\n            });\n        }\n        \n        if (allAverage > 8) {\n            this.suggestions.push({\n                type: 'high_complexity',\n                title: 'é«˜è¤‡é›œåº¦åŠŸèƒ½',\n                message: 'æ­¤åŠŸèƒ½è¤‡é›œåº¦è¼ƒé«˜ï¼Œå»ºè­°è€ƒæ…®æ‹†åˆ†æˆè¼ƒå°çš„ User Storyï¼Œæˆ–åˆ†éšæ®µå¯¦ä½œã€‚',\n                icon: 'ğŸ”¨'\n            });\n        }\n        \n        if (numericVotes.length > 0 && variance < 1) {\n            this.suggestions.push({\n                type: 'good_consensus',\n                title: 'åœ˜éšŠå…±è­˜è‰¯å¥½',\n                message: 'åœ˜éšŠå°æ­¤åŠŸèƒ½çš„è¤‡é›œåº¦èªçŸ¥ä¸€è‡´ï¼Œå¯ä»¥æ”¾å¿ƒé€²è¡Œé–‹ç™¼è¦åŠƒã€‚',\n                icon: 'âœ…'\n            });\n        }\n        \n        // ç‰¹æ®Šå¡ç‰Œå»ºè­°\n        const coffeeVotes = votes.filter(v => v.value === 'coffee');\n        const questionVotes = votes.filter(v => v.value === 'question');\n        \n        if (coffeeVotes.length > 0) {\n            this.suggestions.push({\n                type: 'break_needed',\n                title: 'ä¼‘æ¯æ™‚é–“',\n                message: `${coffeeVotes.length} ä½æˆå“¡å»ºè­°ä¼‘æ¯ï¼Œè€ƒæ…®å®‰æ’çŸ­æš«ä¼‘æ¯å¾Œå†ç¹¼çºŒè¨è«–ã€‚`,\n                icon: 'â˜•'\n            });\n        }\n        \n        if (questionVotes.length > 0) {\n            this.suggestions.push({\n                type: 'unclear_requirements',\n                title: 'éœ€æ±‚ä¸æ˜ç¢º',\n                message: `${questionVotes.length} ä½æˆå“¡å°éœ€æ±‚æœ‰ç–‘å•ï¼Œå»ºè­°å…ˆæ¾„æ¸…éœ€æ±‚ç´°ç¯€å†é‡æ–°ä¼°é»ã€‚`,\n                icon: 'â“'\n            });\n        }\n    }\n    \n    // ç¹ªè£½å»ºè­°é¢æ¿\n    draw() {\n        if (!this.isVisible || this.suggestions.length === 0) return;\n        \n        push();\n        \n        // èƒŒæ™¯\n        fill(0, 0, 0, 180);\n        noStroke();\n        rectMode(CORNER);\n        const panelWidth = 350;\n        const panelHeight = Math.min(400, this.suggestions.length * 80 + 60);\n        const panelX = width - panelWidth - 20;\n        const panelY = height - panelHeight - 100;\n        \n        rect(panelX, panelY, panelWidth, panelHeight, 15);\n        \n        // æ¨™é¡Œ\n        fill(GAME_CONFIG.colors.accent);\n        textAlign(LEFT, TOP);\n        textSize(18);\n        textStyle(BOLD);\n        text('ğŸ¯ Scrum Master å»ºè­°', panelX + 20, panelY + 20);\n        \n        // å»ºè­°åˆ—è¡¨\n        textStyle(NORMAL);\n        let currentY = panelY + 50;\n        \n        for (const suggestion of this.suggestions) {\n            // åœ–ç¤º\n            textSize(20);\n            text(suggestion.icon, panelX + 20, currentY);\n            \n            // æ¨™é¡Œ\n            fill(255);\n            textSize(14);\n            textStyle(BOLD);\n            text(suggestion.title, panelX + 50, currentY);\n            \n            // è¨Šæ¯\n            fill(200);\n            textSize(12);\n            textStyle(NORMAL);\n            const messageLines = this.wrapText(suggestion.message, panelWidth - 70);\n            for (let i = 0; i < messageLines.length; i++) {\n                text(messageLines[i], panelX + 50, currentY + 20 + i * 15);\n            }\n            \n            currentY += 70;\n        }\n        \n        pop();\n    }\n    \n    // æ–‡å­—æ›è¡Œ\n    wrapText(text, maxWidth) {\n        const words = text.split(' ');\n        const lines = [];\n        let currentLine = '';\n        \n        for (const word of words) {\n            const testLine = currentLine + (currentLine ? ' ' : '') + word;\n            if (textWidth(testLine) <= maxWidth) {\n                currentLine = testLine;\n            } else {\n                if (currentLine) {\n                    lines.push(currentLine);\n                }\n                currentLine = word;\n            }\n        }\n        \n        if (currentLine) {\n            lines.push(currentLine);\n        }\n        \n        return lines;\n    }\n    \n    // é¡¯ç¤ºå»ºè­°\n    show() {\n        this.isVisible = true;\n    }\n    \n    // éš±è—å»ºè­°\n    hide() {\n        this.isVisible = false;\n    }\n    \n    // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹\n    toggle() {\n        this.isVisible = !this.isVisible;\n    }\n}\n\n// å»ºç«‹ Scrum Master å»ºè­°ç³»çµ±å¯¦ä¾‹\nlet scrumMasterAdvice;\n\n// ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–\nwindow.addEventListener('DOMContentLoaded', () => {\n    scrumMasterAdvice = new ScrumMasterAdvice();\n    console.log('ğŸ¯ Scrum Master å»ºè­°ç³»çµ±å·²åˆå§‹åŒ–');\n});\n\n// åœ¨ UIManager çš„ draw æ–¹æ³•ä¸­æ–°å¢å»ºè­°é¢æ¿ç¹ªè£½\nif (typeof UIManager !== 'undefined') {\n    const originalDraw = UIManager.prototype.draw;\n    UIManager.prototype.draw = function() {\n        originalDraw.call(this);\n        \n        // ç¹ªè£½ Scrum Master å»ºè­°\n        if (scrumMasterAdvice && this.gamePhase === 'finished') {\n            scrumMasterAdvice.draw();\n        }\n    };\n    \n    // è¦†å¯«çµ±è¨ˆæ›´æ–°æ–¹æ³•ä»¥åŒ…å«å»ºè­°åˆ†æ\n    const originalUpdateStatistics = UIManager.prototype.updateStatistics;\n    UIManager.prototype.updateStatistics = function(votes) {\n        originalUpdateStatistics.call(this, votes);\n        \n        // åˆ†ææŠ•ç¥¨ä¸¦ç”¢ç”Ÿå»ºè­°\n        if (scrumMasterAdvice) {\n            scrumMasterAdvice.analyzeVotes(votes);\n            scrumMasterAdvice.show();\n        }\n    };\n}\n\n// éµç›¤å¿«æ·éµè™•ç†\ndocument.addEventListener('keydown', (event) => {\n    if (gameState === 'game') {\n        // H éµåˆ‡æ›å»ºè­°é¢æ¿\n        if (event.code === 'KeyH' && scrumMasterAdvice) {\n            scrumMasterAdvice.toggle();\n        }\n        \n        // ç©ºç™½éµé–‹ç‰Œ\n        if (event.code === 'Space') {\n            event.preventDefault();\n            revealCards();\n        }\n    }\n});\n\nconsole.log('ğŸ® éŠæˆ²æ•´åˆé‚è¼¯å·²è¼‰å…¥');\n