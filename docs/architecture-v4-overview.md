# Scrum Poker v4.0 æ¶æ§‹é‡æ§‹ç¸½è¦½

## ğŸ¯ é‡æ§‹ç›®æ¨™

æœ¬æ¬¡æ¶æ§‹é‡æ§‹æ—¨åœ¨è§£æ±ºä»¥ä¸‹æ ¸å¿ƒå•é¡Œï¼š
1. **ç‹€æ…‹ç®¡ç†åˆ†æ•£**ï¼šGameState å’Œ GameTable è€¦åˆéç·Š
2. **äº‹ä»¶ç³»çµ±æ··äº‚**ï¼šç¼ºä¹çµ±ä¸€çš„äº‹ä»¶ç®¡ç†æ©Ÿåˆ¶
3. **Firebase æœå‹™è‡ƒè…«**ï¼šå–®ä¸€æœå‹™æ‰¿æ“”éå¤šè·è²¬
4. **ä½µç™¼è¡çªè™•ç†**ï¼šç¼ºä¹ç³»çµ±æ€§çš„è¡çªè§£æ±ºæ©Ÿåˆ¶
5. **æ“´å±•æ€§é™åˆ¶**ï¼šé›£ä»¥æ”¯æŒæœªä¾†çš„åŠŸèƒ½æ“´å±•

## ğŸ—ï¸ æ–°æ¶æ§‹æ¦‚è¦½

### æ ¸å¿ƒæ¶æ§‹æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     çµ±ä¸€äº‹ä»¶åŒ¯æµæ’                          â”‚
â”‚                   (UnifiedEventBus)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ GameManager  â”‚ â”‚  FirebaseEvent  â”‚ â”‚ UIçµ„ä»¶å±¤   â”‚
    â”‚   (æ§åˆ¶ä¸­å¿ƒ)  â”‚ â”‚    Manager      â”‚ â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ GameContext  â”‚
    â”‚  (æ©‹æ¥å±¤)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚StateMachine  â”‚
    â”‚  (ç‹€æ…‹æ©Ÿ)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Firebase æ•¸æ“šå±¤                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConflictResolverâ”‚ FirebaseDataSyncâ”‚    FirebaseEvent       â”‚
â”‚   (è¡çªè§£æ±º)     â”‚   (æ•¸æ“šåŒæ­¥)     â”‚      Manager           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ–°å¢æ ¸å¿ƒçµ„ä»¶

### 1. GameManager (éŠæˆ²ç®¡ç†å™¨)
**æª”æ¡ˆ**: `src/core/GameManager.js`

**è·è²¬**ï¼š
- ä½œç‚ºæ•´å€‹éŠæˆ²ç³»çµ±çš„çµ±ä¸€æ§åˆ¶ä¸­å¿ƒ
- æ•´åˆ GameContextã€GameStateMachine å’Œå…¶ä»–çµ„ä»¶
- æä¾›é«˜å±¤æ¬¡çš„éŠæˆ² API
- ç®¡ç†çµ„ä»¶ç”Ÿå‘½é€±æœŸå’Œå¥åº·æª¢æŸ¥

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
class GameManager {
    async initialize(options)           // åˆå§‹åŒ–ç³»çµ±
    async startGame(options)            // é–‹å§‹éŠæˆ²
    async transitionTo(phase, options)  // ç‹€æ…‹è½‰æ›
    async revealVotes(triggeredBy)      // é–‹ç‰Œ
    async resetGame(triggeredBy)        // é‡ç½®éŠæˆ²
    getGameState()                      // ç²å–éŠæˆ²ç‹€æ…‹
    getDebugInfo()                      // èª¿è©¦è³‡è¨Š
}
```

### 2. GameStateMachine (éŠæˆ²ç‹€æ…‹æ©Ÿ)
**æª”æ¡ˆ**: `src/core/GameStateMachine.js`

**è·è²¬**ï¼š
- å¯¦ç¾ç‹€æ…‹æ¨¡å¼çš„éŠæˆ²éšæ®µç®¡ç†
- è™•ç†ç‹€æ…‹è½‰æ›çš„é©—è­‰å’ŒåŸ·è¡Œ
- æä¾›æ¸…æ™°çš„ç‹€æ…‹è½‰æ›è¦å‰‡

**ç‹€æ…‹å®šç¾©**ï¼š
```javascript
const GAME_PHASES = {
    WAITING: 'waiting',         // ç­‰å¾…ç©å®¶
    VOTING: 'voting',          // æŠ•ç¥¨é€²è¡Œä¸­
    REVEALING: 'revealing',    // é–‹ç‰Œéæ¸¡ä¸­
    REVEALED: 'revealed',      // å·²é–‹ç‰Œé¡¯ç¤º
    FINISHED: 'finished',      // æœ¬è¼ªçµæŸ
    RESETTING: 'resetting'     // é‡ç½®éæ¸¡ä¸­
}
```

### 3. GameContext (éŠæˆ²ä¸Šä¸‹æ–‡)
**æª”æ¡ˆ**: `src/core/GameContext.js`

**è·è²¬**ï¼š
- ä½œç‚ºç‹€æ…‹æ©Ÿèˆ‡éŠæˆ²çµ„ä»¶é–“çš„æ©‹æ¥å±¤
- ç®¡ç†çµ„ä»¶å¼•ç”¨å’Œä¾è³´æ³¨å…¥
- æä¾›çµ±ä¸€çš„éŠæˆ²è³‡æ–™å­˜å–ä»‹é¢

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
class GameContext {
    registerComponent(type, component)  // è¨»å†Šçµ„ä»¶
    updatePhase(phase, version)         // æ›´æ–°éšæ®µ
    clearVotingData()                   // æ¸…é™¤æŠ•ç¥¨
    revealAllVotes()                    // é–‹ç‰Œ
    generateAdvice()                    // ç”Ÿæˆå»ºè­°
}
```

### 4. UnifiedEventBus (çµ±ä¸€äº‹ä»¶åŒ¯æµæ’)
**æª”æ¡ˆ**: `src/core/UnifiedEventBus.js`

**è·è²¬**ï¼š
- çµ±ä¸€æ‰€æœ‰çµ„ä»¶çš„äº‹ä»¶é€šè¨Š
- æ”¯æ´äº‹ä»¶å„ªå…ˆç´šã€ç¯€æµã€é˜²æŠ–
- æä¾›å‘½åç©ºé–“ç®¡ç†å’Œè¬ç”¨å­—å…ƒç›£è½
- ä¸­ä»‹è»Ÿé«”ç³»çµ±æ”¯æ´

**æ ¸å¿ƒç‰¹æ€§**ï¼š
```javascript
class UnifiedEventBus {
    on(eventType, callback, options)    // è¨»å†Šç›£è½å™¨
    emit(eventType, data, options)      // ç™¼é€äº‹ä»¶
    onNamespace(namespace, callback)    // å‘½åç©ºé–“ç›£è½
    use(middleware, priority)           // è¨»å†Šä¸­ä»‹è»Ÿé«”
    getStatistics()                     // äº‹ä»¶çµ±è¨ˆ
}
```

### 5. ConflictResolver (è¡çªè§£æ±ºå™¨)
**æª”æ¡ˆ**: `src/services/ConflictResolver.js`

**è·è²¬**ï¼š
- æª¢æ¸¬ä½µç™¼æ“ä½œè¡çª
- å¯¦ç¾å¤šç¨®è¡çªè§£æ±ºç­–ç•¥
- æ”¯æ´æ¨‚è§€é–å’Œé‡è©¦æ©Ÿåˆ¶

**è§£æ±ºç­–ç•¥**ï¼š
```javascript
const RESOLUTION_STRATEGIES = {
    FIRST_WRITER_WINS: 'first_writer_wins',
    PRIORITY_BASED: 'priority_based',
    RETRY_WITH_BACKOFF: 'retry_with_backoff',
    IGNORE_CONFLICT: 'ignore_conflict'
}
```

### 6. FirebaseDataSync (Firebase æ•¸æ“šåŒæ­¥)
**æª”æ¡ˆ**: `src/services/FirebaseDataSync.js`

**è·è²¬**ï¼š
- å°ˆè²¬ Firebase æ•¸æ“šå­˜å–å’ŒåŒæ­¥
- å¯¦ç¾ç‰ˆæœ¬æ§åˆ¶å’Œæ¨‚è§€é–
- æ”¯æ´æ‰¹æ¬¡æ›´æ–°å’Œäº‹å‹™è™•ç†

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
class FirebaseDataSync {
    async readRoomState(roomId)         // è®€å–æˆ¿é–“ç‹€æ…‹
    async writeRoomState(roomId, data)  // å¯«å…¥æˆ¿é–“ç‹€æ…‹
    async transaction(roomId, updateFn) // äº‹å‹™æ€§æ›´æ–°
    setupListener(path, callback)       // è¨­ç½®ç›£è½å™¨
}
```

### 7. FirebaseEventManager (Firebase äº‹ä»¶ç®¡ç†å™¨)
**æª”æ¡ˆ**: `src/services/FirebaseEventManager.js`

**è·è²¬**ï¼š
- å°ˆè²¬ Firebase äº‹ä»¶ç›£è½å’Œåˆ†ç™¼
- å¯¦ç¾æ™ºæ…§äº‹ä»¶éæ¿¾å’Œæ‰¹æ¬¡è™•ç†
- æä¾›éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
class FirebaseEventManager {
    on(eventType, callback, options)       // è¨»å†Šäº‹ä»¶ç›£è½
    setupFirebaseListener(path, callback)  // è¨­ç½® Firebase ç›£è½
    emit(eventType, data)                  // ç™¼é€äº‹ä»¶
    processBatchedEvents()                 // æ‰¹æ¬¡äº‹ä»¶è™•ç†
}
```

## ğŸ”„ äº‹ä»¶ç³»çµ±é‡æ§‹

### çµ±ä¸€äº‹ä»¶å‘½åè¦ç¯„

```javascript
const UNIFIED_EVENT_TYPES = {
    // GameManager äº‹ä»¶
    GAME_MANAGER_INITIALIZED: 'manager:initialized',
    GAME_MANAGER_STATE_CHANGED: 'manager:stateChanged',
    GAME_MANAGER_TRANSITION_SUCCESS: 'manager:transition:success',
    
    // éŠæˆ²ç‹€æ…‹äº‹ä»¶
    GAME_STARTED: 'game:started',
    GAME_PHASE_CHANGED: 'game:phase-changed',
    GAME_VOTE_SUBMITTED: 'game:vote-submitted',
    
    // Firebase äº‹ä»¶
    FIREBASE_CONNECTED: 'firebase:connected',
    ROOM_PLAYERS_UPDATED: 'room:players-updated',
    ROOM_VOTES_UPDATED: 'room:votes-updated'
}
```

### äº‹ä»¶å„ªå…ˆç´šç³»çµ±

```javascript
const EVENT_PRIORITY = {
    CRITICAL: 1,    // ç³»çµ±é—œéµäº‹ä»¶
    HIGH: 2,        // éŠæˆ²ç‹€æ…‹è®Šæ›´
    NORMAL: 3,      // ä¸€èˆ¬äº‹ä»¶
    LOW: 4          // çµ±è¨ˆã€æ—¥èªŒç­‰
}
```

## ğŸš€ å‘å¾Œç›¸å®¹æ€§

### éºç•™ç³»çµ±æ•´åˆ

1. **GameState.js å…¼å®¹**ï¼š
   - GameManager é€šé `syncToLegacyGameState()` æ–¹æ³•åŒæ­¥ç‹€æ…‹
   - ä¿æŒç¾æœ‰ API å¯ç”¨æ€§

2. **EventBus é·ç§»**ï¼š
   - UnifiedEventBus è‡ªå‹•æª¢æ¸¬ä¸¦é·ç§»ç¾æœ‰ç›£è½å™¨
   - ä¿æŒå‘å¾Œå…¼å®¹çš„ API

3. **FirebaseService æ©‹æ¥**ï¼š
   - ç¾æœ‰ FirebaseService ç¹¼çºŒå·¥ä½œ
   - æ–°çµ„ä»¶é€æ­¥æ¥ç®¡åŠŸèƒ½

## ğŸ“Š æ•ˆèƒ½å„ªåŒ–

### äº‹ä»¶è™•ç†å„ªåŒ–

1. **æ‰¹æ¬¡è™•ç†**ï¼š50ms å…§çš„ç›¸ä¼¼äº‹ä»¶åˆä½µè™•ç†
2. **å„ªå…ˆç´šä½‡åˆ—**ï¼šé—œéµäº‹ä»¶å„ªå…ˆè™•ç†
3. **æ™ºæ…§ç¯€æµ**ï¼šé˜²æ­¢äº‹ä»¶æ°¾æ¿«
4. **è¨˜æ†¶é«”ç®¡ç†**ï¼šè‡ªå‹•æ¸…ç†éæœŸç›£è½å™¨

### æ•¸æ“šåŒæ­¥å„ªåŒ–

1. **ç‰ˆæœ¬æ§åˆ¶**ï¼šé¿å…ä¸å¿…è¦çš„æ•¸æ“šå‚³è¼¸
2. **æ¨‚è§€é–**ï¼šæ¸›å°‘è¡çªå’Œé‡è©¦
3. **æ‰¹æ¬¡æ›´æ–°**ï¼šåˆä½µå¤šå€‹å°æ›´æ–°
4. **é€£ç·šæ± ç®¡ç†**ï¼šå„ªåŒ– Firebase é€£ç·š

## ğŸ§ª æ¸¬è©¦èˆ‡é©—è­‰

### æ¸¬è©¦é é¢
**æª”æ¡ˆ**: `architecture-test.html`

æä¾›å®Œæ•´çš„æ–°æ¶æ§‹åŠŸèƒ½æ¸¬è©¦ï¼ŒåŒ…æ‹¬ï¼š
- çµ±ä¸€äº‹ä»¶ç³»çµ±æ¸¬è©¦
- GameManager åŠŸèƒ½æ¸¬è©¦
- è¡çªè§£æ±ºå™¨æ¸¬è©¦
- æ•¸æ“šåŒæ­¥æ¸¬è©¦
- ç³»çµ±çµ±è¨ˆç›£æ§

### ä½¿ç”¨æ–¹å¼
```bash
# åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å•Ÿå‹•æœ¬åœ°ä¼ºæœå™¨
python3 -m http.server 8080

# è¨ªå•æ¸¬è©¦é é¢
http://localhost:8080/architecture-test.html
```

## ğŸ”® æœªä¾†æ“´å±•èƒ½åŠ›

### Phase 2 è¨ˆåŠƒåŠŸèƒ½

1. **ç©å®¶ç‹€æ…‹ç®¡ç†é‡æ§‹**ï¼š
   - ç¨ç«‹çš„ç©å®¶æ¨¡å‹ç³»çµ±
   - ç‹€æ…‹æŒä¹…åŒ–æ©Ÿåˆ¶
   - é›¢ç·š/é‡é€£è™•ç†

2. **å»ºè­°å¼•æ“è§£è€¦**ï¼š
   - æ’ä»¶åŒ–å»ºè­°ç³»çµ±
   - å¤šé‡å»ºè­°ä¾†æºæ•´åˆ
   - æ©Ÿå™¨å­¸ç¿’æ•´åˆæº–å‚™

3. **è§€å¯Ÿè€…æ¨¡å¼å¯¦ç¾**ï¼š
   - æ”¯æ´éŠæˆ²è§€å¯Ÿè€…
   - å³æ™‚æ•¸æ“šåˆ†æ
   - ç¬¬ä¸‰æ–¹æ•´åˆ

4. **æ­·å²è¨˜éŒ„ç³»çµ±**ï¼š
   - å®Œæ•´çš„éŠæˆ²å›æ”¾
   - æ•¸æ“šå€‰å„²è¨­è¨ˆ
   - åˆ†ææŸ¥è©¢ä»‹é¢

## ğŸ“ˆ æ•ˆç›Šç¸½çµ

### æ¶æ§‹æ”¹å–„

1. **å¯ç¶­è­·æ€§æå‡**ï¼šæ¨¡çµ„åŒ–è¨­è¨ˆï¼Œè·è²¬æ¸…æ™°åˆ†é›¢
2. **æ“´å±•æ€§å¢å¼·**ï¼šæ’ä»¶åŒ–æ¶æ§‹ï¼Œæ˜“æ–¼æ·»åŠ æ–°åŠŸèƒ½
3. **ç©©å®šæ€§æ”¹é€²**ï¼šç³»çµ±æ€§éŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶
4. **æ•ˆèƒ½æœ€ä½³åŒ–**ï¼šæ™ºæ…§äº‹ä»¶è™•ç†å’Œæ•¸æ“šåŒæ­¥

### é–‹ç™¼é«”é©—æ”¹å–„

1. **èª¿è©¦å‹å¥½**ï¼šå®Œæ•´çš„æ—¥èªŒå’Œçµ±è¨ˆç³»çµ±
2. **æ¸¬è©¦ä¾¿åˆ©**ï¼šç¨ç«‹çµ„ä»¶æ˜“æ–¼å–®å…ƒæ¸¬è©¦
3. **æ–‡ä»¶å®Œæ•´**ï¼šæ¸…æ™°çš„ API æ–‡ä»¶å’Œä½¿ç”¨ç¯„ä¾‹
4. **å‘å¾Œå…¼å®¹**ï¼šå¹³æ»‘çš„å‡ç´šè·¯å¾‘

---

**ç‰ˆæœ¬**: v4.0.0-unified-architecture  
**å®Œæˆæ—¥æœŸ**: 2025-01-11  
**ä½œè€…**: Claude AI  
**ç‹€æ…‹**: Phase 1 å®Œæˆï¼Œæº–å‚™é€²å…¥ Phase 2