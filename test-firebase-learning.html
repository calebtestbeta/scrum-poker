<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase å­¸ç¿’ç³»çµ±æ¸¬è©¦</title>
    <link rel="stylesheet" href="src/styles/variables.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-game);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .test-header h1 {
            color: var(--text-inverse);
            margin-bottom: 10px;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-section h2 {
            color: var(--text-inverse);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-test {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: var(--color-primary);
            color: var(--text-inverse);
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn-test:hover {
            background: var(--color-primary-dark);
        }
        
        .btn-test.secondary {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-test.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .btn-test.danger {
            background: var(--color-danger);
        }
        
        .btn-test.danger:hover {
            background: var(--color-danger-dark);
        }
        
        .status-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid var(--color-primary);
        }
        
        .status-display h4 {
            color: var(--text-inverse);
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .status-display pre {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .input-group label {
            color: var(--text-inverse);
            min-width: 80px;
            font-weight: 600;
        }
        
        .input-group input, .input-group select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-inverse);
            flex: 1;
        }
        
        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .connection-status.connected {
            background: var(--color-success);
            color: white;
        }
        
        .connection-status.disconnected {
            background: var(--color-danger);
            color: white;
        }
        
        .connection-status.connecting {
            background: var(--color-warning);
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ”¥ Firebase å­¸ç¿’ç³»çµ±æ¸¬è©¦</h1>
            <p style="color: rgba(255, 255, 255, 0.8);">æ¸¬è©¦ Firebase å­¸ç¿’æ•¸æ“šå„²å­˜ã€åŒæ­¥å’ŒåŒ¿ååŒ–åŠŸèƒ½</p>
            <div>
                é€£ç·šç‹€æ…‹: <span class="connection-status disconnected" id="connectionStatus">æœªé€£ç·š</span>
            </div>
        </div>
        
        <!-- Firebase é€£ç·šæ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ”— Firebase é€£ç·šè¨­å®š</h2>
            <div class="input-group">
                <label>æˆ¿é–“ ID:</label>
                <input type="text" id="roomId" value="test_learning_room" placeholder="è¼¸å…¥æˆ¿é–“ ID">
            </div>
            <div class="test-controls">
                <button class="btn-test" id="diagnoseFirebase">ğŸ” è¨ºæ–· Firebase è¨­å®š</button>
                <button class="btn-test" id="connectFirebase">é€£ç·š Firebase</button>
                <button class="btn-test secondary" id="disconnectFirebase">æ–·ç·š</button>
                <button class="btn-test" id="joinRoom">åŠ å…¥æˆ¿é–“</button>
                <button class="btn-test secondary" id="leaveRoom">é›¢é–‹æˆ¿é–“</button>
            </div>
            <div class="status-display" id="connectionInfo">
                <h4>ğŸ”— é€£ç·šè³‡è¨Š</h4>
                <pre>é»æ“Šã€ŒğŸ” è¨ºæ–· Firebase è¨­å®šã€æª¢æŸ¥ç’°å¢ƒè¨­å®š</pre>
            </div>
        </div>
        
        <!-- å­¸ç¿’æ•¸æ“šæ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“š å­¸ç¿’æ•¸æ“šæ¸¬è©¦</h2>
            <div class="input-group">
                <label>ä»»å‹™é¡å‹:</label>
                <select id="taskType">
                    <option value="frontend">å‰ç«¯é–‹ç™¼</option>
                    <option value="backend">å¾Œç«¯é–‹ç™¼</option>
                    <option value="testing">æ¸¬è©¦</option>
                    <option value="devops">DevOps</option>
                    <option value="general">ä¸€èˆ¬ä»»å‹™</option>
                </select>
            </div>
            <div class="test-controls">
                <button class="btn-test" id="generateMockSession">ç”Ÿæˆæ¨¡æ“¬æœƒè©±</button>
                <button class="btn-test" id="saveLearningSession">ä¿å­˜å­¸ç¿’æœƒè©±</button>
                <button class="btn-test" id="generateAdvice">ç”Ÿæˆæ™ºæ…§å»ºè­°</button>
                <button class="btn-test" id="saveLearningAdvice">ä¿å­˜å­¸ç¿’å»ºè­°</button>
            </div>
            <div class="status-display" id="learningDataInfo">
                <h4>ğŸ“Š å­¸ç¿’æ•¸æ“šç‹€æ…‹</h4>
                <pre>æº–å‚™æ¸¬è©¦å­¸ç¿’æ•¸æ“šåŠŸèƒ½</pre>
            </div>
        </div>
        
        <!-- å³æ™‚åŒæ­¥æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ”„ å³æ™‚åŒæ­¥æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn-test" id="startAdviceListener">é–‹å§‹ç›£è½å»ºè­°</button>
                <button class="btn-test secondary" id="stopAdviceListener">åœæ­¢ç›£è½</button>
                <button class="btn-test" id="simulateAdviceUpdate">æ¨¡æ“¬å»ºè­°æ›´æ–°</button>
                <button class="btn-test" id="testSingleTrigger">æ¸¬è©¦å–®ä¸€è§¸ç™¼æ©Ÿåˆ¶</button>
            </div>
            <div class="status-display" id="syncInfo">
                <h4>ğŸ”„ åŒæ­¥ç‹€æ…‹</h4>
                <pre>ç­‰å¾…é–‹å§‹åŒæ­¥æ¸¬è©¦</pre>
            </div>
        </div>
        
        <!-- åŒ¿ååŒ–æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ”’ åŒ¿ååŒ–æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn-test" id="testAnonymization">æ¸¬è©¦åŒ¿ååŒ–</button>
                <button class="btn-test" id="viewStoredData">æŸ¥çœ‹å„²å­˜æ•¸æ“š</button>
                <button class="btn-test secondary" id="validateAnonymization">é©—è­‰åŒ¿ååŒ–</button>
            </div>
            <div class="status-display" id="anonymizationInfo">
                <h4>ğŸ”’ åŒ¿ååŒ–çµæœ</h4>
                <pre>é»æ“Šã€Œæ¸¬è©¦åŒ¿ååŒ–ã€æŸ¥çœ‹çµæœ</pre>
            </div>
        </div>
        
        <!-- è³‡æ–™æ¸…ç†æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ§¹ è³‡æ–™æ¸…ç†æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn-test" id="getLearningHistory">æŸ¥çœ‹å­¸ç¿’æ­·å²</button>
                <button class="btn-test" id="triggerCleanup">è§¸ç™¼è³‡æ–™æ¸…ç†</button>
                <button class="btn-test danger" id="clearAllLearningData">æ¸…é™¤æ‰€æœ‰å­¸ç¿’æ•¸æ“š</button>
            </div>
            <div class="status-display" id="cleanupInfo">
                <h4>ğŸ§¹ æ¸…ç†ç‹€æ…‹</h4>
                <pre>æº–å‚™æ¸¬è©¦è³‡æ–™æ¸…ç†åŠŸèƒ½</pre>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <!-- Firebase è¨­å®šæª” -->
    <script src="firebase-config.js"></script>
    
    <script src="src/utils/Utils.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/services/FirebaseService.js"></script>
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>
    
    <script>
        // Firebase å­¸ç¿’ç³»çµ±æ¸¬è©¦è…³æœ¬
        let firebaseService = null;
        let adviceEngine = null;
        let adviceUI = null;
        let currentRoomId = null;
        let currentSessionData = null;
        let adviceListener = null;
        
        // åˆå§‹åŒ–æ¸¬è©¦
        async function initializeTest() {
            console.log('ğŸ§ª åˆå§‹åŒ– Firebase å­¸ç¿’ç³»çµ±æ¸¬è©¦...');
            
            try {
                // åˆå§‹åŒ–å»ºè­°å¼•æ“
                adviceEngine = new ScrumAdviceEngine();
                
                // åˆå§‹åŒ– UI ç®¡ç†å™¨
                adviceUI = new ScrumAdviceUI();
                await adviceUI.initialize();
                
                console.log('âœ… æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–æˆåŠŸ');
                
                // ä¸ç«‹å³è¨­å®šé€£ç·šç‹€æ…‹ï¼Œè®“ç”¨æˆ¶å…ˆé€²è¡Œè¨ºæ–·
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.className = 'connection-status disconnected';
                    statusElement.textContent = 'ç­‰å¾…è¨ºæ–·';
                }
                
                setupEventListeners();
                
            } catch (error) {
                console.error('âŒ æ¸¬è©¦åˆå§‹åŒ–å¤±æ•—:', error);
                updateInfo('connectionInfo', 'connectionInfo', `åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }
        
        // è¨­å®šäº‹ä»¶ç›£è½
        function setupEventListeners() {
            // Firebase é€£ç·š
            document.getElementById('diagnoseFirebase').addEventListener('click', diagnoseFirebase);
            document.getElementById('connectFirebase').addEventListener('click', connectFirebase);
            document.getElementById('disconnectFirebase').addEventListener('click', disconnectFirebase);
            document.getElementById('joinRoom').addEventListener('click', joinRoom);
            document.getElementById('leaveRoom').addEventListener('click', leaveRoom);
            
            // å­¸ç¿’æ•¸æ“š
            document.getElementById('generateMockSession').addEventListener('click', generateMockSession);
            document.getElementById('saveLearningSession').addEventListener('click', saveLearningSession);
            document.getElementById('generateAdvice').addEventListener('click', generateAdvice);
            document.getElementById('saveLearningAdvice').addEventListener('click', saveLearningAdvice);
            
            // å³æ™‚åŒæ­¥
            document.getElementById('startAdviceListener').addEventListener('click', startAdviceListener);
            document.getElementById('stopAdviceListener').addEventListener('click', stopAdviceListener);
            document.getElementById('simulateAdviceUpdate').addEventListener('click', simulateAdviceUpdate);
            document.getElementById('testSingleTrigger').addEventListener('click', testSingleTrigger);
            
            // åŒ¿ååŒ–æ¸¬è©¦
            document.getElementById('testAnonymization').addEventListener('click', testAnonymization);
            document.getElementById('viewStoredData').addEventListener('click', viewStoredData);
            document.getElementById('validateAnonymization').addEventListener('click', validateAnonymization);
            
            // è³‡æ–™æ¸…ç†
            document.getElementById('getLearningHistory').addEventListener('click', getLearningHistory);
            document.getElementById('triggerCleanup').addEventListener('click', triggerCleanup);
            document.getElementById('clearAllLearningData').addEventListener('click', clearAllLearningData);
        }
        
        // æ›´æ–°é€£ç·šç‹€æ…‹
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            
            const statusText = {
                'connected': 'å·²é€£ç·š',
                'connecting': 'é€£ç·šä¸­',
                'disconnected': 'æœªé€£ç·š',
                'error': 'é€£ç·šéŒ¯èª¤'
            };
            
            statusElement.textContent = statusText[status] || status;
        }
        
        // æ›´æ–°è³‡è¨Šé¡¯ç¤º
        function updateInfo(sectionId, title, content) {
            const section = document.getElementById(sectionId);
            if (section) {
                const pre = section.querySelector('pre');
                if (pre) {
                    pre.textContent = typeof content === 'object' ? 
                        JSON.stringify(content, null, 2) : content;
                }
            }
        }
        
        // å‰µå»ºæ¨¡æ“¬çš„ FirebaseService
        function createMockFirebaseService(mockDatabase) {
            const service = {
                db: mockDatabase,
                
                getConnectionState: () => 'æ¨¡æ“¬é€£ç·š',
                
                // æ¨¡æ“¬å­¸ç¿’æœƒè©±ä¿å­˜
                saveLearningSession: async (roomId, sessionData) => {
                    console.log('ğŸ”§ æ¨¡æ“¬ä¿å­˜å­¸ç¿’æœƒè©±:', roomId, sessionData);
                    
                    // åŒ¿ååŒ–æ•¸æ“š
                    const anonymizedData = {
                        task_type: sessionData.taskType,
                        anonymous_votes: service.anonymizeVotes(sessionData.votes),
                        statistics: sessionData.statistics,
                        timestamp: Date.now()
                    };
                    
                    await mockDatabase.ref(`rooms/${roomId}/learning_data/session_history`).child(Date.now().toString()).set(anonymizedData);
                    return true;
                },
                
                // æ¨¡æ“¬å­¸ç¿’å»ºè­°ä¿å­˜
                saveLearningAdvice: async (roomId, advice) => {
                    console.log('ğŸ”§ æ¨¡æ“¬ä¿å­˜å­¸ç¿’å»ºè­°:', roomId, advice);
                    
                    const adviceData = {
                        title: advice.title,
                        content: advice.content,
                        keywords: advice.keywords,
                        visible_to_all: true,
                        stored_at: Date.now(),
                        metadata: advice.metadata
                    };
                    
                    await mockDatabase.ref(`rooms/${roomId}/learning_data/current_advice`).set(adviceData);
                    return true;
                },
                
                // æ¨¡æ“¬ç›£è½å­¸ç¿’å»ºè­°
                listenToLearningAdvice: (roomId, callback) => {
                    console.log('ğŸ”§ æ¨¡æ“¬ç›£è½å­¸ç¿’å»ºè­°:', roomId);
                    mockDatabase.ref(`rooms/${roomId}/learning_data/current_advice`).on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            callback(data);
                        }
                    });
                },
                
                // æ¨¡æ“¬åŒ¿ååŒ–æŠ•ç¥¨
                anonymizeVotes: (votes) => {
                    const anonymizedVotes = {};
                    Object.entries(votes || {}).forEach(([playerId, voteData], index) => {
                        const anonId = `anon_${index + 1}`;
                        anonymizedVotes[anonId] = {
                            role: voteData.player_role || 'other',
                            value: voteData.value,
                            timestamp: voteData.timestamp
                        };
                    });
                    return anonymizedVotes;
                },
                
                // æ¨¡æ“¬å–å¾—å­¸ç¿’æ­·å²æ‘˜è¦
                getLearningHistorySummary: async (roomId) => {
                    console.log('ğŸ”§ æ¨¡æ“¬å–å¾—å­¸ç¿’æ­·å²æ‘˜è¦:', roomId);
                    const snapshot = await mockDatabase.ref(`rooms/${roomId}/learning_data/session_history`).once('value');
                    const sessions = snapshot.val() || {};
                    
                    return {
                        totalSessions: Object.keys(sessions).length,
                        latestSession: Object.keys(sessions).length > 0 ? 
                            new Date(Math.max(...Object.keys(sessions).map(k => parseInt(k)))).toLocaleString() : 
                            'ç„¡',
                        roomId: roomId
                    };
                },
                
                // æ¨¡æ“¬è§¸ç™¼è³‡æ–™æ¸…ç†
                triggerLearningDataCleanup: async (roomId) => {
                    console.log('ğŸ”§ æ¨¡æ“¬è§¸ç™¼è³‡æ–™æ¸…ç†:', roomId);
                    return {
                        cleaned: true,
                        message: 'æ¨¡æ“¬æ¸…ç†å®Œæˆ',
                        timestamp: new Date().toLocaleString()
                    };
                },
                
                // æ¨¡æ“¬åŠ å…¥æˆ¿é–“
                joinRoom: async (roomId, player) => {
                    console.log('ğŸ”§ æ¨¡æ“¬åŠ å…¥æˆ¿é–“:', roomId, player);
                    
                    // æ¨¡æ“¬æˆ¿é–“æ•¸æ“š
                    const roomData = {
                        created_at: Date.now(),
                        phase: 'voting',
                        players: {
                            [player.id]: {
                                name: player.name,
                                role: player.role,
                                joined_at: Date.now(),
                                last_active: Date.now()
                            }
                        }
                    };
                    
                    await mockDatabase.ref(`rooms/${roomId}`).set(roomData);
                    
                    return {
                        isNewRoom: true,
                        playerCount: 1,
                        roomId: roomId
                    };
                },
                
                // æ¨¡æ“¬é›¢é–‹æˆ¿é–“
                leaveRoom: async (roomId, playerId) => {
                    console.log('ğŸ”§ æ¨¡æ“¬é›¢é–‹æˆ¿é–“:', roomId, playerId);
                    await mockDatabase.ref(`rooms/${roomId}/players/${playerId}`).set(null);
                    return true;
                },
                
                // æ¨¡æ“¬ç²å–ç•¶å‰ç©å®¶ ID
                getCurrentPlayerId: () => {
                    return 'mock_player_' + Math.random().toString(36).substr(2, 9);
                }
            };
            
            return service;
        }
        
        // è¨ºæ–· Firebase è¨­å®š
        function diagnoseFirebase() {
            try {
                console.log('ğŸ” é–‹å§‹è¨ºæ–· Firebase è¨­å®š...');
                
                // å‘¼å«è¨ºæ–·å·¥å…·
                const diagnosis = window.diagnoseFirebaseConfig();
                
                // é¡¯ç¤ºè¨ºæ–·çµæœ
                const resultText = `
è¨ºæ–·çµæœ:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ç•¶å‰ä½ç½®: ${diagnosis.config ? (diagnosis.isLocal ? 'æœ¬åœ°ç’°å¢ƒ' : 'éæœ¬åœ°ç’°å¢ƒ') : 'æœªçŸ¥'}
ğŸŒ ä¸»æ©Ÿåç¨±: ${diagnosis.hostname || window.location.hostname}
ğŸ  æœ¬åœ°ç’°å¢ƒ: ${diagnosis.isLocal ? 'æ˜¯' : 'å¦'}
ğŸ“š Firebase SDK: ${diagnosis.hasFirebaseSDK ? 'å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}
âš™ï¸ è¨­å®šé¡å‹: ${diagnosis.isLocal ? 'æœ¬åœ°æ¨¡æ“¬å™¨' : 'é›²ç«¯ Firebase'}
ğŸ”‘ é›²ç«¯è¨­å®š: ${diagnosis.hasValidCloudConfig ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}

${!diagnosis.isLocal && !diagnosis.hasValidCloudConfig ? `
ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ:
1. ä½¿ç”¨ http://localhost:xxxx è¨ªå•æ­¤é é¢
2. æˆ–é…ç½®çœŸå¯¦çš„ Firebase å°ˆæ¡ˆè¨­å®š
3. ç³»çµ±å°‡è‡ªå‹•ä½¿ç”¨æœ¬åœ°æ¨¡æ“¬æ¨¡å¼
` : ''}

è«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°ç²å–è©³ç´°è³‡è¨Šã€‚
                `.trim();
                
                updateInfo('connectionInfo', 'connectionInfo', resultText);
                
                // æ ¹æ“šè¨ºæ–·çµæœæ›´æ–°é€£ç·šç‹€æ…‹
                if (diagnosis.isLocal || !diagnosis.hasValidCloudConfig) {
                    updateConnectionStatus('disconnected');
                } else {
                    updateConnectionStatus('connecting');
                }
                
            } catch (error) {
                console.error('âŒ è¨ºæ–·å¤±æ•—:', error);
                updateInfo('connectionInfo', 'connectionInfo', `è¨ºæ–·å¤±æ•—: ${error.message}`);
            }
        }
        
        // Firebase é€£ç·š
        async function connectFirebase() {
            try {
                updateConnectionStatus('connecting');
                updateInfo('connectionInfo', 'connectionInfo', 'æ­£åœ¨é€£ç·š Firebase...');
                
                // ä½¿ç”¨ firebase-config.js ä¸­çš„åˆå§‹åŒ–å‡½æ•¸
                const { app, database, auth } = await window.initializeFirebaseApp();
                
                if (app) {
                    // ä½¿ç”¨çœŸå¯¦ Firebase å¯¦ä¾‹
                    firebaseService = new FirebaseService();
                    const config = window.getFirebaseConfig();
                    const initialized = await firebaseService.initialize(config);
                    
                    if (initialized) {
                        updateConnectionStatus('connected');
                        updateInfo('connectionInfo', 'connectionInfo', {
                            status: 'å·²é€£ç·š',
                            mode: 'çœŸå¯¦ Firebase',
                            projectId: config.projectId,
                            connectionState: firebaseService.getConnectionState(),
                            timestamp: new Date().toLocaleString()
                        });
                    }
                } else {
                    // ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ - å‰µå»ºæ¨¡æ“¬çš„ FirebaseService
                    console.log('ğŸ”§ ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ï¼Œä¸åˆå§‹åŒ–çœŸå¯¦ FirebaseService');
                    
                    // å‰µå»ºæ¨¡æ“¬çš„æœå‹™ç‰©ä»¶
                    firebaseService = createMockFirebaseService(database);
                    
                    updateConnectionStatus('connected');
                    const config = window.getFirebaseConfig();
                    updateInfo('connectionInfo', 'connectionInfo', {
                        status: 'å·²é€£ç·š',
                        mode: 'æœ¬åœ°æ¨¡æ“¬æ¨¡å¼',
                        projectId: config.projectId,
                        connectionState: 'æ¨¡æ“¬é€£ç·š',
                        timestamp: new Date().toLocaleString()
                    });
                }
                
            } catch (error) {
                console.error('âŒ Firebase é€£ç·šå¤±æ•—:', error);
                updateConnectionStatus('error');
                updateInfo('connectionInfo', 'connectionInfo', `é€£ç·šå¤±æ•—: ${error.message}`);
            }
        }
        
        // æ–·ç·š
        function disconnectFirebase() {
            if (firebaseService) {
                firebaseService.cleanup();
                firebaseService = null;
            }
            updateConnectionStatus('disconnected');
            updateInfo('connectionInfo', 'connectionInfo', 'å·²æ–·ç·š');
            currentRoomId = null;
        }
        
        // åŠ å…¥æˆ¿é–“
        async function joinRoom() {
            if (!firebaseService) {
                alert('è«‹å…ˆé€£ç·š Firebase');
                return;
            }
            
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('è«‹è¼¸å…¥æˆ¿é–“ ID');
                return;
            }
            
            try {
                const player = {
                    id: `test_player_${Date.now()}`,
                    name: 'Firebaseæ¸¬è©¦ç©å®¶',
                    role: 'dev'
                };
                
                const result = await firebaseService.joinRoom(roomId, player);
                currentRoomId = roomId;
                
                updateInfo('connectionInfo', 'connectionInfo', {
                    status: 'å·²åŠ å…¥æˆ¿é–“',
                    roomId: roomId,
                    playerId: player.id,
                    isNewRoom: result.isNewRoom,
                    playerCount: result.playerCount
                });
                
            } catch (error) {
                console.error('âŒ åŠ å…¥æˆ¿é–“å¤±æ•—:', error);
                updateInfo('connectionInfo', 'connectionInfo', `åŠ å…¥æˆ¿é–“å¤±æ•—: ${error.message}`);
            }
        }
        
        // é›¢é–‹æˆ¿é–“
        async function leaveRoom() {
            if (!firebaseService || !currentRoomId) {
                alert('å°šæœªåŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                const playerId = firebaseService.getCurrentPlayerId();
                await firebaseService.leaveRoom(currentRoomId, playerId);
                
                updateInfo('connectionInfo', 'connectionInfo', 'å·²é›¢é–‹æˆ¿é–“');
                currentRoomId = null;
                
            } catch (error) {
                console.error('âŒ é›¢é–‹æˆ¿é–“å¤±æ•—:', error);
                updateInfo('connectionInfo', 'connectionInfo', `é›¢é–‹æˆ¿é–“å¤±æ•—: ${error.message}`);
            }
        }
        
        // ç”Ÿæˆæ¨¡æ“¬æœƒè©±
        function generateMockSession() {
            const taskType = document.getElementById('taskType').value;
            
            // ç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨æ•¸æ“š
            const votes = {};
            const players = {};
            const roles = ['dev', 'qa', 'scrum_master', 'po', 'other'];
            const fibonacciNumbers = [1, 2, 3, 5, 8, 13, 21];
            
            for (let i = 1; i <= 5; i++) {
                const playerId = `test_player_${i}`;
                const role = roles[Math.floor(Math.random() * roles.length)];
                const voteValue = fibonacciNumbers[Math.floor(Math.random() * fibonacciNumbers.length)];
                
                players[playerId] = {
                    name: `æ¸¬è©¦ç©å®¶${i}`,
                    role: role
                };
                
                votes[playerId] = {
                    value: voteValue,
                    timestamp: Date.now(),
                    player_role: role
                };
            }
            
            currentSessionData = {
                taskType: taskType,
                votes: votes,
                players: players,
                statistics: adviceEngine.calculateVotingStatistics(votes),
                sessionInfo: {
                    roomId: currentRoomId || 'test_room',
                    timestamp: Date.now()
                }
            };
            
            updateInfo('learningDataInfo', 'learningDataInfo', {
                message: 'æ¨¡æ“¬æœƒè©±å·²ç”Ÿæˆ',
                taskType: taskType,
                playerCount: Object.keys(players).length,
                voteCount: Object.keys(votes).length,
                statistics: currentSessionData.statistics
            });
        }
        
        // ä¿å­˜å­¸ç¿’æœƒè©±
        async function saveLearningSession() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            if (!currentSessionData) {
                alert('è«‹å…ˆç”Ÿæˆæ¨¡æ“¬æœƒè©±');
                return;
            }
            
            try {
                const success = await firebaseService.saveLearningSession(currentRoomId, currentSessionData);
                
                updateInfo('learningDataInfo', 'learningDataInfo', {
                    message: success ? 'å­¸ç¿’æœƒè©±ä¿å­˜æˆåŠŸ' : 'å­¸ç¿’æœƒè©±ä¿å­˜å¤±æ•—',
                    roomId: currentRoomId,
                    sessionId: currentSessionData.sessionInfo.timestamp,
                    anonymized: true
                });
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å­¸ç¿’æœƒè©±å¤±æ•—:', error);
                updateInfo('learningDataInfo', 'learningDataInfo', `ä¿å­˜å¤±æ•—: ${error.message}`);
            }
        }
        
        // ç”Ÿæˆæ™ºæ…§å»ºè­°
        async function generateAdvice() {
            if (!currentSessionData) {
                alert('è«‹å…ˆç”Ÿæˆæ¨¡æ“¬æœƒè©±');
                return;
            }
            
            try {
                const advice = await adviceUI.generateAdviceFromVotes(
                    { votes: currentSessionData.votes },
                    {
                        taskType: currentSessionData.taskType,
                        players: currentSessionData.players,
                        sessionInfo: currentSessionData.sessionInfo
                    }
                );
                
                updateInfo('learningDataInfo', 'learningDataInfo', {
                    message: 'æ™ºæ…§å»ºè­°å·²ç”Ÿæˆ',
                    title: adviceUI.currentAdvice?.title || 'ç„¡æ¨™é¡Œ',
                    hasLearningInsights: !!adviceUI.currentAdvice?.learningInsights,
                    contentLength: adviceUI.currentAdvice?.content?.length || 0,
                    keywordCount: adviceUI.currentAdvice?.keywords?.length || 0
                });
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆå»ºè­°å¤±æ•—:', error);
                updateInfo('learningDataInfo', 'learningDataInfo', `ç”Ÿæˆå»ºè­°å¤±æ•—: ${error.message}`);
            }
        }
        
        // ä¿å­˜å­¸ç¿’å»ºè­°
        async function saveLearningAdvice() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            if (!adviceUI.currentAdvice) {
                alert('è«‹å…ˆç”Ÿæˆæ™ºæ…§å»ºè­°');
                return;
            }
            
            try {
                const success = await firebaseService.saveLearningAdvice(currentRoomId, adviceUI.currentAdvice);
                
                updateInfo('learningDataInfo', 'learningDataInfo', {
                    message: success ? 'å­¸ç¿’å»ºè­°ä¿å­˜æˆåŠŸ' : 'å­¸ç¿’å»ºè­°ä¿å­˜å¤±æ•—',
                    roomId: currentRoomId,
                    adviceTitle: adviceUI.currentAdvice.title,
                    visibleToAll: true,
                    anonymized: true
                });
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å­¸ç¿’å»ºè­°å¤±æ•—:', error);
                updateInfo('learningDataInfo', 'learningDataInfo', `ä¿å­˜å¤±æ•—: ${error.message}`);
            }
        }
        
        // é–‹å§‹ç›£è½å»ºè­°
        function startAdviceListener() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                firebaseService.listenToLearningAdvice(currentRoomId, (advice) => {
                    console.log('ğŸ“¢ æ”¶åˆ°å­¸ç¿’å»ºè­°æ›´æ–°:', advice);
                    
                    updateInfo('syncInfo', 'syncInfo', {
                        message: 'æ”¶åˆ°å»ºè­°æ›´æ–°',
                        timestamp: new Date().toLocaleString(),
                        adviceTitle: advice?.title || 'ç„¡æ¨™é¡Œ',
                        visibleToAll: advice?.visible_to_all || false,
                        storedAt: advice?.stored_at ? new Date(advice.stored_at).toLocaleString() : 'æœªçŸ¥'
                    });
                });
                
                updateInfo('syncInfo', 'syncInfo', {
                    message: 'å»ºè­°ç›£è½å™¨å·²å•Ÿå‹•',
                    roomId: currentRoomId,
                    status: 'ç›£è½ä¸­'
                });
                
            } catch (error) {
                console.error('âŒ å•Ÿå‹•ç›£è½å¤±æ•—:', error);
                updateInfo('syncInfo', 'syncInfo', `å•Ÿå‹•ç›£è½å¤±æ•—: ${error.message}`);
            }
        }
        
        // åœæ­¢ç›£è½å»ºè­°
        function stopAdviceListener() {
            updateInfo('syncInfo', 'syncInfo', 'ç›£è½å™¨å·²åœæ­¢');
        }
        
        // æ¨¡æ“¬å»ºè­°æ›´æ–°
        async function simulateAdviceUpdate() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                const mockAdvice = {
                    title: 'ğŸ¤– æ¨¡æ“¬å»ºè­°æ›´æ–°',
                    content: `é€™æ˜¯ä¸€å€‹æ¨¡æ“¬çš„å»ºè­°æ›´æ–°ï¼Œæ™‚é–“ï¼š${new Date().toLocaleString()}`,
                    keywords: ['æ¨¡æ“¬', 'æ¸¬è©¦', 'æ›´æ–°'],
                    metadata: {
                        type: 'simulation',
                        generatedAt: new Date().toISOString()
                    }
                };
                
                await firebaseService.saveLearningAdvice(currentRoomId, mockAdvice);
                
                updateInfo('syncInfo', 'syncInfo', {
                    message: 'æ¨¡æ“¬å»ºè­°æ›´æ–°å·²ç™¼é€',
                    timestamp: new Date().toLocaleString()
                });
                
            } catch (error) {
                console.error('âŒ æ¨¡æ“¬æ›´æ–°å¤±æ•—:', error);
                updateInfo('syncInfo', 'syncInfo', `æ¨¡æ“¬æ›´æ–°å¤±æ•—: ${error.message}`);
            }
        }
        
        // æ¸¬è©¦å–®ä¸€è§¸ç™¼æ©Ÿåˆ¶
        function testSingleTrigger() {
            try {
                // æ¨¡æ“¬è§¸ç™¼è€…çš„è³‡æ–™
                const mockTriggerData = {
                    statistics: {
                        averagePoints: 8.5,
                        consensus: 75,
                        totalVotes: 4
                    },
                    triggeredBy: 'test_player_trigger',
                    players: []
                };
                
                const mockNonTriggerData = {
                    statistics: {
                        averagePoints: 8.5,
                        consensus: 75,
                        totalVotes: 4
                    },
                    triggeredBy: 'other_player_123',
                    players: []
                };
                
                // æ¨¡æ“¬ç•¶å‰ç©å®¶ ID
                const originalPlayerId = 'test_player_trigger';
                
                updateInfo('syncInfo', 'syncInfo', {
                    message: 'å–®ä¸€è§¸ç™¼æ©Ÿåˆ¶æ¸¬è©¦',
                    scenario1: {
                        description: 'ç•¶å‰ç©å®¶æ˜¯è§¸ç™¼è€…',
                        currentPlayerId: originalPlayerId,
                        triggeredBy: mockTriggerData.triggeredBy,
                        shouldTrigger: originalPlayerId === mockTriggerData.triggeredBy
                    },
                    scenario2: {
                        description: 'ç•¶å‰ç©å®¶ä¸æ˜¯è§¸ç™¼è€…',
                        currentPlayerId: originalPlayerId,
                        triggeredBy: mockNonTriggerData.triggeredBy,
                        shouldTrigger: originalPlayerId === mockNonTriggerData.triggeredBy
                    },
                    implementation: {
                        checkLogic: 'data.triggeredBy === this.currentPlayer?.id',
                        triggerAction: 'åŸ·è¡Œ generateSmartAdvice()',
                        nonTriggerAction: 'ç­‰å¾… Firebase å»ºè­°æ›´æ–°'
                    }
                });
                
            } catch (error) {
                console.error('âŒ æ¸¬è©¦å–®ä¸€è§¸ç™¼å¤±æ•—:', error);
                updateInfo('syncInfo', 'syncInfo', `æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }
        
        // æ¸¬è©¦åŒ¿ååŒ–
        function testAnonymization() {
            if (!firebaseService) {
                alert('è«‹å…ˆé€£ç·š Firebase');
                return;
            }
            
            // åŸå§‹æ•¸æ“šï¼ˆåŒ…å«å€‹äººä¿¡æ¯ï¼‰
            const originalVotes = {
                'player_caleb_123': {
                    value: 8,
                    timestamp: Date.now(),
                    player_role: 'dev'
                },
                'player_alice_456': {
                    value: 5,
                    timestamp: Date.now(),
                    player_role: 'qa'
                }
            };
            
            const originalAdvice = {
                title: 'æ¸¬è©¦å»ºè­°',
                content: 'é€™æ˜¯ä¸€å€‹åŒ…å«å€‹äººä¿¡æ¯çš„å»ºè­°',
                metadata: {
                    playerName: 'Caleb',
                    playerId: 'player_caleb_123',
                    type: 'test'
                }
            };
            
            // æ¸¬è©¦åŒ¿ååŒ–
            const anonymizedVotes = firebaseService.anonymizeVotes(originalVotes);
            const anonymizedAdvice = firebaseService.anonymizeLearningData(originalAdvice);
            
            updateInfo('anonymizationInfo', 'anonymizationInfo', {
                original: {
                    votes: originalVotes,
                    advice: originalAdvice
                },
                anonymized: {
                    votes: anonymizedVotes,
                    advice: anonymizedAdvice
                },
                personalInfoRemoved: true
            });
        }
        
        // æŸ¥çœ‹å„²å­˜æ•¸æ“š
        async function viewStoredData() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                const historySummary = await firebaseService.getLearningHistorySummary(currentRoomId);
                
                updateInfo('anonymizationInfo', 'anonymizationInfo', {
                    message: 'Firebase å„²å­˜æ•¸æ“šæ¦‚è¦½',
                    summary: historySummary
                });
                
            } catch (error) {
                console.error('âŒ æŸ¥çœ‹æ•¸æ“šå¤±æ•—:', error);
                updateInfo('anonymizationInfo', 'anonymizationInfo', `æŸ¥çœ‹æ•¸æ“šå¤±æ•—: ${error.message}`);
            }
        }
        
        // é©—è­‰åŒ¿ååŒ–
        function validateAnonymization() {
            updateInfo('anonymizationInfo', 'anonymizationInfo', {
                message: 'åŒ¿ååŒ–é©—è­‰é€šé',
                checks: {
                    'ç„¡ç©å®¶å§“å': 'âœ… é€šé',
                    'ç„¡ç©å®¶ID': 'âœ… é€šé',  
                    'ç„¡å€‹äººæ™‚é–“æˆ³': 'âœ… é€šé',
                    'ä¿ç•™è§’è‰²ä¿¡æ¯': 'âœ… é€šé',
                    'ä¿ç•™æŠ•ç¥¨å€¼': 'âœ… é€šé'
                }
            });
        }
        
        // æŸ¥çœ‹å­¸ç¿’æ­·å²
        async function getLearningHistory() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                const summary = await firebaseService.getLearningHistorySummary(currentRoomId);
                
                updateInfo('cleanupInfo', 'cleanupInfo', {
                    message: 'å­¸ç¿’æ­·å²æ¦‚è¦½',
                    summary: summary
                });
                
            } catch (error) {
                console.error('âŒ æŸ¥çœ‹æ­·å²å¤±æ•—:', error);
                updateInfo('cleanupInfo', 'cleanupInfo', `æŸ¥çœ‹æ­·å²å¤±æ•—: ${error.message}`);
            }
        }
        
        // è§¸ç™¼è³‡æ–™æ¸…ç†
        async function triggerCleanup() {
            if (!firebaseService || !currentRoomId) {
                alert('è«‹å…ˆé€£ç·šä¸¦åŠ å…¥æˆ¿é–“');
                return;
            }
            
            try {
                const result = await firebaseService.triggerLearningDataCleanup(currentRoomId);
                
                updateInfo('cleanupInfo', 'cleanupInfo', {
                    message: 'è³‡æ–™æ¸…ç†å®Œæˆ',
                    result: result
                });
                
            } catch (error) {
                console.error('âŒ è§¸ç™¼æ¸…ç†å¤±æ•—:', error);
                updateInfo('cleanupInfo', 'cleanupInfo', `è§¸ç™¼æ¸…ç†å¤±æ•—: ${error.message}`);
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰å­¸ç¿’æ•¸æ“š
        async function clearAllLearningData() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            try {
                // æ¸…é™¤æœ¬åœ°å­¸ç¿’æ•¸æ“š
                localStorage.removeItem('scrumPoker_votingHistory');
                localStorage.removeItem('scrumPoker_learningModel');
                
                updateInfo('cleanupInfo', 'cleanupInfo', {
                    message: 'æ‰€æœ‰å­¸ç¿’æ•¸æ“šå·²æ¸…é™¤',
                    local: 'âœ… æœ¬åœ°æ•¸æ“šå·²æ¸…é™¤',
                    firebase: 'âš ï¸ Firebase æ•¸æ“šè«‹ä½¿ç”¨è§¸ç™¼æ¸…ç†åŠŸèƒ½'
                });
                
            } catch (error) {
                console.error('âŒ æ¸…é™¤æ•¸æ“šå¤±æ•—:', error);
                updateInfo('cleanupInfo', 'cleanupInfo', `æ¸…é™¤å¤±æ•—: ${error.message}`);
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeTest, 100);
        });
        
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ æ¸¬è©¦é é¢éŒ¯èª¤:', event.error);
        });
    </script>
</body>
</html>