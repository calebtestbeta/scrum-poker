<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Poker - 重定向中...</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .loading-container {
            max-width: 400px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        h1 {
            margin: 0 0 10px;
            font-size: 24px;
            font-weight: 600;
        }

        p {
            margin: 0;
            opacity: 0.8;
        }

        .debug-info {
            margin-top: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="loading-container">
        <div class="spinner"></div>
        <h1>Scrum Poker</h1>
        <p>正在為您選擇最適合的界面...</p>

        <div class="debug-info" id="debugInfo">
            <div>檢測設備類型中...</div>
        </div>
    </div>

    <script>
        // 設備檢測與重定向邏輯
        class DeviceRedirector {
            constructor() {
                this.debugElement = document.getElementById('debugInfo');
                this.init();
            }

            init() {
                this.logDebug('開始設備檢測...');

                // 取得當前 URL 參數
                const urlParams = new URLSearchParams(window.location.search);
                const queryString = urlParams.toString();
                this.logDebug(`URL 參數: ${queryString || '無'}`);

                // 檢查強制模式參數
                const forcedMode = urlParams.get('mode');
                if (forcedMode === 'desktop' || forcedMode === 'mobile') {
                    this.logDebug(`偵測模式被強制設定為: ${forcedMode}`);
                    this.logDebug(`最終判斷: ${forcedMode}`);
                    this.redirect(forcedMode, queryString);
                    return;
                }

                // 檢測設備類型
                const deviceType = this.detectDevice();
                this.logDebug(`最終判斷: ${deviceType}`);
                this.redirect(deviceType, queryString);
            }

            detectDevice() {
                const userAgent = navigator.userAgent.toLowerCase();
                const platform = navigator.platform || 'unknown';
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const devicePixelRatio = window.devicePixelRatio || 1;

                this.logDebug(`螢幕尺寸: ${screenWidth}x${screenHeight}`);
                this.logDebug(`像素比: ${devicePixelRatio}`);
                this.logDebug(`平台: ${platform}`);
                this.logDebug(`視窗尺寸: ${window.innerWidth}x${window.innerHeight}`);
                this.logDebug(`User Agent: ${userAgent.substring(0, 100)}...`);

                // 桌面平台檢測 (最高優先級)
                const desktopPlatforms = ['MacIntel', 'Win32', 'Win64', 'Linux x86_64', 'Linux i686'];
                const isDesktopPlatform = desktopPlatforms.some(p => platform.includes(p));

                // 檢測行動裝置的多種方式
                const mobileKeywords = [
                    'android', 'iphone', 'ipad', 'ipod', 'blackberry',
                    'windows phone', 'mobile', 'webos', 'opera mini'
                ];

                const isMobileUA = mobileKeywords.some(keyword =>
                    userAgent.includes(keyword)
                );

                // 螢幕尺寸檢測 (考慮像素比)
                const actualWidth = screenWidth / devicePixelRatio;
                const actualHeight = screenHeight / devicePixelRatio;
                const isMobileScreen = Math.min(actualWidth, actualHeight) < 768;

                // 改進的觸控檢測 - 排除觸控板干擾
                const maxTouchPoints = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
                const hasOnTouchStart = 'ontouchstart' in window;
                
                // 更嚴格的觸控判斷：需要多點觸控且明確支援觸控事件
                const hasTouchSupport = (maxTouchPoints > 1) && hasOnTouchStart;
                
                // 視窗尺寸檢測
                const isMobileViewport = window.innerWidth < 768;

                this.logDebug(`桌面平台: ${isDesktopPlatform}`);
                this.logDebug(`UA 檢測: ${isMobileUA}`);
                this.logDebug(`螢幕檢測: ${isMobileScreen}`);
                this.logDebug(`觸控點數: ${maxTouchPoints}`);
                this.logDebug(`觸控事件: ${hasOnTouchStart}`);
                this.logDebug(`觸控支援: ${hasTouchSupport}`);
                this.logDebug(`視窗檢測: ${isMobileViewport}`);

                // 改良的綜合判斷邏輯 - 平台檢測優先
                // 1. 最高優先級：桌面平台 + 大螢幕 + 非mobile UA
                const strongDesktop = isDesktopPlatform && 
                                     window.innerWidth >= 1024 && 
                                     !isMobileUA;

                // 2. 強制桌面條件：桌面平台 + 無真正觸控 + 非mobile UA
                const forceDesktop = isDesktopPlatform && 
                                   !hasTouchSupport && 
                                   !isMobileUA;

                // 3. 明確的行動裝置條件
                const isClearlyMobile = isMobileUA || 
                                      (!isDesktopPlatform && hasTouchSupport && isMobileScreen) ||
                                      (!isDesktopPlatform && hasTouchSupport && isMobileViewport);

                this.logDebug(`強桌面條件: ${strongDesktop}`);
                this.logDebug(`強制桌面條件: ${forceDesktop}`);
                this.logDebug(`明確行動裝置: ${isClearlyMobile}`);

                // 最終判斷 - 優先級順序
                if (strongDesktop) {
                    this.logDebug(`判斷依據: 桌面平台 + 大螢幕 + 非行動UA`);
                    return 'desktop';
                } else if (forceDesktop) {
                    this.logDebug(`判斷依據: 桌面平台 + 無觸控 + 非行動UA`);
                    return 'desktop';
                } else if (isClearlyMobile) {
                    this.logDebug(`判斷依據: 明確行動裝置特徵`);
                    return 'mobile';
                } else {
                    // 邊界情況：根據螢幕寬度和平台決定
                    const fallbackDesktop = (window.innerWidth >= 1024) || isDesktopPlatform;
                    this.logDebug(`判斷依據: 邊界情況 - 螢幕寬度或平台`);
                    return fallbackDesktop ? 'desktop' : 'mobile';
                }
            }

            redirect(deviceType, queryString) {
                // 建構目標 URL - 修復 GitHub Pages 子路徑問題
                const targetPath = deviceType === 'mobile' ? '/mobile/' : '/desktop/';
                
                // 檢測是否為 GitHub Pages 子目錄部署
                const currentPath = window.location.pathname;
                const basePath = currentPath.includes('/scrum-poker/') ? '/scrum-poker' : '';
                
                const targetUrl = `${window.location.origin}${basePath}/public${targetPath}${queryString ? '?' + queryString : ''}`;

                this.logDebug(`當前路徑: ${currentPath}`);
                this.logDebug(`基礎路徑: ${basePath}`);
                this.logDebug(`重定向至: ${targetUrl}`);

                // 延遲重定向，讓使用者看到載入過程
                setTimeout(() => {
                    window.location.href = targetUrl;
                }, 1500);
            }

            logDebug(message) {
                const timestamp = new Date().toLocaleTimeString();
                const debugLine = document.createElement('div');
                debugLine.textContent = `[${timestamp}] ${message}`;
                this.debugElement.appendChild(debugLine);

                // 自動滾動到底部
                this.debugElement.scrollTop = this.debugElement.scrollHeight;

                // 也記錄到 console
                console.log(`[DeviceRedirector] ${message}`);
            }
        }

        // 頁面載入完成後啟動重定向器
        document.addEventListener('DOMContentLoaded', () => {
            new DeviceRedirector();
        });

        // 錯誤處理
        window.addEventListener('error', (event) => {
            console.error('重定向過程中發生錯誤:', event.error);
            
            // 修復 fallback 連結路徑
            const currentPath = window.location.pathname;
            const basePath = currentPath.includes('/scrum-poker/') ? '/scrum-poker' : '';
            
            document.body.innerHTML = `
                <div class="loading-container">
                    <h1>載入錯誤</h1>
                    <p>請手動選擇界面:</p>
                    <div style="margin-top: 20px;">
                        <a href="${basePath}/public/desktop/" style="color: white; margin: 0 10px; text-decoration: underline;">桌面版</a>
                        <a href="${basePath}/public/mobile/" style="color: white; margin: 0 10px; text-decoration: underline;">行動版</a>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.7;">
                        當前路徑: ${currentPath}<br>
                        基礎路徑: ${basePath}
                    </div>
                </div>
            `;
        });
    </script>
</body>

</html>