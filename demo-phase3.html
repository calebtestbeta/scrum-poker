<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrumAdviceEngine Phase 3 UI 整合演示</title>
    <link rel="stylesheet" href="src/styles/variables.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-game);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .demo-header h1 {
            color: var(--text-inverse);
            margin-bottom: 10px;
        }
        
        .demo-section {
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .demo-section h2 {
            color: var(--text-inverse);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .demo-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: 14px;
        }
        
        .control-group input,
        .control-group select,
        .control-group button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-inverse);
            font-size: 14px;
        }
        
        .control-group button {
            background: var(--color-primary);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .control-group button:hover {
            background: var(--color-primary-dark);
        }
        
        .mock-right-rail {
            width: 280px;
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 35, 42, 0.95);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .info-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid var(--color-primary);
        }
        
        .info-display h4 {
            color: var(--text-inverse);
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .info-display pre {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        @media (max-width: 1024px) {
            .mock-right-rail {
                position: relative;
                width: 100%;
                top: 0;
                right: 0;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>🧠 ScrumAdviceEngine Phase 3</h1>
            <p style="color: rgba(255, 255, 255, 0.8);">UI 整合演示與測試</p>
        </div>
        
        <!-- 模擬投票生成區域 -->
        <div class="demo-section">
            <h2>🎯 模擬投票生成</h2>
            <div class="demo-controls">
                <div class="control-group">
                    <label>任務類型</label>
                    <select id="mockTaskType">
                        <option value="frontend">前端開發</option>
                        <option value="backend">後端開發</option>
                        <option value="testing">測試相關</option>
                        <option value="fullstack">全端開發</option>
                        <option value="devops">DevOps</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>投票人數</label>
                    <input type="number" id="mockPlayerCount" value="5" min="2" max="10">
                </div>
                
                <div class="control-group">
                    <label>估點範圍</label>
                    <select id="mockPointRange">
                        <option value="low">低估點 (1-5)</option>
                        <option value="medium">中等估點 (3-13)</option>
                        <option value="high">高估點 (8-21)</option>
                        <option value="mixed">混合範圍 (1-21)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>分歧程度</label>
                    <select id="mockVariance">
                        <option value="low">低分歧 (一致)</option>
                        <option value="medium">中等分歧</option>
                        <option value="high">高分歧 (爭議)</option>
                    </select>
                </div>
            </div>
            
            <div class="demo-controls">
                <div class="control-group">
                    <button id="generateMockVotes">🎲 生成模擬投票</button>
                </div>
                
                <div class="control-group">
                    <button id="triggerAdviceGeneration">🧠 生成智慧建議</button>
                </div>
                
                <div class="control-group">
                    <button id="showAdviceModal">📋 顯示建議彈窗</button>
                </div>
                
                <div class="control-group">
                    <button id="resetDemo">🔄 重置演示</button>
                </div>
            </div>
            
            <div class="info-display" id="mockVoteDisplay">
                <h4>🗳️ 模擬投票結果</h4>
                <pre>點擊「生成模擬投票」開始演示</pre>
            </div>
        </div>
        
        <!-- UI 狀態監控 -->
        <div class="demo-section">
            <h2>📊 UI 狀態監控</h2>
            <div class="info-display" id="uiStatusDisplay">
                <h4>🎨 ScrumAdviceUI 狀態</h4>
                <pre>正在初始化...</pre>
            </div>
        </div>
    </div>
    
    <!-- 模擬右側面板 -->
    <div class="mock-right-rail">
        <!-- 統計面板 -->
        <div class="stats-panel" id="statsPanel" aria-label="遊戲統計">
            <h3 class="text-inverse font-bold mb-4">📊 估點統計</h3>
            <div class="stats-content" id="statsContent">
                <p class="text-muted">等待遊戲開始...</p>
            </div>
            
            <!-- 智慧建議區域 -->
            <div class="smart-advice-section hidden" id="smartAdviceSection">
                <h4 class="text-inverse font-medium mb-2">🧠 智慧建議</h4>
                <div class="advice-preview" id="advicePreview">
                    <p class="text-muted">點擊「開牌」後查看建議</p>
                </div>
                <button class="btn btn-sm btn-ghost mt-2" id="showFullAdviceBtn">
                    📋 查看完整建議
                </button>
            </div>
        </div>
    </div>
    
    <!-- 智慧建議對話框 -->
    <div class="modal-backdrop hidden" id="adviceModal" role="dialog" aria-modal="true">
        <div class="modal modal-advice">
            <div class="modal-header">
                <h3 id="adviceModalTitle">🧠 智慧估點建議</h3>
                <button class="btn btn-sm btn-ghost" id="adviceModalClose" aria-label="關閉">✕</button>
            </div>
            <div class="modal-body" id="adviceContent">
                <!-- 建議內容動態生成在這裡 -->
                <div class="advice-loading hidden" id="adviceLoading">
                    <div class="loading-spinner"></div>
                    <p>正在分析投票結果...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="adviceTestBtn">🧪 測試模式</button>
                <button class="btn btn-primary" id="adviceCloseBtn">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- 載入腳本 -->
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>
    
    <script>
        // Phase 3 演示腳本
        let adviceUI = null;
        let currentMockData = null;
        
        // 初始化演示
        async function initializeDemo() {
            console.log('🎬 初始化 Phase 3 演示...');
            
            try {
                // 初始化 ScrumAdviceUI
                adviceUI = new ScrumAdviceUI();
                await adviceUI.initialize();
                
                console.log('✅ ScrumAdviceUI 初始化成功');
                updateUIStatus();
                
                // 設定事件監聽
                setupDemoEventListeners();
                
            } catch (error) {
                console.error('❌ 演示初始化失敗:', error);
                updateUIStatus(error);
            }
        }
        
        // 設定演示事件監聽
        function setupDemoEventListeners() {
            document.getElementById('generateMockVotes').addEventListener('click', generateMockVotes);
            document.getElementById('triggerAdviceGeneration').addEventListener('click', triggerAdviceGeneration);
            document.getElementById('showAdviceModal').addEventListener('click', showAdviceModal);
            document.getElementById('resetDemo').addEventListener('click', resetDemo);
        }
        
        // 生成模擬投票
        function generateMockVotes() {
            const taskType = document.getElementById('mockTaskType').value;
            const playerCount = parseInt(document.getElementById('mockPlayerCount').value);
            const pointRange = document.getElementById('mockPointRange').value;
            const variance = document.getElementById('mockVariance').value;
            
            // 生成玩家和投票
            const players = generateMockPlayers(playerCount);
            const votes = generateMockVotesData(players, pointRange, variance);
            
            currentMockData = {
                taskType,
                players,
                votes: { votes }
            };
            
            // 顯示模擬資料
            displayMockVoteData(currentMockData);
            
            // 更新統計面板
            updateStatsPanel(currentMockData.votes);
        }
        
        // 生成模擬玩家
        function generateMockPlayers(count) {
            const roles = ['dev', 'dev', 'qa', 'scrum_master', 'po', 'other'];
            const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
            
            const players = {};
            for (let i = 0; i < count; i++) {
                const playerId = `player_${i + 1}`;
                players[playerId] = {
                    name: names[i % names.length],
                    role: roles[i % roles.length]
                };
            }
            
            return players;
        }
        
        // 生成模擬投票資料
        function generateMockVotesData(players, pointRange, variance) {
            const ranges = {
                low: [1, 2, 3, 5],
                medium: [3, 5, 8, 13],
                high: [8, 13, 21],
                mixed: [1, 2, 3, 5, 8, 13, 21]
            };
            
            const points = ranges[pointRange];
            const votes = {};
            
            Object.keys(players).forEach((playerId, index) => {
                let value;
                
                if (variance === 'low') {
                    // 低分歧：大家選差不多的值
                    const basePoint = points[Math.floor(points.length / 2)];
                    const nearby = points.filter(p => Math.abs(p - basePoint) <= 2);
                    value = nearby[Math.floor(Math.random() * nearby.length)];
                } else if (variance === 'high') {
                    // 高分歧：選擇極端值
                    value = Math.random() < 0.7 ? 
                        points[Math.floor(Math.random() * 2)] : // 前兩個或後兩個
                        points[points.length - 1 - Math.floor(Math.random() * 2)];
                } else {
                    // 中等分歧：隨機選擇
                    value = points[Math.floor(Math.random() * points.length)];
                }
                
                votes[playerId] = {
                    value,
                    timestamp: Date.now(),
                    player_role: players[playerId].role
                };
            });
            
            return votes;
        }
        
        // 顯示模擬投票資料
        function displayMockVoteData(mockData) {
            const display = document.getElementById('mockVoteDisplay');
            const votesArray = Object.entries(mockData.votes.votes).map(([playerId, vote]) => {
                const player = mockData.players[playerId];
                return `${player.name} (${player.role}): ${vote.value} 點`;
            });
            
            const stats = calculateBasicStats(Object.values(mockData.votes.votes));
            
            display.innerHTML = `
                <h4>🗳️ 模擬投票結果</h4>
                <pre>任務類型: ${mockData.taskType}
玩家數量: ${Object.keys(mockData.players).length}

投票明細:
${votesArray.join('\n')}

基本統計:
• 平均: ${stats.average} 點
• 範圍: ${stats.min} - ${stats.max} 點  
• 共識度: ${stats.consensus}%</pre>
            `;
        }
        
        // 計算基本統計
        function calculateBasicStats(votes) {
            const values = votes.map(v => v.value).filter(v => typeof v === 'number');
            const sum = values.reduce((a, b) => a + b, 0);
            const average = Math.round(sum / values.length * 10) / 10;
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            // 簡化的共識度計算
            const range = max - min;
            const consensus = Math.max(0, Math.round((1 - range / average) * 100));
            
            return { average, min, max, consensus };
        }
        
        // 更新統計面板
        function updateStatsPanel(voteData) {
            const statsContent = document.getElementById('statsContent');
            const stats = calculateBasicStats(Object.values(voteData.votes));
            
            statsContent.innerHTML = `
                <div class="stats-item">
                    <span class="stats-label">平均估點</span>
                    <span class="stats-value">${stats.average}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">估點範圍</span>
                    <span class="stats-value">${stats.min} - ${stats.max}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">投票人數</span>
                    <span class="stats-value">${Object.keys(voteData.votes).length}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">共識度</span>
                    <span class="stats-value">${stats.consensus}%</span>
                </div>
            `;
        }
        
        // 觸發建議生成
        async function triggerAdviceGeneration() {
            if (!currentMockData || !adviceUI) {
                alert('請先生成模擬投票資料');
                return;
            }
            
            console.log('🧠 觸發建議生成...');
            
            try {
                await adviceUI.generateAdviceFromVotes(currentMockData.votes, {
                    taskType: currentMockData.taskType,
                    players: currentMockData.players
                });
                
                updateUIStatus();
                console.log('✅ 建議生成完成');
                
            } catch (error) {
                console.error('❌ 建議生成失敗:', error);
                alert('建議生成失敗: ' + error.message);
            }
        }
        
        // 顯示建議彈窗
        function showAdviceModal() {
            if (!adviceUI || !adviceUI.currentAdvice) {
                alert('請先生成智慧建議');
                return;
            }
            
            adviceUI.showFullAdvice();
        }
        
        // 重置演示
        function resetDemo() {
            currentMockData = null;
            
            if (adviceUI) {
                adviceUI.resetAdvice();
            }
            
            // 重置顯示
            document.getElementById('mockVoteDisplay').innerHTML = `
                <h4>🗳️ 模擬投票結果</h4>
                <pre>點擊「生成模擬投票」開始演示</pre>
            `;
            
            document.getElementById('statsContent').innerHTML = '<p class="text-muted">等待遊戲開始...</p>';
            
            updateUIStatus();
        }
        
        // 更新 UI 狀態顯示
        function updateUIStatus(error = null) {
            const display = document.getElementById('uiStatusDisplay');
            
            if (error) {
                display.innerHTML = `
                    <h4>❌ ScrumAdviceUI 錯誤</h4>
                    <pre>${error.message || error}</pre>
                `;
                return;
            }
            
            if (!adviceUI) {
                display.innerHTML = `
                    <h4>⏳ ScrumAdviceUI 狀態</h4>
                    <pre>尚未初始化</pre>
                `;
                return;
            }
            
            const info = adviceUI.getEngineInfo();
            display.innerHTML = `
                <h4>🎨 ScrumAdviceUI 狀態</h4>
                <pre>版本: ${info.version}
初始化: ${info.initialized ? '✅' : '❌'}
建議引擎: ${info.hasAdviceEngine ? '✅' : '❌'}
當前建議: ${info.hasCurrentAdvice ? '✅' : '❌'}
DOM 元素: ${info.domElementsReady}/11

快捷鍵:
• Ctrl+Shift+A: 顯示建議
• Ctrl+Shift+T: 測試模式
• ESC: 關閉彈窗</pre>
            `;
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeDemo, 100);
        });
        
        // 全域錯誤處理
        window.addEventListener('error', (event) => {
            console.error('🚨 演示頁面錯誤:', event.error);
            updateUIStatus(event.error);
        });
    </script>
</body>
</html>