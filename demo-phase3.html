<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrumAdviceEngine Phase 3 UI æ•´åˆæ¼”ç¤º</title>
    <link rel="stylesheet" href="src/styles/variables.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-game);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .demo-header h1 {
            color: var(--text-inverse);
            margin-bottom: 10px;
        }
        
        .demo-section {
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .demo-section h2 {
            color: var(--text-inverse);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .demo-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: 14px;
        }
        
        .control-group input,
        .control-group select,
        .control-group button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-inverse);
            font-size: 14px;
        }
        
        .control-group button {
            background: var(--color-primary);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .control-group button:hover {
            background: var(--color-primary-dark);
        }
        
        .mock-right-rail {
            width: 280px;
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 35, 42, 0.95);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .info-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid var(--color-primary);
        }
        
        .info-display h4 {
            color: var(--text-inverse);
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .info-display pre {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        @media (max-width: 1024px) {
            .mock-right-rail {
                position: relative;
                width: 100%;
                top: 0;
                right: 0;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>ğŸ§  ScrumAdviceEngine Phase 3</h1>
            <p style="color: rgba(255, 255, 255, 0.8);">UI æ•´åˆæ¼”ç¤ºèˆ‡æ¸¬è©¦</p>
        </div>
        
        <!-- æ¨¡æ“¬æŠ•ç¥¨ç”Ÿæˆå€åŸŸ -->
        <div class="demo-section">
            <h2>ğŸ¯ æ¨¡æ“¬æŠ•ç¥¨ç”Ÿæˆ</h2>
            <div class="demo-controls">
                <div class="control-group">
                    <label>ä»»å‹™é¡å‹</label>
                    <select id="mockTaskType">
                        <option value="frontend">å‰ç«¯é–‹ç™¼</option>
                        <option value="backend">å¾Œç«¯é–‹ç™¼</option>
                        <option value="testing">æ¸¬è©¦ç›¸é—œ</option>
                        <option value="fullstack">å…¨ç«¯é–‹ç™¼</option>
                        <option value="devops">DevOps</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>æŠ•ç¥¨äººæ•¸</label>
                    <input type="number" id="mockPlayerCount" value="5" min="2" max="10">
                </div>
                
                <div class="control-group">
                    <label>ä¼°é»ç¯„åœ</label>
                    <select id="mockPointRange">
                        <option value="low">ä½ä¼°é» (1-5)</option>
                        <option value="medium">ä¸­ç­‰ä¼°é» (3-13)</option>
                        <option value="high">é«˜ä¼°é» (8-21)</option>
                        <option value="mixed">æ··åˆç¯„åœ (1-21)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>åˆ†æ­§ç¨‹åº¦</label>
                    <select id="mockVariance">
                        <option value="low">ä½åˆ†æ­§ (ä¸€è‡´)</option>
                        <option value="medium">ä¸­ç­‰åˆ†æ­§</option>
                        <option value="high">é«˜åˆ†æ­§ (çˆ­è­°)</option>
                    </select>
                </div>
            </div>
            
            <div class="demo-controls">
                <div class="control-group">
                    <button id="generateMockVotes">ğŸ² ç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨</button>
                </div>
                
                <div class="control-group">
                    <button id="triggerAdviceGeneration">ğŸ§  ç”Ÿæˆæ™ºæ…§å»ºè­°</button>
                </div>
                
                <div class="control-group">
                    <button id="showAdviceModal">ğŸ“‹ é¡¯ç¤ºå»ºè­°å½ˆçª—</button>
                </div>
                
                <div class="control-group">
                    <button id="resetDemo">ğŸ”„ é‡ç½®æ¼”ç¤º</button>
                </div>
            </div>
            
            <div class="info-display" id="mockVoteDisplay">
                <h4>ğŸ—³ï¸ æ¨¡æ“¬æŠ•ç¥¨çµæœ</h4>
                <pre>é»æ“Šã€Œç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨ã€é–‹å§‹æ¼”ç¤º</pre>
            </div>
        </div>
        
        <!-- UI ç‹€æ…‹ç›£æ§ -->
        <div class="demo-section">
            <h2>ğŸ“Š UI ç‹€æ…‹ç›£æ§</h2>
            <div class="info-display" id="uiStatusDisplay">
                <h4>ğŸ¨ ScrumAdviceUI ç‹€æ…‹</h4>
                <pre>æ­£åœ¨åˆå§‹åŒ–...</pre>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ“¬å³å´é¢æ¿ -->
    <div class="mock-right-rail">
        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel" id="statsPanel" aria-label="éŠæˆ²çµ±è¨ˆ">
            <h3 class="text-inverse font-bold mb-4">ğŸ“Š ä¼°é»çµ±è¨ˆ</h3>
            <div class="stats-content" id="statsContent">
                <p class="text-muted">ç­‰å¾…éŠæˆ²é–‹å§‹...</p>
            </div>
            
            <!-- æ™ºæ…§å»ºè­°å€åŸŸ -->
            <div class="smart-advice-section hidden" id="smartAdviceSection">
                <h4 class="text-inverse font-medium mb-2">ğŸ§  æ™ºæ…§å»ºè­°</h4>
                <div class="advice-preview" id="advicePreview">
                    <p class="text-muted">é»æ“Šã€Œé–‹ç‰Œã€å¾ŒæŸ¥çœ‹å»ºè­°</p>
                </div>
                <button class="btn btn-sm btn-ghost mt-2" id="showFullAdviceBtn">
                    ğŸ“‹ æŸ¥çœ‹å®Œæ•´å»ºè­°
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ™ºæ…§å»ºè­°å°è©±æ¡† -->
    <div class="modal-backdrop hidden" id="adviceModal" role="dialog" aria-modal="true">
        <div class="modal modal-advice">
            <div class="modal-header">
                <h3 id="adviceModalTitle">ğŸ§  æ™ºæ…§ä¼°é»å»ºè­°</h3>
                <button class="btn btn-sm btn-ghost" id="adviceModalClose" aria-label="é—œé–‰">âœ•</button>
            </div>
            <div class="modal-body" id="adviceContent">
                <!-- å»ºè­°å…§å®¹å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                <div class="advice-loading hidden" id="adviceLoading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åˆ†ææŠ•ç¥¨çµæœ...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="adviceTestBtn">ğŸ§ª æ¸¬è©¦æ¨¡å¼</button>
                <button class="btn btn-primary" id="adviceCloseBtn">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥è…³æœ¬ -->
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>
    
    <script>
        // Phase 3 æ¼”ç¤ºè…³æœ¬
        let adviceUI = null;
        let currentMockData = null;
        
        // åˆå§‹åŒ–æ¼”ç¤º
        async function initializeDemo() {
            console.log('ğŸ¬ åˆå§‹åŒ– Phase 3 æ¼”ç¤º...');
            
            try {
                // åˆå§‹åŒ– ScrumAdviceUI
                adviceUI = new ScrumAdviceUI();
                await adviceUI.initialize();
                
                console.log('âœ… ScrumAdviceUI åˆå§‹åŒ–æˆåŠŸ');
                updateUIStatus();
                
                // è¨­å®šäº‹ä»¶ç›£è½
                setupDemoEventListeners();
                
            } catch (error) {
                console.error('âŒ æ¼”ç¤ºåˆå§‹åŒ–å¤±æ•—:', error);
                updateUIStatus(error);
            }
        }
        
        // è¨­å®šæ¼”ç¤ºäº‹ä»¶ç›£è½
        function setupDemoEventListeners() {
            document.getElementById('generateMockVotes').addEventListener('click', generateMockVotes);
            document.getElementById('triggerAdviceGeneration').addEventListener('click', triggerAdviceGeneration);
            document.getElementById('showAdviceModal').addEventListener('click', showAdviceModal);
            document.getElementById('resetDemo').addEventListener('click', resetDemo);
        }
        
        // ç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨
        function generateMockVotes() {
            const taskType = document.getElementById('mockTaskType').value;
            const playerCount = parseInt(document.getElementById('mockPlayerCount').value);
            const pointRange = document.getElementById('mockPointRange').value;
            const variance = document.getElementById('mockVariance').value;
            
            // ç”Ÿæˆç©å®¶å’ŒæŠ•ç¥¨
            const players = generateMockPlayers(playerCount);
            const votes = generateMockVotesData(players, pointRange, variance);
            
            currentMockData = {
                taskType,
                players,
                votes: { votes }
            };
            
            // é¡¯ç¤ºæ¨¡æ“¬è³‡æ–™
            displayMockVoteData(currentMockData);
            
            // æ›´æ–°çµ±è¨ˆé¢æ¿
            updateStatsPanel(currentMockData.votes);
        }
        
        // ç”Ÿæˆæ¨¡æ“¬ç©å®¶
        function generateMockPlayers(count) {
            const roles = ['dev', 'dev', 'qa', 'scrum_master', 'po', 'other'];
            const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
            
            const players = {};
            for (let i = 0; i < count; i++) {
                const playerId = `player_${i + 1}`;
                players[playerId] = {
                    name: names[i % names.length],
                    role: roles[i % roles.length]
                };
            }
            
            return players;
        }
        
        // ç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨è³‡æ–™
        function generateMockVotesData(players, pointRange, variance) {
            const ranges = {
                low: [1, 2, 3, 5],
                medium: [3, 5, 8, 13],
                high: [8, 13, 21],
                mixed: [1, 2, 3, 5, 8, 13, 21]
            };
            
            const points = ranges[pointRange];
            const votes = {};
            
            Object.keys(players).forEach((playerId, index) => {
                let value;
                
                if (variance === 'low') {
                    // ä½åˆ†æ­§ï¼šå¤§å®¶é¸å·®ä¸å¤šçš„å€¼
                    const basePoint = points[Math.floor(points.length / 2)];
                    const nearby = points.filter(p => Math.abs(p - basePoint) <= 2);
                    value = nearby[Math.floor(Math.random() * nearby.length)];
                } else if (variance === 'high') {
                    // é«˜åˆ†æ­§ï¼šé¸æ“‡æ¥µç«¯å€¼
                    value = Math.random() < 0.7 ? 
                        points[Math.floor(Math.random() * 2)] : // å‰å…©å€‹æˆ–å¾Œå…©å€‹
                        points[points.length - 1 - Math.floor(Math.random() * 2)];
                } else {
                    // ä¸­ç­‰åˆ†æ­§ï¼šéš¨æ©Ÿé¸æ“‡
                    value = points[Math.floor(Math.random() * points.length)];
                }
                
                votes[playerId] = {
                    value,
                    timestamp: Date.now(),
                    player_role: players[playerId].role
                };
            });
            
            return votes;
        }
        
        // é¡¯ç¤ºæ¨¡æ“¬æŠ•ç¥¨è³‡æ–™
        function displayMockVoteData(mockData) {
            const display = document.getElementById('mockVoteDisplay');
            const votesArray = Object.entries(mockData.votes.votes).map(([playerId, vote]) => {
                const player = mockData.players[playerId];
                return `${player.name} (${player.role}): ${vote.value} é»`;
            });
            
            const stats = calculateBasicStats(Object.values(mockData.votes.votes));
            
            display.innerHTML = `
                <h4>ğŸ—³ï¸ æ¨¡æ“¬æŠ•ç¥¨çµæœ</h4>
                <pre>ä»»å‹™é¡å‹: ${mockData.taskType}
ç©å®¶æ•¸é‡: ${Object.keys(mockData.players).length}

æŠ•ç¥¨æ˜ç´°:
${votesArray.join('\n')}

åŸºæœ¬çµ±è¨ˆ:
â€¢ å¹³å‡: ${stats.average} é»
â€¢ ç¯„åœ: ${stats.min} - ${stats.max} é»  
â€¢ å…±è­˜åº¦: ${stats.consensus}%</pre>
            `;
        }
        
        // è¨ˆç®—åŸºæœ¬çµ±è¨ˆ
        function calculateBasicStats(votes) {
            const values = votes.map(v => v.value).filter(v => typeof v === 'number');
            const sum = values.reduce((a, b) => a + b, 0);
            const average = Math.round(sum / values.length * 10) / 10;
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            // ç°¡åŒ–çš„å…±è­˜åº¦è¨ˆç®—
            const range = max - min;
            const consensus = Math.max(0, Math.round((1 - range / average) * 100));
            
            return { average, min, max, consensus };
        }
        
        // æ›´æ–°çµ±è¨ˆé¢æ¿
        function updateStatsPanel(voteData) {
            const statsContent = document.getElementById('statsContent');
            const stats = calculateBasicStats(Object.values(voteData.votes));
            
            statsContent.innerHTML = `
                <div class="stats-item">
                    <span class="stats-label">å¹³å‡ä¼°é»</span>
                    <span class="stats-value">${stats.average}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">ä¼°é»ç¯„åœ</span>
                    <span class="stats-value">${stats.min} - ${stats.max}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">æŠ•ç¥¨äººæ•¸</span>
                    <span class="stats-value">${Object.keys(voteData.votes).length}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">å…±è­˜åº¦</span>
                    <span class="stats-value">${stats.consensus}%</span>
                </div>
            `;
        }
        
        // è§¸ç™¼å»ºè­°ç”Ÿæˆ
        async function triggerAdviceGeneration() {
            if (!currentMockData || !adviceUI) {
                alert('è«‹å…ˆç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨è³‡æ–™');
                return;
            }
            
            console.log('ğŸ§  è§¸ç™¼å»ºè­°ç”Ÿæˆ...');
            
            try {
                await adviceUI.generateAdviceFromVotes(currentMockData.votes, {
                    taskType: currentMockData.taskType,
                    players: currentMockData.players
                });
                
                updateUIStatus();
                console.log('âœ… å»ºè­°ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('âŒ å»ºè­°ç”Ÿæˆå¤±æ•—:', error);
                alert('å»ºè­°ç”Ÿæˆå¤±æ•—: ' + error.message);
            }
        }
        
        // é¡¯ç¤ºå»ºè­°å½ˆçª—
        function showAdviceModal() {
            if (!adviceUI || !adviceUI.currentAdvice) {
                alert('è«‹å…ˆç”Ÿæˆæ™ºæ…§å»ºè­°');
                return;
            }
            
            adviceUI.showFullAdvice();
        }
        
        // é‡ç½®æ¼”ç¤º
        function resetDemo() {
            currentMockData = null;
            
            if (adviceUI) {
                adviceUI.resetAdvice();
            }
            
            // é‡ç½®é¡¯ç¤º
            document.getElementById('mockVoteDisplay').innerHTML = `
                <h4>ğŸ—³ï¸ æ¨¡æ“¬æŠ•ç¥¨çµæœ</h4>
                <pre>é»æ“Šã€Œç”Ÿæˆæ¨¡æ“¬æŠ•ç¥¨ã€é–‹å§‹æ¼”ç¤º</pre>
            `;
            
            document.getElementById('statsContent').innerHTML = '<p class="text-muted">ç­‰å¾…éŠæˆ²é–‹å§‹...</p>';
            
            updateUIStatus();
        }
        
        // æ›´æ–° UI ç‹€æ…‹é¡¯ç¤º
        function updateUIStatus(error = null) {
            const display = document.getElementById('uiStatusDisplay');
            
            if (error) {
                display.innerHTML = `
                    <h4>âŒ ScrumAdviceUI éŒ¯èª¤</h4>
                    <pre>${error.message || error}</pre>
                `;
                return;
            }
            
            if (!adviceUI) {
                display.innerHTML = `
                    <h4>â³ ScrumAdviceUI ç‹€æ…‹</h4>
                    <pre>å°šæœªåˆå§‹åŒ–</pre>
                `;
                return;
            }
            
            const info = adviceUI.getEngineInfo();
            display.innerHTML = `
                <h4>ğŸ¨ ScrumAdviceUI ç‹€æ…‹</h4>
                <pre>ç‰ˆæœ¬: ${info.version}
åˆå§‹åŒ–: ${info.initialized ? 'âœ…' : 'âŒ'}
å»ºè­°å¼•æ“: ${info.hasAdviceEngine ? 'âœ…' : 'âŒ'}
ç•¶å‰å»ºè­°: ${info.hasCurrentAdvice ? 'âœ…' : 'âŒ'}
DOM å…ƒç´ : ${info.domElementsReady}/11

å¿«æ·éµ:
â€¢ Ctrl+Shift+A: é¡¯ç¤ºå»ºè­°
â€¢ Ctrl+Shift+T: æ¸¬è©¦æ¨¡å¼
â€¢ ESC: é—œé–‰å½ˆçª—</pre>
            `;
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeDemo, 100);
        });
        
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ æ¼”ç¤ºé é¢éŒ¯èª¤:', event.error);
            updateUIStatus(event.error);
        });
    </script>
</body>
</html>