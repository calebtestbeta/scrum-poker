<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrumAdviceEngine Phase 5 學習機制演示</title>
    <link rel="stylesheet" href="src/styles/variables.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-game);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .demo-header h1 {
            color: var(--text-inverse);
            margin-bottom: 10px;
        }
        
        .demo-section {
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .demo-section h2 {
            color: var(--text-inverse);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .demo-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .demo-card h3 {
            color: var(--text-inverse);
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .demo-card p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0 0 15px 0;
            font-size: 14px;
        }
        
        .demo-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-demo {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: var(--color-primary);
            color: var(--text-inverse);
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn-demo:hover {
            background: var(--color-primary-dark);
        }
        
        .btn-demo.secondary {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-demo.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .info-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid var(--color-primary);
        }
        
        .info-display h4 {
            color: var(--text-inverse);
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .info-display pre {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            line-height: 1.4;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .learning-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>🧠 ScrumAdviceEngine Phase 5</h1>
            <p style="color: rgba(255, 255, 255, 0.8);">學習機制與個人化建議演示</p>
        </div>
        
        <!-- 學習模型狀態 -->
        <div class="demo-section">
            <h2>📚 學習模型狀態</h2>
            <div class="learning-stats" id="learningStats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSessions">-</div>
                    <div class="stat-label">投票會話</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="taskTypesCount">-</div>
                    <div class="stat-label">任務類型</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="rolesCount">-</div>
                    <div class="stat-label">角色類型</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="modelVersion">-</div>
                    <div class="stat-label">模型版本</div>
                </div>
            </div>
            
            <div class="demo-controls">
                <button class="btn-demo" id="refreshStats">🔄 刷新狀態</button>
                <button class="btn-demo secondary" id="clearLearningData">🗑️ 清除學習資料</button>
            </div>
            
            <div class="info-display" id="learningModelInfo">
                <h4>📊 學習模型詳細資訊</h4>
                <pre>點擊「刷新狀態」載入學習模型資訊</pre>
            </div>
        </div>
        
        <!-- 模擬訓練資料 -->
        <div class="demo-section">
            <h2>🎲 模擬訓練資料生成</h2>
            <div class="demo-grid">
                <div class="demo-card">
                    <h3>🏗️ 後端開發場景</h3>
                    <p>模擬後端團隊的投票模式，包含 API 設計、資料庫優化等複雜任務</p>
                    <button class="btn-demo" onclick="generateTrainingData('backend', 5)">生成 5 筆資料</button>
                </div>
                
                <div class="demo-card">
                    <h3>🎨 前端開發場景</h3>
                    <p>模擬前端團隊的投票模式，包含 UI/UX 實作、響應式設計等</p>
                    <button class="btn-demo" onclick="generateTrainingData('frontend', 5)">生成 5 筆資料</button>
                </div>
                
                <div class="demo-card">
                    <h3>🧪 測試場景</h3>
                    <p>模擬 QA 團隊的投票模式，包含自動化測試、測試用例設計等</p>
                    <button class="btn-demo" onclick="generateTrainingData('testing', 3)">生成 3 筆資料</button>
                </div>
                
                <div class="demo-card">
                    <h3>🚀 DevOps 場景</h3>
                    <p>模擬 DevOps 團隊的投票模式，包含 CI/CD、監控系統等</p>
                    <button class="btn-demo" onclick="generateTrainingData('devops', 3)">生成 3 筆資料</button>
                </div>
            </div>
        </div>
        
        <!-- 個人化建議測試 -->
        <div class="demo-section">
            <h2>🎯 個人化建議測試</h2>
            <div class="demo-controls">
                <button class="btn-demo" id="testPersonalizedAdvice">🧠 測試個人化建議</button>
                <button class="btn-demo secondary" id="testHistoryComparison">📈 測試歷史對比</button>
            </div>
            
            <div class="info-display" id="personalizedAdviceResult">
                <h4>🤖 個人化建議結果</h4>
                <pre>點擊上方按鈕測試個人化建議功能</pre>
            </div>
        </div>
        
        <!-- 學習洞察 -->
        <div class="demo-section">
            <h2>💡 學習洞察展示</h2>
            <div class="info-display" id="learningInsights">
                <h4>📚 團隊學習洞察</h4>
                <pre>載入中...</pre>
            </div>
        </div>
    </div>
    
    <!-- 載入腳本 -->
    <script src="src/services/ScrumAdviceEngine.js"></script>
    <script src="src/services/ScrumAdviceUI.js"></script>
    
    <script>
        // Phase 5 學習機制演示腳本
        let adviceEngine = null;
        let adviceUI = null;
        
        // 初始化演示
        async function initializeDemo() {
            console.log('🎬 初始化 Phase 5 學習機制演示...');
            
            try {
                // 初始化建議引擎
                adviceEngine = new ScrumAdviceEngine();
                
                // 初始化 UI 管理器
                adviceUI = new ScrumAdviceUI();
                await adviceUI.initialize();
                
                console.log('✅ Phase 5 演示初始化成功');
                
                // 載入初始狀態
                refreshLearningStats();
                showLearningInsights();
                
                // 設定事件監聽
                setupEventListeners();
                
            } catch (error) {
                console.error('❌ 演示初始化失敗:', error);
            }
        }
        
        // 設定事件監聽
        function setupEventListeners() {
            document.getElementById('refreshStats').addEventListener('click', refreshLearningStats);
            document.getElementById('clearLearningData').addEventListener('click', clearLearningData);
            document.getElementById('testPersonalizedAdvice').addEventListener('click', testPersonalizedAdvice);
            document.getElementById('testHistoryComparison').addEventListener('click', testHistoryComparison);
        }
        
        // 刷新學習統計
        function refreshLearningStats() {
            if (!adviceEngine) return;
            
            const summary = adviceEngine.getVotingHistorySummary();
            
            if (summary.available) {
                document.getElementById('totalSessions').textContent = summary.totalSessions;
                document.getElementById('taskTypesCount').textContent = summary.taskTypes.length;
                document.getElementById('rolesCount').textContent = summary.roles.length;
                document.getElementById('modelVersion').textContent = summary.modelVersion;
                
                document.getElementById('learningModelInfo').innerHTML = `
                    <h4>📊 學習模型詳細資訊</h4>
                    <pre>總投票會話: ${summary.totalSessions} 次
日期範圍: ${summary.dateRange.oldest} ~ ${summary.dateRange.newest}
任務類型: ${summary.taskTypes.join(', ') || '無'}
角色類型: ${summary.roles.join(', ') || '無'}
最後更新: ${summary.lastUpdated}</pre>
                `;
            } else {
                document.getElementById('totalSessions').textContent = '0';
                document.getElementById('taskTypesCount').textContent = '0';
                document.getElementById('rolesCount').textContent = '0';
                document.getElementById('modelVersion').textContent = 'N/A';
                
                document.getElementById('learningModelInfo').innerHTML = `
                    <h4>📊 學習模型詳細資訊</h4>
                    <pre>尚無學習資料，請先生成一些訓練資料</pre>
                `;
            }
        }
        
        // 生成訓練資料
        function generateTrainingData(taskType, count) {
            if (!adviceEngine) return;
            
            console.log(`🎲 生成 ${taskType} 類型的 ${count} 筆訓練資料...`);
            
            for (let i = 0; i < count; i++) {
                const mockData = generateMockSessionData(taskType);
                adviceEngine.recordVotingSession(mockData);
            }
            
            console.log(`✅ 已生成 ${count} 筆 ${taskType} 訓練資料`);
            refreshLearningStats();
            showLearningInsights();
        }
        
        // 生成模擬會話資料
        function generateMockSessionData(taskType) {
            const roles = ['dev', 'qa', 'scrum_master', 'po', 'other'];
            const players = {};
            const votes = {};
            
            // 根據任務類型調整投票範圍
            const pointRanges = {
                'frontend': [1, 2, 3, 5, 8],
                'backend': [3, 5, 8, 13, 21],
                'testing': [2, 3, 5, 8, 13],
                'devops': [5, 8, 13, 21, 34],
                'general': [1, 2, 3, 5, 8, 13, 21]
            };
            
            const points = pointRanges[taskType] || pointRanges['general'];
            const playerCount = Math.floor(Math.random() * 4) + 3; // 3-6 玩家
            
            // 生成玩家和投票
            for (let i = 0; i < playerCount; i++) {
                const playerId = `player_${i + 1}`;
                const role = roles[Math.floor(Math.random() * roles.length)];
                
                players[playerId] = {
                    name: `Player ${i + 1}`,
                    role: role
                };
                
                // 根據角色影響投票傾向
                let voteValue;
                if (role === 'dev') {
                    voteValue = points[Math.floor(Math.random() * Math.min(3, points.length))]; // 傾向較低估點
                } else if (role === 'qa') {
                    voteValue = points[Math.floor(Math.random() * points.length)]; // 平均分布
                } else if (role === 'scrum_master' || role === 'po') {
                    voteValue = points[Math.floor(points.length / 2) + Math.floor(Math.random() * Math.max(1, points.length - Math.floor(points.length / 2)))]; // 傾向較高估點
                } else {
                    voteValue = points[Math.floor(Math.random() * points.length)];
                }
                
                votes[playerId] = {
                    value: voteValue,
                    timestamp: Date.now() - Math.floor(Math.random() * 1000000),
                    player_role: role
                };
            }
            
            return {
                taskType: taskType,
                players: players,
                votes: votes,
                sessionInfo: {
                    roomId: `demo_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
                    timestamp: Date.now()
                }
            };
        }
        
        // 測試個人化建議
        async function testPersonalizedAdvice() {
            if (!adviceUI) return;
            
            console.log('🧠 測試個人化建議...');
            
            // 生成測試用的投票資料
            const testData = generateMockSessionData('frontend');
            
            try {
                await adviceUI.generateAdviceFromVotes({ votes: testData.votes }, {
                    taskType: testData.taskType,
                    players: testData.players
                });
                
                if (adviceUI.currentAdvice) {
                    document.getElementById('personalizedAdviceResult').innerHTML = `
                        <h4>🤖 個人化建議結果</h4>
                        <pre>${JSON.stringify({
                            type: adviceUI.currentAdvice.metadata.type,
                            analysisDepth: adviceUI.currentAdvice.metadata.analysisDepth,
                            hasLearningInsights: !!adviceUI.currentAdvice.learningInsights,
                            modelInfo: adviceUI.currentAdvice.metadata.modelInfo,
                            contentLength: adviceUI.currentAdvice.content.length
                        }, null, 2)}</pre>
                    `;
                    
                    // 顯示完整建議
                    adviceUI.showFullAdvice();
                }
                
            } catch (error) {
                console.error('❌ 測試個人化建議失敗:', error);
                document.getElementById('personalizedAdviceResult').innerHTML = `
                    <h4>❌ 測試失敗</h4>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // 測試歷史對比
        function testHistoryComparison() {
            if (!adviceEngine) return;
            
            const testData = generateMockSessionData('backend');
            const enhancement = adviceEngine.applyLearningModel(testData);
            
            document.getElementById('personalizedAdviceResult').innerHTML = `
                <h4>📈 歷史對比測試結果</h4>
                <pre>${JSON.stringify(enhancement, null, 2)}</pre>
            `;
        }
        
        // 清除學習資料
        function clearLearningData() {
            if (confirm('確定要清除所有學習資料嗎？此操作無法復原。')) {
                try {
                    localStorage.removeItem('scrumPoker_votingHistory');
                    localStorage.removeItem('scrumPoker_learningModel');
                    console.log('🗑️ 學習資料已清除');
                    refreshLearningStats();
                    showLearningInsights();
                } catch (error) {
                    console.error('❌ 清除失敗:', error);
                }
            }
        }
        
        // 顯示學習洞察
        function showLearningInsights() {
            if (!adviceEngine) return;
            
            try {
                const summary = adviceEngine.getVotingHistorySummary();
                
                if (summary.available) {
                    document.getElementById('learningInsights').innerHTML = `
                        <h4>📚 團隊學習洞察</h4>
                        <pre>✨ 基於 ${summary.totalSessions} 次投票會話的洞察：

🎯 任務類型分析：
${summary.taskTypes.map(type => `   • ${type}: 已累積投票模式`).join('\\n') || '   尚無任務類型資料'}

👥 角色投票模式：
${summary.roles.map(role => `   • ${role}: 已學習投票傾向`).join('\\n') || '   尚無角色投票資料'}

🧠 個人化程度：${summary.totalSessions > 10 ? '高' : summary.totalSessions > 5 ? '中' : '低'}
📊 資料豐富度：${summary.taskTypes.length > 3 ? '豐富' : '一般'}</pre>
                    `;
                } else {
                    document.getElementById('learningInsights').innerHTML = `
                        <h4>📚 團隊學習洞察</h4>
                        <pre>🚀 歡迎使用智慧建議系統！

目前尚未累積足夠的學習資料。
請先生成一些訓練資料以體驗個人化建議功能：

1. 點擊上方的「生成訓練資料」按鈕
2. 嘗試不同的任務類型
3. 觀察學習模型如何改善建議品質</pre>
                    `;
                }
            } catch (error) {
                console.error('❌ 顯示學習洞察失敗:', error);
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeDemo, 100);
        });
        
        // 全域錯誤處理
        window.addEventListener('error', (event) => {
            console.error('🚨 演示頁面錯誤:', event.error);
        });
    </script>
</body>
</html>