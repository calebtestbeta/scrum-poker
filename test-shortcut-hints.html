<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快捷鍵提示系統測試</title>
    <style>
        body {
            margin: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-panel {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            border: 1px solid #007acc;
            background: #007acc;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #005999;
        }
        
        .status {
            font-weight: bold;
            margin: 10px 0;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 快捷鍵提示系統測試</h1>
        
        <div class="test-section">
            <h2>1. 模組載入測試</h2>
            <div id="moduleStatus" class="status">載入中...</div>
            <button onclick="testModuleLoading()">重新檢查模組</button>
        </div>
        
        <div class="test-section">
            <h2>2. 快捷鍵提示渲染測試</h2>
            <div class="test-panel">
                <div class="shortcut-hints" id="testShortcutHints">
                    <h4>⌨️ 快捷鍵</h4>
                    <div class="shortcuts-list">
                        <!-- 快捷鍵動態生成在這裡 -->
                    </div>
                </div>
            </div>
            <div id="renderStatus" class="status">等待測試...</div>
            <button onclick="testShortcutRendering()">測試渲染</button>
            <button onclick="testEmptyShortcuts()">測試空陣列</button>
            <button onclick="testInvalidInput()">測試無效輸入</button>
        </div>
        
        <div class="test-section">
            <h2>3. 面板切換測試</h2>
            <div class="test-panel" id="testPanel">
                <p>這是測試面板 - 初始狀態: 顯示</p>
            </div>
            <div id="panelStatus" class="status">面板狀態: 顯示</div>
            <button onclick="testPanelToggle()">切換面板</button>
        </div>
        
        <div class="test-section">
            <h2>4. 事件匯流排測試</h2>
            <div id="eventStatus" class="status">等待事件...</div>
            <button onclick="testEventBus()">測試事件發布</button>
            <button onclick="clearEventLog()">清除日誌</button>
        </div>
        
        <div class="test-section">
            <h2>5. 鍵盤快捷鍵測試</h2>
            <div class="info">
                <p>請嘗試以下快捷鍵：</p>
                <ul>
                    <li><kbd>H</kbd> - 切換面板</li>
                    <li><kbd>Space</kbd> - 測試空白鍵</li>
                    <li><kbd>1-9</kbd> - 測試數字鍵</li>
                </ul>
            </div>
            <div id="keyboardStatus" class="status">按鍵監聽中...</div>
        </div>
    </div>

    <!-- 載入樣式 -->
    <link rel="stylesheet" href="src/styles/variables.css">
    <link rel="stylesheet" href="src/styles/main.css">
    
    <!-- 載入模組 -->
    <script type="module">
        import { shortcutHintsManager, getDefaultShortcuts, formatShortcutsHTML } from './src/ui/ShortcutHints.js';
        import { panelManager } from './src/ui/PanelManager.js';
        
        // 暴露到全域以便測試
        window.shortcutHintsManager = shortcutHintsManager;
        window.panelManager = panelManager;
        window.getDefaultShortcuts = getDefaultShortcuts;
        window.formatShortcutsHTML = formatShortcutsHTML;
        
        // 模擬 EventBus
        window.eventBus = {
            listeners: new Map(),
            emit(event, data) {
                console.log('🔄 事件發布:', event, data);
                const log = document.getElementById('eventStatus');
                log.innerHTML += `<div>📤 ${event}: ${JSON.stringify(data)}</div>`;
                
                if (this.listeners.has(event)) {
                    this.listeners.get(event).forEach(callback => callback(data));
                }
            },
            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }
        };
        
        console.log('✅ 測試環境載入完成');
        testModuleLoading();
        
        // 鍵盤事件監聽
        document.addEventListener('keydown', (event) => {
            const keyStatus = document.getElementById('keyboardStatus');
            keyStatus.innerHTML = `按下: <kbd>${event.key}</kbd> (${event.code})`;
            
            if (event.key === 'h' || event.key === 'H') {
                event.preventDefault();
                testPanelToggle();
            }
        });
    </script>
    
    <script>
        // 測試函數
        function testModuleLoading() {
            const status = document.getElementById('moduleStatus');
            
            if (window.shortcutHintsManager && window.panelManager) {
                status.innerHTML = '<span class="success">✅ 模組載入成功</span>';
            } else {
                status.innerHTML = '<span class="error">❌ 模組載入失敗</span>';
            }
        }
        
        function testShortcutRendering() {
            const status = document.getElementById('renderStatus');
            
            try {
                const result = window.shortcutHintsManager.updateShortcutHints({
                    containerId: 'testShortcutHints'
                });
                
                if (result) {
                    status.innerHTML = '<span class="success">✅ 快捷鍵渲染成功</span>';
                } else {
                    status.innerHTML = '<span class="error">❌ 快捷鍵渲染失敗</span>';
                }
            } catch (error) {
                status.innerHTML = `<span class="error">❌ 渲染錯誤: ${error.message}</span>`;
            }
        }
        
        function testEmptyShortcuts() {
            const status = document.getElementById('renderStatus');
            
            try {
                const result = window.shortcutHintsManager.updateShortcutHints({
                    containerId: 'testShortcutHints',
                    shortcuts: []
                });
                
                status.innerHTML = '<span class="info">ℹ️ 空陣列測試完成</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">❌ 空陣列測試失敗: ${error.message}</span>`;
            }
        }
        
        function testInvalidInput() {
            const status = document.getElementById('renderStatus');
            
            try {
                const result = window.shortcutHintsManager.updateShortcutHints({
                    containerId: 'nonexistent'
                });
                
                status.innerHTML = '<span class="info">ℹ️ 無效輸入測試完成（應該安全降級）</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">❌ 無效輸入測試失敗: ${error.message}</span>`;
            }
        }
        
        function testPanelToggle() {
            const panel = document.getElementById('testPanel');
            const status = document.getElementById('panelStatus');
            
            try {
                const isOpen = window.panelManager.togglePanel('testPanel', 'manual');
                status.innerHTML = `面板狀態: ${isOpen ? '顯示' : '隱藏'}`;
            } catch (error) {
                status.innerHTML = `<span class="error">❌ 面板切換失敗: ${error.message}</span>`;
            }
        }
        
        function testEventBus() {
            if (window.eventBus) {
                window.eventBus.emit('UI/ShortcutHintsRendered', {
                    count: 6,
                    items: window.getDefaultShortcuts()
                });
                
                window.eventBus.emit('UI/PanelToggled', {
                    panelId: 'testPanel',
                    isOpen: true,
                    reason: 'manual'
                });
            }
        }
        
        function clearEventLog() {
            document.getElementById('eventStatus').innerHTML = '事件日誌已清除';
        }
    </script>
</body>
</html>