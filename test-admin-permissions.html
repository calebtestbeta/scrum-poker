<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminManager Firebase æ¬Šé™æ¸¬è©¦</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
        }
        
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AdminManager Firebase æ¬Šé™æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h2>1. Firebase é€£ç·šæ¸¬è©¦</h2>
            <p>æ¸¬è©¦ Firebase é€£ç·šå’ŒåŸºæœ¬è¨­å®š</p>
            <button onclick="testFirebaseConnection()">æ¸¬è©¦ Firebase é€£ç·š</button>
            <div id="connectionResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Firebase æ¬Šé™è¨ºæ–·</h2>
            <p>è¨ºæ–· Firebase æ¬Šé™è¨­å®šå’Œè¦å‰‡</p>
            <button onclick="testFirebasePermissions()">è¨ºæ–· Firebase æ¬Šé™</button>
            <div id="permissionsResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>3. AdminManager ç³»çµ±çµ±è¨ˆæ¸¬è©¦</h2>
            <p>æ¸¬è©¦ AdminManager çš„ getSystemStats åŠŸèƒ½</p>
            <button onclick="testAdminSystemStats()">æ¸¬è©¦ç³»çµ±çµ±è¨ˆ</button>
            <div id="statsResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. å»ºç«‹æ¸¬è©¦æˆ¿é–“</h2>
            <p>å»ºç«‹æ¸¬è©¦æˆ¿é–“ä»¥ä¾¿æ¸¬è©¦è®€å–åŠŸèƒ½</p>
            <button onclick="createTestRoom()">å»ºç«‹æ¸¬è©¦æˆ¿é–“</button>
            <button onclick="clearTestRooms()">æ¸…é™¤æ¸¬è©¦æˆ¿é–“</button>
            <div id="roomResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. å®Œæ•´æ¸¬è©¦æµç¨‹</h2>
            <p>åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦æµç¨‹</p>
            <button onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <div id="fullTestResult" class="result"></div>
        </div>
    </div>

    <!-- Firebase è¨­å®š -->
    <script src="firebase-config.js"></script>
    
    <!-- ç®¡ç†å™¨é¡åˆ¥ -->
    <script src="managers/FirebaseManager.js"></script>
    <script src="managers/AdminManager.js"></script>
    
    <script>
        let firebaseManager = null;
        let adminManager = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ§ª AdminManager æ¬Šé™æ¸¬è©¦é é¢å·²è¼‰å…¥');
            
            try {
                // åˆå§‹åŒ– FirebaseManager
                firebaseManager = new FirebaseManager();
                const config = await getFirebaseConfig();
                await firebaseManager.initialize(config);
                
                // åˆå§‹åŒ– AdminManager
                adminManager = new AdminManager(firebaseManager);
                
                console.log('âœ… æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–å®Œæˆ');
                updateResult('connectionResult', 'âœ… æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–å®Œæˆ', 'success');
            } catch (error) {
                console.error('âŒ æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–å¤±æ•—:', error);
                updateResult('connectionResult', `âŒ æ¸¬è©¦ç’°å¢ƒåˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // å–å¾— Firebase è¨­å®š
        async function getFirebaseConfig() {
            const savedConfig = localStorage.getItem('scrumPokerConfig');
            const savedMode = localStorage.getItem('scrumPokerMode');
            
            if (savedConfig) {
                return JSON.parse(savedConfig);
            } else if (savedMode === 'local') {
                return null;
            } else if (typeof window.FIREBASE_CONFIG !== 'undefined') {
                return window.FIREBASE_CONFIG;
            }
            return null;
        }
        
        // æ›´æ–°çµæœé¡¯ç¤º
        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `result ${type}`;
            }
        }
        
        // æ¸¬è©¦ Firebase é€£ç·š
        async function testFirebaseConnection() {
            updateResult('connectionResult', 'ğŸ” æ¸¬è©¦ Firebase é€£ç·šä¸­...', 'info');
            
            if (!firebaseManager) {
                updateResult('connectionResult', 'âŒ FirebaseManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                const status = firebaseManager.getConnectionStatus();
                const result = `Firebase é€£ç·šç‹€æ…‹:
ä½¿ç”¨ Firebase: ${status.useFirebase}
é€£ç·šç‹€æ…‹: ${status.isConnected}
ç•¶å‰æˆ¿é–“: ${status.currentRoom || 'ç„¡'}
ç•¶å‰ç©å®¶: ${status.currentPlayer ? status.currentPlayer.name : 'ç„¡'}`;
                
                updateResult('connectionResult', result, 'success');
            } catch (error) {
                updateResult('connectionResult', `âŒ é€£ç·šæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ¸¬è©¦ Firebase æ¬Šé™
        async function testFirebasePermissions() {
            updateResult('permissionsResult', 'ğŸ” è¨ºæ–· Firebase æ¬Šé™ä¸­...', 'info');
            
            if (!firebaseManager) {
                updateResult('permissionsResult', 'âŒ FirebaseManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                const diagnosis = await firebaseManager.diagnoseFirebasePermissions();
                
                let result = `Firebase æ¬Šé™è¨ºæ–·çµæœ:
æ™‚é–“: ${new Date(diagnosis.timestamp).toLocaleString('zh-TW')}
ä½¿ç”¨ Firebase: ${diagnosis.useFirebase}
é€£ç·šç‹€æ…‹: ${diagnosis.isConnected}

æ¸¬è©¦çµæœ:`;
                
                Object.entries(diagnosis.tests).forEach(([testName, testResult]) => {
                    const status = testResult.success ? 'âœ…' : 'âŒ';
                    result += `\n${status} ${testName}: ${testResult.message || testResult.error}`;
                });
                
                if (diagnosis.errors.length > 0) {
                    result += `\n\néŒ¯èª¤:`;
                    diagnosis.errors.forEach(error => {
                        result += `\nâŒ ${error}`;
                    });
                }
                
                if (diagnosis.recommendations.length > 0) {
                    result += `\n\nå»ºè­°:`;
                    diagnosis.recommendations.forEach(rec => {
                        result += `\nğŸ’¡ ${rec}`;
                    });
                }
                
                const resultType = diagnosis.errors.length === 0 ? 'success' : 'error';
                updateResult('permissionsResult', result, resultType);
                
            } catch (error) {
                updateResult('permissionsResult', `âŒ æ¬Šé™è¨ºæ–·å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ¸¬è©¦ AdminManager ç³»çµ±çµ±è¨ˆ
        async function testAdminSystemStats() {
            updateResult('statsResult', 'ğŸ” æ¸¬è©¦ç³»çµ±çµ±è¨ˆåŠŸèƒ½ä¸­...', 'info');
            
            if (!adminManager) {
                updateResult('statsResult', 'âŒ AdminManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                // å…ˆé©—è­‰ Firebase è¨­å®š
                const projectId = document.getElementById('projectId');
                const apiKey = document.getElementById('apiKey');
                
                // å¦‚æœæœ‰è¼¸å…¥æ¬„ä½ï¼Œä½¿ç”¨é‚£äº›å€¼é€²è¡Œé©—è­‰
                if (projectId && apiKey && projectId.value && apiKey.value) {
                    const authResult = await adminManager.authenticateWithFirebase(
                        projectId.value.trim(), 
                        apiKey.value.trim()
                    );
                    
                    if (!authResult.success) {
                        updateResult('statsResult', `âŒ Firebase é©—è­‰å¤±æ•—: ${authResult.message}`, 'error');
                        return;
                    }
                }
                
                // åŸ·è¡Œç³»çµ±çµ±è¨ˆ
                const stats = await adminManager.getSystemStats();
                
                const result = `ç³»çµ±çµ±è¨ˆçµæœ:
æ™‚é–“: ${new Date(stats.timestamp).toLocaleString('zh-TW')}
ç¸½æˆ¿é–“æ•¸: ${stats.totalRooms}
ç¸½ç©å®¶æ•¸: ${stats.totalPlayers}
ç¸½æŠ•ç¥¨æ•¸: ${stats.totalVotes}

ç³»çµ±è³‡è¨Š:
ä½¿ç”¨ Firebase: ${stats.systemInfo.useFirebase}
é€£ç·šç‹€æ…‹: ${stats.systemInfo.isConnected}
ç•¶å‰æˆ¿é–“: ${stats.systemInfo.currentRoom || 'ç„¡'}

æˆ¿é–“è©³ç´°è³‡æ–™:
${stats.roomDetails.map(room => 
    `æˆ¿é–“ ${room.id}: ${room.playerCount} ç©å®¶, ${room.voteCount} æŠ•ç¥¨, ç‹€æ…‹: ${room.gameState}(${room.phase})`
).join('\n') || 'ç„¡æˆ¿é–“'}`;
                
                updateResult('statsResult', result, 'success');
                
            } catch (error) {
                console.error('ç³»çµ±çµ±è¨ˆæ¸¬è©¦å¤±æ•—:', error);
                updateResult('statsResult', `âŒ ç³»çµ±çµ±è¨ˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // å»ºç«‹æ¸¬è©¦æˆ¿é–“
        async function createTestRoom() {
            updateResult('roomResult', 'ğŸ” å»ºç«‹æ¸¬è©¦æˆ¿é–“ä¸­...', 'info');
            
            if (!firebaseManager) {
                updateResult('roomResult', 'âŒ FirebaseManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                const result = await firebaseManager.joinRoom('', 'æ¸¬è©¦ç®¡ç†å“¡', 'po');
                
                if (result && result.roomId) {
                    const message = `âœ… æ¸¬è©¦æˆ¿é–“å»ºç«‹æˆåŠŸ!
æˆ¿é–“ ID: ${result.roomId}
ç©å®¶ ID: ${result.playerId}
æ˜¯æ–°æˆ¿é–“: ${result.isNewRoom ? 'æ˜¯' : 'å¦'}`;
                    
                    updateResult('roomResult', message, 'success');
                } else {
                    updateResult('roomResult', 'âŒ æ¸¬è©¦æˆ¿é–“å»ºç«‹å¤±æ•—ï¼šæœªè¿”å›æœ‰æ•ˆçµæœ', 'error');
                }
                
            } catch (error) {
                console.error('æ¸¬è©¦æˆ¿é–“å»ºç«‹å¤±æ•—:', error);
                updateResult('roomResult', `âŒ æ¸¬è©¦æˆ¿é–“å»ºç«‹å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ¸…é™¤æ¸¬è©¦æˆ¿é–“
        async function clearTestRooms() {
            updateResult('roomResult', 'ğŸ” æ¸…é™¤æ¸¬è©¦æˆ¿é–“ä¸­...', 'info');
            
            if (!adminManager) {
                updateResult('roomResult', 'âŒ AdminManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                const result = await adminManager.clearAllData();
                updateResult('roomResult', `âœ… ${result.message}`, 'success');
            } catch (error) {
                console.error('æ¸…é™¤æ¸¬è©¦æˆ¿é–“å¤±æ•—:', error);
                updateResult('roomResult', `âŒ æ¸…é™¤æ¸¬è©¦æˆ¿é–“å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        async function runFullTest() {
            updateResult('fullTestResult', 'ğŸ” åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹...', 'info');
            
            let testResults = [];
            
            try {
                // æ¸¬è©¦ 1: Firebase é€£ç·š
                testResults.push('=== æ¸¬è©¦ 1: Firebase é€£ç·š ===');
                const status = firebaseManager.getConnectionStatus();
                testResults.push(`âœ… Firebase é€£ç·š: ${status.isConnected ? 'æ­£å¸¸' : 'å¤±æ•—'}`);
                
                // æ¸¬è©¦ 2: æ¬Šé™è¨ºæ–·
                testResults.push('\n=== æ¸¬è©¦ 2: Firebase æ¬Šé™è¨ºæ–· ===');
                try {
                    const diagnosis = await firebaseManager.diagnoseFirebasePermissions();
                    testResults.push(`âœ… æ¬Šé™è¨ºæ–·: ${diagnosis.errors.length === 0 ? 'é€šé' : `ç™¼ç¾ ${diagnosis.errors.length} å€‹å•é¡Œ`}`);
                } catch (diagError) {
                    testResults.push(`âŒ æ¬Šé™è¨ºæ–·å¤±æ•—: ${diagError.message}`);
                }
                
                // æ¸¬è©¦ 3: å»ºç«‹æ¸¬è©¦æˆ¿é–“
                testResults.push('\n=== æ¸¬è©¦ 3: å»ºç«‹æ¸¬è©¦æˆ¿é–“ ===');
                try {
                    const roomResult = await firebaseManager.joinRoom('', 'å®Œæ•´æ¸¬è©¦ç©å®¶', 'dev');
                    testResults.push(`âœ… æˆ¿é–“å»ºç«‹: ${roomResult ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    if (roomResult) {
                        testResults.push(`   æˆ¿é–“ ID: ${roomResult.roomId}`);
                    }
                } catch (roomError) {
                    testResults.push(`âŒ æˆ¿é–“å»ºç«‹å¤±æ•—: ${roomError.message}`);
                }
                
                // æ¸¬è©¦ 4: ç³»çµ±çµ±è¨ˆ
                testResults.push('\n=== æ¸¬è©¦ 4: ç³»çµ±çµ±è¨ˆè®€å– ===');
                try {
                    const stats = await adminManager.getSystemStats();
                    testResults.push(`âœ… ç³»çµ±çµ±è¨ˆ: æˆåŠŸ`);
                    testResults.push(`   æˆ¿é–“æ•¸: ${stats.totalRooms}`);
                    testResults.push(`   ç©å®¶æ•¸: ${stats.totalPlayers}`);
                } catch (statsError) {
                    testResults.push(`âŒ ç³»çµ±çµ±è¨ˆå¤±æ•—: ${statsError.message}`);
                }
                
                // æ¸¬è©¦ 5: è³‡æ–™æ¸…é™¤
                testResults.push('\n=== æ¸¬è©¦ 5: è³‡æ–™æ¸…é™¤ ===');
                try {
                    const clearResult = await adminManager.clearAllData();
                    testResults.push(`âœ… è³‡æ–™æ¸…é™¤: ${clearResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    if (clearResult.success) {
                        testResults.push(`   æ¸…é™¤æˆ¿é–“: ${clearResult.clearedRooms}`);
                        testResults.push(`   æ¸…é™¤ç©å®¶: ${clearResult.clearedPlayers}`);
                    }
                } catch (clearError) {
                    testResults.push(`âŒ è³‡æ–™æ¸…é™¤å¤±æ•—: ${clearError.message}`);
                }
                
                testResults.push('\n=== å®Œæ•´æ¸¬è©¦å®Œæˆ ===');
                updateResult('fullTestResult', testResults.join('\n'), 'success');
                
            } catch (error) {
                testResults.push(`\nâŒ å®Œæ•´æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                updateResult('fullTestResult', testResults.join('\n'), 'error');
            }
        }
    </script>
</body>
</html>