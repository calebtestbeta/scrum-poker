<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminManager Firebase 權限測試</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
        }
        
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 AdminManager Firebase 權限測試</h1>
        
        <div class="test-section">
            <h2>1. Firebase 連線測試</h2>
            <p>測試 Firebase 連線和基本設定</p>
            <button onclick="testFirebaseConnection()">測試 Firebase 連線</button>
            <div id="connectionResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Firebase 權限診斷</h2>
            <p>診斷 Firebase 權限設定和規則</p>
            <button onclick="testFirebasePermissions()">診斷 Firebase 權限</button>
            <div id="permissionsResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>3. AdminManager 系統統計測試</h2>
            <p>測試 AdminManager 的 getSystemStats 功能</p>
            <button onclick="testAdminSystemStats()">測試系統統計</button>
            <div id="statsResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. 建立測試房間</h2>
            <p>建立測試房間以便測試讀取功能</p>
            <button onclick="createTestRoom()">建立測試房間</button>
            <button onclick="clearTestRooms()">清除測試房間</button>
            <div id="roomResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. 完整測試流程</h2>
            <p>執行完整的測試流程</p>
            <button onclick="runFullTest()">執行完整測試</button>
            <div id="fullTestResult" class="result"></div>
        </div>
    </div>

    <!-- Firebase 設定 -->
    <script src="firebase-config.js"></script>
    
    <!-- 管理器類別 -->
    <script src="managers/FirebaseManager.js"></script>
    <script src="managers/AdminManager.js"></script>
    
    <script>
        let firebaseManager = null;
        let adminManager = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🧪 AdminManager 權限測試頁面已載入');
            
            try {
                // 初始化 FirebaseManager
                firebaseManager = new FirebaseManager();
                const config = await getFirebaseConfig();
                await firebaseManager.initialize(config);
                
                // 初始化 AdminManager
                adminManager = new AdminManager(firebaseManager);
                
                console.log('✅ 測試環境初始化完成');
                updateResult('connectionResult', '✅ 測試環境初始化完成', 'success');
            } catch (error) {
                console.error('❌ 測試環境初始化失敗:', error);
                updateResult('connectionResult', `❌ 測試環境初始化失敗: ${error.message}`, 'error');
            }
        });
        
        // 取得 Firebase 設定
        async function getFirebaseConfig() {
            const savedConfig = localStorage.getItem('scrumPokerConfig');
            const savedMode = localStorage.getItem('scrumPokerMode');
            
            if (savedConfig) {
                return JSON.parse(savedConfig);
            } else if (savedMode === 'local') {
                return null;
            } else if (typeof window.FIREBASE_CONFIG !== 'undefined') {
                return window.FIREBASE_CONFIG;
            }
            return null;
        }
        
        // 更新結果顯示
        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `result ${type}`;
            }
        }
        
        // 測試 Firebase 連線
        async function testFirebaseConnection() {
            updateResult('connectionResult', '🔍 測試 Firebase 連線中...', 'info');
            
            if (!firebaseManager) {
                updateResult('connectionResult', '❌ FirebaseManager 未初始化', 'error');
                return;
            }
            
            try {
                const status = firebaseManager.getConnectionStatus();
                const result = `Firebase 連線狀態:
使用 Firebase: ${status.useFirebase}
連線狀態: ${status.isConnected}
當前房間: ${status.currentRoom || '無'}
當前玩家: ${status.currentPlayer ? status.currentPlayer.name : '無'}`;
                
                updateResult('connectionResult', result, 'success');
            } catch (error) {
                updateResult('connectionResult', `❌ 連線測試失敗: ${error.message}`, 'error');
            }
        }
        
        // 測試 Firebase 權限
        async function testFirebasePermissions() {
            updateResult('permissionsResult', '🔍 診斷 Firebase 權限中...', 'info');
            
            if (!firebaseManager) {
                updateResult('permissionsResult', '❌ FirebaseManager 未初始化', 'error');
                return;
            }
            
            try {
                const diagnosis = await firebaseManager.diagnoseFirebasePermissions();
                
                let result = `Firebase 權限診斷結果:
時間: ${new Date(diagnosis.timestamp).toLocaleString('zh-TW')}
使用 Firebase: ${diagnosis.useFirebase}
連線狀態: ${diagnosis.isConnected}

測試結果:`;
                
                Object.entries(diagnosis.tests).forEach(([testName, testResult]) => {
                    const status = testResult.success ? '✅' : '❌';
                    result += `\n${status} ${testName}: ${testResult.message || testResult.error}`;
                });
                
                if (diagnosis.errors.length > 0) {
                    result += `\n\n錯誤:`;
                    diagnosis.errors.forEach(error => {
                        result += `\n❌ ${error}`;
                    });
                }
                
                if (diagnosis.recommendations.length > 0) {
                    result += `\n\n建議:`;
                    diagnosis.recommendations.forEach(rec => {
                        result += `\n💡 ${rec}`;
                    });
                }
                
                const resultType = diagnosis.errors.length === 0 ? 'success' : 'error';
                updateResult('permissionsResult', result, resultType);
                
            } catch (error) {
                updateResult('permissionsResult', `❌ 權限診斷失敗: ${error.message}`, 'error');
            }
        }
        
        // 測試 AdminManager 系統統計
        async function testAdminSystemStats() {
            updateResult('statsResult', '🔍 測試系統統計功能中...', 'info');
            
            if (!adminManager) {
                updateResult('statsResult', '❌ AdminManager 未初始化', 'error');
                return;
            }
            
            try {
                // 先驗證 Firebase 設定
                const projectId = document.getElementById('projectId');
                const apiKey = document.getElementById('apiKey');
                
                // 如果有輸入欄位，使用那些值進行驗證
                if (projectId && apiKey && projectId.value && apiKey.value) {
                    const authResult = await adminManager.authenticateWithFirebase(
                        projectId.value.trim(), 
                        apiKey.value.trim()
                    );
                    
                    if (!authResult.success) {
                        updateResult('statsResult', `❌ Firebase 驗證失敗: ${authResult.message}`, 'error');
                        return;
                    }
                }
                
                // 執行系統統計
                const stats = await adminManager.getSystemStats();
                
                const result = `系統統計結果:
時間: ${new Date(stats.timestamp).toLocaleString('zh-TW')}
總房間數: ${stats.totalRooms}
總玩家數: ${stats.totalPlayers}
總投票數: ${stats.totalVotes}

系統資訊:
使用 Firebase: ${stats.systemInfo.useFirebase}
連線狀態: ${stats.systemInfo.isConnected}
當前房間: ${stats.systemInfo.currentRoom || '無'}

房間詳細資料:
${stats.roomDetails.map(room => 
    `房間 ${room.id}: ${room.playerCount} 玩家, ${room.voteCount} 投票, 狀態: ${room.gameState}(${room.phase})`
).join('\n') || '無房間'}`;
                
                updateResult('statsResult', result, 'success');
                
            } catch (error) {
                console.error('系統統計測試失敗:', error);
                updateResult('statsResult', `❌ 系統統計測試失敗: ${error.message}`, 'error');
            }
        }
        
        // 建立測試房間
        async function createTestRoom() {
            updateResult('roomResult', '🔍 建立測試房間中...', 'info');
            
            if (!firebaseManager) {
                updateResult('roomResult', '❌ FirebaseManager 未初始化', 'error');
                return;
            }
            
            try {
                const result = await firebaseManager.joinRoom('', '測試管理員', 'po');
                
                if (result && result.roomId) {
                    const message = `✅ 測試房間建立成功!
房間 ID: ${result.roomId}
玩家 ID: ${result.playerId}
是新房間: ${result.isNewRoom ? '是' : '否'}`;
                    
                    updateResult('roomResult', message, 'success');
                } else {
                    updateResult('roomResult', '❌ 測試房間建立失敗：未返回有效結果', 'error');
                }
                
            } catch (error) {
                console.error('測試房間建立失敗:', error);
                updateResult('roomResult', `❌ 測試房間建立失敗: ${error.message}`, 'error');
            }
        }
        
        // 清除測試房間
        async function clearTestRooms() {
            updateResult('roomResult', '🔍 清除測試房間中...', 'info');
            
            if (!adminManager) {
                updateResult('roomResult', '❌ AdminManager 未初始化', 'error');
                return;
            }
            
            try {
                const result = await adminManager.clearAllData();
                updateResult('roomResult', `✅ ${result.message}`, 'success');
            } catch (error) {
                console.error('清除測試房間失敗:', error);
                updateResult('roomResult', `❌ 清除測試房間失敗: ${error.message}`, 'error');
            }
        }
        
        // 執行完整測試
        async function runFullTest() {
            updateResult('fullTestResult', '🔍 執行完整測試流程...', 'info');
            
            let testResults = [];
            
            try {
                // 測試 1: Firebase 連線
                testResults.push('=== 測試 1: Firebase 連線 ===');
                const status = firebaseManager.getConnectionStatus();
                testResults.push(`✅ Firebase 連線: ${status.isConnected ? '正常' : '失敗'}`);
                
                // 測試 2: 權限診斷
                testResults.push('\n=== 測試 2: Firebase 權限診斷 ===');
                try {
                    const diagnosis = await firebaseManager.diagnoseFirebasePermissions();
                    testResults.push(`✅ 權限診斷: ${diagnosis.errors.length === 0 ? '通過' : `發現 ${diagnosis.errors.length} 個問題`}`);
                } catch (diagError) {
                    testResults.push(`❌ 權限診斷失敗: ${diagError.message}`);
                }
                
                // 測試 3: 建立測試房間
                testResults.push('\n=== 測試 3: 建立測試房間 ===');
                try {
                    const roomResult = await firebaseManager.joinRoom('', '完整測試玩家', 'dev');
                    testResults.push(`✅ 房間建立: ${roomResult ? '成功' : '失敗'}`);
                    if (roomResult) {
                        testResults.push(`   房間 ID: ${roomResult.roomId}`);
                    }
                } catch (roomError) {
                    testResults.push(`❌ 房間建立失敗: ${roomError.message}`);
                }
                
                // 測試 4: 系統統計
                testResults.push('\n=== 測試 4: 系統統計讀取 ===');
                try {
                    const stats = await adminManager.getSystemStats();
                    testResults.push(`✅ 系統統計: 成功`);
                    testResults.push(`   房間數: ${stats.totalRooms}`);
                    testResults.push(`   玩家數: ${stats.totalPlayers}`);
                } catch (statsError) {
                    testResults.push(`❌ 系統統計失敗: ${statsError.message}`);
                }
                
                // 測試 5: 資料清除
                testResults.push('\n=== 測試 5: 資料清除 ===');
                try {
                    const clearResult = await adminManager.clearAllData();
                    testResults.push(`✅ 資料清除: ${clearResult.success ? '成功' : '失敗'}`);
                    if (clearResult.success) {
                        testResults.push(`   清除房間: ${clearResult.clearedRooms}`);
                        testResults.push(`   清除玩家: ${clearResult.clearedPlayers}`);
                    }
                } catch (clearError) {
                    testResults.push(`❌ 資料清除失敗: ${clearError.message}`);
                }
                
                testResults.push('\n=== 完整測試完成 ===');
                updateResult('fullTestResult', testResults.join('\n'), 'success');
                
            } catch (error) {
                testResults.push(`\n❌ 完整測試過程發生錯誤: ${error.message}`);
                updateResult('fullTestResult', testResults.join('\n'), 'error');
            }
        }
    </script>
</body>
</html>