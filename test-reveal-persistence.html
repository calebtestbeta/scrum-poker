<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開牌持久性測試 - Scrum Poker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .reveal-button {
            background: #2196F3;
        }
        
        .reveal-button:hover {
            background: #1976D2;
        }
        
        .clear-button {
            background: #ff9800;
        }
        
        .clear-button:hover {
            background: #f57c00;
        }
        
        .sync-button {
            background: #9c27b0;
        }
        
        .sync-button:hover {
            background: #7b1fa2;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        
        .error {
            color: #f44336;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .warning {
            color: #ff9800;
        }
        
        .log-entry {
            margin: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        #testOutput {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .demo-players {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .demo-player {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: white;
            min-width: 120px;
        }
        
        .demo-player.voted {
            border-color: #4CAF50;
        }
        
        .demo-player.revealed {
            background: #e8f5e8;
            border-color: #2196F3;
        }
        
        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .player-card {
            width: 60px;
            height: 80px;
            background: #333;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 10px auto;
            transition: all 0.3s ease;
        }
        
        .player-card.revealed {
            background: #4CAF50;
        }
        
        .player-status {
            font-size: 12px;
            color: #666;
        }
        
        .test-scenario {
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <h1>🧪 開牌持久性測試</h1>
    
    <div class="test-container">
        <h2>測試控制台</h2>
        <button class="test-button" onclick="initializeTest()">初始化測試</button>
        <button class="test-button" onclick="simulateVoting()">模擬投票</button>
        <button class="test-button reveal-button" onclick="testRevealVotes()">測試開牌</button>
        <button class="test-button sync-button" onclick="simulateFirebaseSync()">模擬 Firebase 同步</button>
        <button class="test-button clear-button" onclick="testClearVotes()">測試清除</button>
        <button class="test-button" onclick="clearResults()">清除結果</button>
        
        <div class="results">
            <h3>測試結果</h3>
            <div id="testOutput"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>開牌持久性場景測試</h2>
        <div class="test-scenario">
            <strong>測試場景</strong>：驗證開牌後 Firebase 同步不會導致卡牌翻回背面
            <br><strong>步驟</strong>：投票 → 開牌 → 模擬 Firebase 同步 → 檢查開牌狀態是否持久
        </div>
        
        <div id="demoPlayers" class="demo-players">
            <!-- 玩家卡牌將在這裡動態生成 -->
        </div>
        
        <div>
            <button class="test-button" onclick="addTestPlayer()">添加測試玩家</button>
            <button class="test-button" onclick="randomVote()">隨機投票</button>
            <button class="test-button reveal-button" onclick="revealAllCards()">開牌</button>
            <button class="test-button sync-button" onclick="simulateFirebaseSyncVisual()">Firebase 同步測試</button>
            <button class="test-button clear-button" onclick="clearAllCards()">清除</button>
        </div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="src/core/Utils.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/services/FirebaseService.js"></script>
    <script src="src/components/Player.js"></script>
    <script src="src/components/Card.js"></script>
    <script src="src/components/PlayerList.js"></script>
    <script src="src/components/GameTable.js"></script>
    
    <script>
        let testPlayerList = null;
        let testPlayers = [];
        let demoPlayerElements = [];
        
        // 測試工具函數
        function log(message, type = 'info') {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            
            let className = '';
            let icon = 'ℹ️';
            
            switch (type) {
                case 'success':
                    className = 'success';
                    icon = '✅';
                    break;
                case 'error':
                    className = 'error';
                    icon = '❌';
                    break;
                case 'warning':
                    className = 'warning';
                    icon = '⚠️';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${className}`;
            logEntry.innerHTML = `[${timestamp}] ${icon} ${message}`;
            
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('testOutput').innerHTML = '';
        }
        
        // 初始化測試
        function initializeTest() {
            log('🧪 開始初始化開牌持久性測試...');
            
            try {
                // 檢查必要的類別是否存在
                if (typeof PlayerList === 'undefined') {
                    log('❌ PlayerList 類別未載入', 'error');
                    return;
                }
                
                if (typeof Player === 'undefined') {
                    log('❌ Player 類別未載入', 'error');
                    return;
                }
                
                // 創建測試 PlayerList
                const testContainer = document.createElement('div');
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);
                
                testPlayerList = new PlayerList(testContainer);
                log('✅ PlayerList 測試實例創建成功', 'success');
                
                // 創建測試玩家
                const testPlayerData = [
                    { id: 'test_player_1', name: 'Alice', role: 'dev', vote: 5 },
                    { id: 'test_player_2', name: 'Bob', role: 'qa', vote: 8 },
                    { id: 'test_player_3', name: 'Charlie', role: 'po', vote: 3 }
                ];
                
                testPlayers = [];
                testPlayerData.forEach(data => {
                    const player = testPlayerList.addPlayer(data.id, data.name, data.role);
                    player.setVote(data.vote, false);
                    testPlayers.push(player);
                    log(`✅ 創建測試玩家: ${data.name} (${data.vote} 點)`, 'success');
                });
                
                log('🎯 測試初始化完成', 'success');
                
            } catch (error) {
                log(`❌ 測試初始化失敗: ${error.message}`, 'error');
                console.error('測試錯誤詳情:', error);
            }
        }
        
        // 模擬投票過程
        function simulateVoting() {
            if (!testPlayerList) {
                log('⚠️ 請先初始化測試', 'warning');
                return;
            }
            
            log('🗳️ 開始模擬投票過程...');
            
            testPlayers.forEach((player, index) => {
                const votes = [1, 2, 3, 5, 8, 13];
                const randomVote = votes[Math.floor(Math.random() * votes.length)];
                
                player.setVote(randomVote, false);
                log(`  ${player.name} 投票: ${randomVote}`);
            });
            
            log('✅ 投票模擬完成', 'success');
        }
        
        // 測試開牌功能
        function testRevealVotes() {
            if (!testPlayerList) {
                log('⚠️ 請先初始化測試', 'warning');
                return;
            }
            
            log('🎭 開始測試開牌功能...');
            
            // 檢查開牌前狀態
            log('📊 開牌前狀態:');
            testPlayers.forEach(player => {
                log(`  - ${player.name}: 投票=${player.vote}, hasVoted=${player.hasVoted}, isRevealed=${player.isRevealed}`);
            });
            
            // 執行開牌
            testPlayerList.revealAllVotes();
            
            // 檢查開牌後狀態
            setTimeout(() => {
                log('🔍 開牌後狀態:');
                let revealedCount = 0;
                testPlayers.forEach(player => {
                    const revealed = player.isRevealed;
                    if (revealed) revealedCount++;
                    log(`  - ${player.name}: 投票=${player.vote}, hasVoted=${player.hasVoted}, isRevealed=${revealed}`, 
                        revealed ? 'success' : 'error');
                });
                
                if (revealedCount === testPlayers.length) {
                    log('✅ 所有玩家都已正確開牌', 'success');
                } else {
                    log(`❌ 開牌失敗 - 只有 ${revealedCount}/${testPlayers.length} 玩家開牌`, 'error');
                }
            }, 100);
        }
        
        // 模擬 Firebase 同步（關鍵測試）
        function simulateFirebaseSync() {
            if (!testPlayerList) {
                log('⚠️ 請先初始化測試', 'warning');
                return;
            }
            
            log('🔄 開始模擬 Firebase 同步...');
            log('這個測試模擬 Firebase updateVotes 事件可能導致的狀態覆蓋問題');
            
            // 檢查同步前狀態
            log('📊 Firebase 同步前狀態:');
            testPlayers.forEach(player => {
                log(`  - ${player.name}: isRevealed=${player.isRevealed}, vote=${player.vote}`);
            });
            
            // 模擬 Firebase updateVotes 調用
            const mockVotes = {};
            testPlayers.forEach(player => {
                mockVotes[player.id] = player.vote;
            });
            
            // 使用 GameTable 的 updateVotes 方法來模擬真實場景
            const mockGameTable = {
                playerList: testPlayerList,
                updateVotes: function(votes) {
                    log('🔄 模擬 GameTable.updateVotes() 調用');
                    
                    Object.entries(votes).forEach(([playerId, voteData]) => {
                        const player = this.playerList.getPlayer(playerId);
                        if (player && voteData) {
                            const wasRevealed = player.isRevealed;
                            log(`  - 同步 ${player.name}: wasRevealed=${wasRevealed}, newVote=${voteData}`);
                            
                            // 關鍵測試：調用 setVote 是否會破壞開牌狀態
                            player.setVote(voteData, false);
                            
                            log(`  - 同步後 ${player.name}: isRevealed=${player.isRevealed}`);
                        }
                    });
                }
            };
            
            mockGameTable.updateVotes(mockVotes);
            
            // 檢查同步後狀態
            setTimeout(() => {
                log('🔍 Firebase 同步後狀態:');
                let persistedCount = 0;
                testPlayers.forEach(player => {
                    const persisted = player.isRevealed;
                    if (persisted) persistedCount++;
                    log(`  - ${player.name}: isRevealed=${persisted}`, 
                        persisted ? 'success' : 'error');
                });
                
                if (persistedCount === testPlayers.length) {
                    log('✅ 開牌狀態成功持久化，沒有翻回背面！', 'success');
                } else {
                    log(`❌ 開牌狀態丟失 - 只有 ${persistedCount}/${testPlayers.length} 玩家保持開牌`, 'error');
                }
            }, 100);
        }
        
        // 測試清除投票
        function testClearVotes() {
            if (!testPlayerList) {
                log('⚠️ 請先初始化測試', 'warning');
                return;
            }
            
            log('🧹 開始測試清除投票功能...');
            
            testPlayerList.clearAllVotes();
            
            setTimeout(() => {
                log('🔍 清除後狀態:');
                let clearedCount = 0;
                testPlayers.forEach(player => {
                    const cleared = !player.hasVoted && !player.isRevealed;
                    if (cleared) clearedCount++;
                    log(`  - ${player.name}: hasVoted=${player.hasVoted}, isRevealed=${player.isRevealed}`, 
                        cleared ? 'success' : 'error');
                });
                
                if (clearedCount === testPlayers.length) {
                    log('✅ 所有玩家投票已正確清除', 'success');
                } else {
                    log(`❌ 清除失敗 - 只有 ${clearedCount}/${testPlayers.length} 玩家清除`, 'error');
                }
            }, 100);
        }
        
        // 視覺化測試函數
        function addTestPlayer() {
            const playerNames = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank'];
            const name = playerNames[demoPlayerElements.length % playerNames.length];
            const role = ['dev', 'qa', 'po', 'scrum_master'][Math.floor(Math.random() * 4)];
            
            const playerElement = document.createElement('div');
            playerElement.className = 'demo-player';
            playerElement.innerHTML = `
                <div class="player-name">${name}</div>
                <div class="player-card">?</div>
                <div class="player-status">未投票</div>
            `;
            
            document.getElementById('demoPlayers').appendChild(playerElement);
            demoPlayerElements.push({
                element: playerElement,
                name: name,
                role: role,
                vote: null,
                voted: false,
                revealed: false
            });
            
            log(`➕ 添加視覺化玩家: ${name}`);
        }
        
        function randomVote() {
            const votes = [0, 1, 2, 3, 5, 8, 13, 21];
            
            demoPlayerElements.forEach(player => {
                if (!player.voted) {
                    const vote = votes[Math.floor(Math.random() * votes.length)];
                    player.vote = vote;
                    player.voted = true;
                    
                    player.element.classList.add('voted');
                    player.element.querySelector('.player-status').textContent = '已投票';
                    
                    log(`🗳️ ${player.name} 投票: ${vote}`);
                }
            });
        }
        
        function revealAllCards() {
            log('🎭 視覺化開牌...');
            
            demoPlayerElements.forEach(player => {
                if (player.voted && !player.revealed) {
                    player.revealed = true;
                    
                    const card = player.element.querySelector('.player-card');
                    card.classList.add('revealed');
                    card.textContent = player.vote;
                    
                    player.element.classList.add('revealed');
                    player.element.querySelector('.player-status').textContent = '已開牌';
                    
                    log(`🎭 ${player.name} 開牌: ${player.vote}`, 'success');
                }
            });
        }
        
        function simulateFirebaseSyncVisual() {
            log('🔄 視覺化 Firebase 同步測試...');
            
            // 模擬 Firebase 同步可能導致的狀態變化
            demoPlayerElements.forEach((player, index) => {
                if (player.revealed) {
                    log(`🔄 同步玩家 ${player.name} 的數據...`);
                    
                    // 模擬問題場景：同步後卡牌可能翻回背面
                    const card = player.element.querySelector('.player-card');
                    
                    // 短暫顯示同步過程
                    setTimeout(() => {
                        card.style.transform = 'rotateY(180deg)';
                        card.textContent = '同步中...';
                        
                        setTimeout(() => {
                            // 測試修復後的行為：卡牌應該保持開牌狀態
                            card.style.transform = '';
                            card.textContent = player.vote; // 保持顯示投票值
                            
                            if (card.textContent === player.vote.toString()) {
                                log(`✅ ${player.name} 同步後保持開牌狀態`,  'success');
                            } else {
                                log(`❌ ${player.name} 同步後翻回背面`, 'error');
                            }
                        }, 500);
                    }, index * 200); // 錯開動畫時間
                }
            });
        }
        
        function clearAllCards() {
            log('🧹 視覺化清除...');
            
            demoPlayerElements.forEach(player => {
                player.vote = null;
                player.voted = false;
                player.revealed = false;
                
                const card = player.element.querySelector('.player-card');
                card.classList.remove('revealed');
                card.textContent = '?';
                
                player.element.classList.remove('voted', 'revealed');
                player.element.querySelector('.player-status').textContent = '未投票';
            });
        }
        
        // 頁面載入時自動執行基本檢查
        window.addEventListener('load', () => {
            log('🚀 開牌持久性測試頁面已載入');
            log('💡 請點擊"初始化測試"開始測試開牌持久性功能');
            log('🎯 核心測試：驗證開牌後 Firebase 同步不會導致卡牌翻回背面');
            
            // 添加一些示例玩家
            for (let i = 0; i < 3; i++) {
                addTestPlayer();
            }
        });
    </script>
</body>
</html>